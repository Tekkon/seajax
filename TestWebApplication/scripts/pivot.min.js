function SDBrowser_parseUserAgent(e){var t=null,i=null,n=null,o=null,r=/MSIE ([^\s;)]+)/.exec(e),a=/Firefox\/(\S+)/.exec(e),s=/Safari\/(\S+)/.exec(e),l=/Chrome\/(\S+)/.exec(e),c=/Version\/(\S+)/.exec(e),u=/; Trident\/([^\s;)]+)/.exec(e),h=/rv\:([^\s)]+)\) Gecko\//.exec(e),d=/WebKit\/(\S+)/.exec(e);return r?(t=SDBrowser_IE,i=r[1],n=SDBrowser_TRIDENT,u&&(o=u[1])):h?(n=SDBrowser_GECKO,o=h[1],a&&(t=SDBrowser_FF,i=a[1])):d&&(n=SDBrowser_WEBKIT,o=d[1],l?(t=SDBrowser_CHROME,i=l[1]):s&&c&&(t=SDBrowser_SAFARI,i=c[1],o=s[1])),{name:t,version:i,engine:n,engineVersion:o}}function SDPage_getScroll(){var e=new SDPoint,t=document.documentElement||{},i=document.body||{};return"number"==typeof window.pageXOffset?(e.x=pageXOffset,e.y=pageYOffset):i.scrollLeft||i.scrollTop?(e.x=i.scrollLeft,e.y=i.scrollTop):(t.scrollLeft||t.scrollTop)&&(e.x=t.scrollLeft,e.y=t.scrollTop),e}function SDTileCache(e){this.capacity=e>1?e:2,this.oldest=null,this.newest=null}function SDNetwork_generateTryMakeRequestMethod(e,t){return function(i,n,o){var r,a=e[i];return a?("function"==typeof n&&a.seadragon.callbacks.push(n),!0):(r=SDUri_getHostname(i),!(!SDNetwork_numSpotsAvailable(r)&&!o)&&(!!(a=t(i))&&(SDNetwork_markSpotTaken(r),e[i]=a,a.seadragon={url:i,hostname:r,callbacks:"function"==typeof n?[n]:[]},!0)))}}function SDNetwork_tryCallAll(e,t,i,n){var o,r=e.length;for(o=0;o<r;o++)try{e[o](t,i,n)}catch(a){SDDebug_warn("Seadragon2.Network callback {0} for {1} threw an error:\n{2}",o,t,a)}}function SDNetwork_generateResponseHandler(e,t){function i(){var i=this.seadragon,n=i.url;SDNetwork_markSpotOpen(i.hostname),delete e[n];try{delete this.seadragon}catch(o){this.seadragon=null}SDNetwork_tryCallAll(i.callbacks,n,t,this)}return window.ActiveXObject?SDFunction_delay(i,0):i}function Tile(e,t,i,n,o){var r=SDTileInfo_$(n.getTileInfo(e,t,i));this.level=e,this.col=t,this.row=i,this.tileBelow=o,this.url=r.url,this.crop=r.crop,this.bounds=n.getTileBounds(e,t,i),this.drawnOpaque=!1,this.tilesAbove=n.getNumTilesAbove(e,t,i),this.covered=0,this.loading=!1,this.area=0,this.distance=0,this.opacity=1,this.inBounds=!0,this.view=null}function Level(e,t){this.bounds=SDRect_nullRect,this.tiles={},this.num=e,this.visible=!1,this.fading=!1,this.tilesVisible=0,this.opacity=1,this.dimensions=t.getLevelDimensions(e),this.view=null}function SDTileLoader_compareNominatedUrls(e,t){var i,n=SDTileLoader_nominations[e],o=SDTileLoader_nominations[t],r=o.area-n.area;return r?r:(i=n.distance-o.distance,i?i:n.level-o.level)}function SDTileLoader_imgCallback(e,t,i){var n,o,r,a,s,l,c=SDTileLoader_imgInfos[e];c||SDDebug_error("Seadragon2.TileLoader: [internal] no img info for "+e),l=SDTileLoader_cache.insert(c),l&&delete SDTileLoader_imgInfos[l.url],c.loading=!1,c.loaded=t,c.failed=!t,c.img=i,n=c.tiles,o=c.callbacks,r=c.args;try{delete c.tiles,delete c.callbacks,delete c.args}catch(u){c.tiles=null,c.callbacks=null,c.args=null}for(s=n.length,a=0;a<s;a++)n[a]&&o[a](r[a],n[a],c);SDTileLoader_triggerProcessing()}function SDTileLoader_processNominations(){var e,t,i,n,o=[],r=SDNetwork_numSpotsAvailable();SDTileLoader_trigger=!1;for(i in SDTileLoader_nominations)SDTileLoader_nominations.hasOwnProperty(i)&&SDTileLoader_nominations[i]&&o.push(i);for(o.sort(SDTileLoader_compareNominatedUrls),t=o.length,e=0;e<t&&r>0;e++)if(i=o[e],SDNetwork_tryMakeImageRequest(i,SDTileLoader_imgCallback)){r--,n=SDTileLoader_nominations[i],SDTileLoader_imgInfos[i]={loading:!0,loaded:!1,failed:!1,img:null,tiles:n.tiles,callbacks:n.callbacks,args:n.args,url:i};try{delete SDTileLoader_nominations[i]}catch(a){SDTileLoader_nominations[i]=null}}}function SDTileLoader_nominate(e,t,i){var n=e.url,o=SDTileLoader_imgInfos[n];return o?void(o.tiles?(o.tiles.push(e),o.callbacks.push(t),o.args.push(i),o.nominators++):SDDebug_warn("Nomination dropped: "+n)):(o=SDTileLoader_nominations[n],o?(o.tiles.push(e),o.callbacks.push(t),o.args.push(i),o.area+=e.area,o.distance=SDMath_min(o.distance,e.distance),o.nominators++):SDTileLoader_nominations[n]={tiles:[e],callbacks:[t],args:[i],nominators:1,area:e.area,distance:e.distance,level:e.level},SDTileLoader_triggerProcessing(),SDTileLoader_nominations[n].tiles.length-1)}function SDTileLoader_getImgInfo(e){var t=SDTileLoader_imgInfos[e];return t&&!t.loading&&SDTileLoader_cache.refresh(t),t||SDTileLoader_nullImgInfo}function SDImageManager_checkForInit(){var e,t,i,n,o,r=document.getElementsByTagName("sdimg"),a=r.length;for(e=0;e<a;e++)if(t=r[e],!t.update){for(n=t.nextSibling,o=t.parentNode;t.hasChildNodes();)i=t.firstChild,t.removeChild(i),"sdimgcontainerdiv"!==i.className&&(n?o.insertBefore(i,n):o.appendChild(i));new SDImage(null,r[e])}return!0}function SDImageState_blendCallback(e,t){var i,n=e.levelData,o=e.tile,r=e.startTime,a=e.state,s=e.last||r;return!(!n.visible||!o.inBounds||o.isCovered()||n.fading||o.drawnOpaque)&&(i=(t-r)/a.blendInTime,(i>1||t-s>67)&&(i=1),a.drawer.updateBlend(o,n.view,i),o.opacity=i,1===i?(n.fading||a.onDrawn(o),!1):(e.last=t,!0))}function SDImageState_fadeCallback(e,t){var i,n=e.state,o=e.levelData,r=e.level,a=n.levels,s=e.startTime,l=e.last||s;return a[r]===o&&(i=1-(t-s)/n.fadeOutTime,t-l>67&&(i=0),i<=0?(o.visible&&n.drawer.removeLevel(o.view),delete a[r],!1):(o.visible&&(o.opacity=i,n.drawer.updateFade(o.view,i)),e.last=t,!0))}function SDImageState_onTileLoad(e,t,i){var n=e.levelData,o=n.bounds,r=e.state;t.loading=!1,!i.failed&&o&&t.inBounds&&n.visible&&!n.fading&&(t.isCovered()||r.blendTile(i.img,t))}function SDImage_onSrcClear(e){e.state&&e.state.destroy(),e.state=null}function SDImage_onTileSourceLoad(e,t,i){e.immediateMode&&e.parentNode?e.immediateMode=!1:e.skippedParentCheck=SDMath_floor(30*Math.random());var n=e.immediateMode?SDDrawer_nullDrawer:SDDrawer_$(e.container,t.normHeight);e.state=new SDImageState(t,n,e.blendTime,e.fadeTime),SDEvent_raise(e,"load",!1)}function SDImage_fetchSrc(e,t){SDDeepZoom_fetchTileSource(t,function(i){i instanceof SDTileSource?SDImage_onTileSourceLoad(e,i):SDDebug_warn("SDImage: failed to fetch tile source at "+t)})}function SDImage_onSrcSet(e){var t=e.src,i=typeof t;"string"===i?SDImage_fetchSrc(e,t):"object"===i?SDImage_onTileSourceLoad(e,SDTileSource_$(t)):SDDebug_error("Unsupported src type: "+i)}function SDImage_onSrcChange(e){SDImage_onSrcClear(e),SDImage_onSrcSet(e)}function SDImage_onTickSrcEmpty(e){}function SDImage_onTickSrcSet(e,t,i){if(e.state){e.immediateMode&&(e.skippedParentCheck>30?(e.parentNode&&(e.immediateMode=!1,SDImage_onTileSourceLoad(e,e.state.source)),e.skippedParentCheck=0):e.skippedParentCheck++);var n,o,r=e.container,a=t||SDElement_getBoundingClientRect(r),s=a.width,l=a.height;t||i?o=i:(n=SDElement_getWindowDimensions(),e.clipParent&&(n=n.intersect(SDElement_getBoundingClientRect(e.clipParent)),n||(n=new SDRect(0,0,0,0))),o=SDElement_getClippingBounds(r,a,n)),s&&l&&(t||(a.x-=n.width/2,a.y-=n.height/2),e.state.update(a,o,e.blur-SDImage_pixelRatio))}}function SDImage_onTick(e,t,i,n){var o=e.lastSrc,r=e.src;return!o&&r?SDImage_onSrcSet(e):o&&!r?SDImage_onSrcClear(e):r!==o?SDImage_onSrcChange(e):r?r?SDImage_onTickSrcSet(e,i,n):SDDebug_warn("SDImage_onTick: unknown state! src={0}, lastSrc={1}",r,o):SDImage_onTickSrcEmpty(e),e.lastSrc=r,!0}function PivotNumber_format(e){if(!e)return"0";for(var t=Math.floor(Math.log(Math.abs(e))/Math.LN10),i=e/Math.pow(10,t),n=0;n<10&&Math.abs(i)>PivotNumber_epsilon;)n++,i=10*(i-Math.round(i));return t>=n&&t<n+5?e.toFixed(0):e.toPrecision(n)}function PivotNumberPicker(e,t,i,n){function o(e){return Seadragon2.Math.round(e,void 0,u)}function r(){D.innerHTML=z===-(1/0)?O===1/0?"":"Under "+PivotNumber_format(O):O===1/0?"Over "+PivotNumber_format(z):z===O?"Exactly "+PivotNumber_format(z):PivotNumber_format(z)+" &ndash; "+PivotNumber_format(O)}function a(e){var t,i=Math.floor(R/T*p),n=e+"px",a=Math.floor(e/T*p);for(R=e,m.style.left=n,d.style.left=n,z=e?o(I+(C-I)*e/T):-(1/0),r(),t=i;t>a;t--)w.childNodes[t-1].className="pivot_filtergraphbar";for(t=i;t<a;t++)w.childNodes[t].className="pivot_filtergraphbar pivot_deselected"}function s(e){var t,i=Math.floor(B/T*p),n=e+"px",a=Math.floor(e/T*p);for(B=e,f.style.right=n,d.style.right=n,O=e?o(C-(C-I)*e/T):1/0,r(),t=i;t>a;t--)w.childNodes[p-t].className="pivot_filtergraphbar";for(t=i;t<a;t++)w.childNodes[p-t-1].className="pivot_filtergraphbar pivot_deselected"}function l(){var e=document.documentElement;e.className=e.className.replace(L,""),z===-(1/0)&&O===1/0?N.trigger("unfilter",i):N.trigger("filter",i,z,O,!0)}function c(e){return e=" "+e,function(t,i,n){k=n.x,L=e,document.documentElement.className+=e}}var u,h,d,m,f,p,g,v,S,D,w,y,_,b,T,x,k,E,M,P,L,I=1/0,C=-(1/0),N=this,R=0,B=0,z=-(1/0),O=1/0;if(D=makeElement("div","pivot_numberlabel",e),Seadragon2.EventManager.call(N),t.forEach(function(e){var t,n=e.facets[i];n&&(t=n[0],t<I&&(I=t),t>C&&(C=t))}),p=11,g=(C-I)/p,v=[],0===g&&(g=0,p=1),g<0)return D.innerHTML="Not Currently Applicable",N;for(x=0;x<p;x++)v.push(0);return t.forEach(function(e){var t,n=e.facets[i];n&&(t=g?Math.floor((n[0]-I)/g):0,t>p-1&&(t=p-1),v[t]++)}),S=v.reduce(function(e,t){return e>t?e:t},1),w=makeElement("div","pivot_filtergraph",e),v.forEach(function(e,t){var i=makeElement("div","pivot_filtergraphbar",w);i.style.width=100/p*.7+"%",i.style.left=100/p*(t+.15)+"%",i.style.height=100*e/S+"%"}),y=makeElement("div","pivot_sliderouter",e),d=makeElement("div","pivot_slider",y),m=makeElement("div","pivot_sliderhandle pivot_sliderleft",y),f=makeElement("div","pivot_sliderhandle pivot_sliderright",y),_=makeElement("div","pivot_left",e),b=makeElement("div","pivot_right",e),g?(T=parseFloat(Seadragon2.Element.getStyle(d).width)-1,h=Math.floor(Math.log((C-I)/T)/Math.LN10),u=Math.pow(10,h),C=Math.ceil(C/u)*u,I=Math.floor(I/u)*u,_.innerHTML=PivotNumber_format(o(I)),b.innerHTML=PivotNumber_format(o(C)),n&&(n=n[0],z=n.lowerBound,O=n.upperBound,void 0===z?(D.innerHTML="(no info)",z=-(1/0),O=1/0):(z>I&&(a(Math.min(Math.round((z-I)/(C-I)*T),T)),z=n.lowerBound),O<C&&(s(Math.min(Math.round((C-O)/(C-I)*T),T-R)),O=n.upperBound),r())),E=new Seadragon2.MouseTracker(d),M=new Seadragon2.MouseTracker(m),P=new Seadragon2.MouseTracker(f),E.addListener("release",l),M.addListener("release",l),P.addListener("release",l),M.addListener("press",c("pivot_wresize")),P.addListener("press",c("pivot_eresize")),E.addListener("press",c("pivot_pointer")),M.addListener("drag",function(e,t,i){var n=Math.min(Math.max(R+i.x-k,0),T-B);n!==R&&a(n)}),P.addListener("drag",function(e,t,i){var n=Math.min(Math.max(B-i.x+k,0),T-R);n!==B&&s(n)}),E.addListener("drag",function(e,t,i){var n,o,r=i.x-k>0;r?(n=Math.max(B-i.x+k,0),n!==B&&(o=R-n+B,s(n),a(o))):(o=Math.max(R+i.x-k,0),o!==R&&(n=B-o+R,a(o),s(n)))}),E.setTracking(!0),M.setTracking(!0),void P.setTracking(!0)):(_.innerHTML=I.toPrecision(4),b.innerHTML=C.toPrecision(4),N)}function PivotSlider(e,t,i,n,o,r){var a,s,l,c,u,h,d,m,f,p,g,v,S=this,D=(i-t)/16;Seadragon2.EventManager.call(S),t<i||(t=0,i=1),"number"!=typeof n&&(n=t+(i-t)/2),a=makeElement("div","pivot_zoomout pivot_hoverable",e),a.innerHTML="&minus;",a.title=o,u=makeElement("div","pivot_zoomline",e),h=makeElement("div","pivot_zoomhandle",u),g=u.offsetWidth,v=h.offsetWidth,d=(i-t)/(g-v),s=makeElement("div","pivot_zoomin pivot_hoverable",e),addText(s,"+"),s.title=r,a.onclick=function(){l||S.setValue(n-D,!0)},s.onclick=function(){c||S.setValue(n+D,!0)},m=new Seadragon2.MouseTracker(h),m.addListener("press",function(e,t,i){f=i.x,document.documentElement.className+=" pivot_eresize"}),m.addListener("release",function(){var e=document.documentElement;f=void 0,e.className=e.className.replace(" pivot_eresize","")}),m.addListener("drag",function(e,i,n){S.setValue((p+n.x-f)*d+t,!0)}),m.setTracking(!0),e.onclick=function(i){var n=i.target;if(n===e||n===u){var o=Seadragon2.Mouse.getPosition(i).minus(Seadragon2.Element.getPosition(u)).x;o>=0&&o<g&&S.setValue((o-v/2)*d+t,!0)}},S.setValue=function(e,u){if(void 0===f||u){var m=n;n=e,n<=t?(n=t,l||(l=!0,a.title="",a.className="pivot_zoomout pivot_hoverable pivot_disabled")):l&&(l=!1,a.title=o,a.className="pivot_zoomout pivot_hoverable"),n>=i?(n=i,c||(c=!0,s.title="",s.className="pivot_zoomin pivot_hoverable pivot_disabled")):c&&(c=!1,s.title=r,s.className="pivot_zoomin pivot_hoverable"),p=Math.round((n-t)/d),h.style.left=p+"px",u&&m!==n&&S.trigger("change",n)}},S.setValue(n)}function lzwEncode(e){function t(e){for(1<<c<=s&&c++,h=h<<c|e,d+=c;d>=6;)d-=6,m.push(u[h>>d&63])}e=unescape(encodeURIComponent(e));var i,n,o,r={},a=e[0],s=255,l=e.length,c=8,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",h=0,d=0,m=[],f=65535;for(n=0;n<256;n++)r[String.fromCharCode(n)]=n;for(n=1;n<l;n++)i=e[n],o=a+i,hasOwnProperty.call(r,o)?a=o:(t(r[a]),s<f&&(s++,r[o]=s),a=i);for(t(r[a]),d&&m.push(u[h<<6-d&63]);m.length%4;)m.push("A");return m.join("")}"undefined"==typeof Seadragon2&&(window.Seadragon2={});var SD=Seadragon2,SD_VERSION=SD.VERSION="2.0.pre";SD.toString=function(){return"Seadragon Ajax v"+SD_VERSION+"\nCopyright (c) Microsoft Corp."};var SDPoint=SD.Point=function(e,t){this.x=e||0,this.y=t||0},SDPoint_$=SDPoint.$=function(e){return e instanceof SDPoint?e:(e=e||{},new SDPoint(e.x,e.y))},SDPointPrototype=SDPoint.prototype,SDPoint_origin=new SDPoint(0,0);SDPointPrototype.plus=function(e){return new SDPoint(this.x+e.x,this.y+e.y)},SDPointPrototype.minus=function(e){return new SDPoint(this.x-e.x,this.y-e.y)},SDPointPrototype.times=function(e){return new SDPoint(this.x*e,this.y*e)},SDPointPrototype.divide=function(e){return new SDPoint(this.x/e,this.y/e)},SDPointPrototype.negate=function(){return new SDPoint((-this.x),(-this.y))},SDPointPrototype.apply=function(e){return new SDPoint(e(this.x),e(this.y))},SDPointPrototype.distanceTo=function(e){var t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)},SDPointPrototype.asSize=function(){return new SDSize(this.x,this.y)},SDPointPrototype.equals=function(e){return this.x===(e.x||0)&&this.y===(e.y||0)},SDPointPrototype.toString=function(){return["(",this.x,",",this.y,")"].join("")};var SDSize=SD.Size=function(e,t){this.width=e||0,this.height=t||0},SDSize_$=SDSize.$=function(e){return e instanceof SDSize?e:(e=e||{},new SDSize(e.width,e.height))},SDSizePrototype=SDSize.prototype;SDSizePrototype.plus=function(e){return new SDSize(this.width+e.width,this.height+e.height)},SDSizePrototype.minus=function(e){return new SDSize(this.width-e.width,this.height-e.height)},SDSizePrototype.times=function(e){return new SDSize(this.width*e,this.height*e)},SDSizePrototype.divide=function(e){return new SDSize(this.width/e,this.height/e)},SDSizePrototype.negate=function(){return new SDSize((-this.width),(-this.height))},SDSizePrototype.apply=function(e){return new SDSize(e(this.width),e(this.height))},SDSizePrototype.asPoint=function(){return new SDPoint(this.width,this.height)},SDSizePrototype.equals=function(e){return this.width===(e.width||0)&&this.height===(e.height||0)},SDSizePrototype.toString=function(){return["(",this.width,"x",this.height,")"].join("")};var SDRect=SD.Rect=function(e,t,i,n){e&&void 0===i&&void 0!==e.x&&(i=t.width,n=t.height,t=e.y,e=e.x),this.x=e||0,this.y=t||0,this.width=i||0,this.height=n||0},SDRect_$=SDRect.$=function(e){return e instanceof SDRect?e:new SDRect(e.x,e.y,e.width,e.height)},SDRectPrototype=SDRect.prototype,SDRect_unitRect=new SDRect(0,0,1,1),SDRect_nullRect=new SDRect((-1),(-1),(-1),(-1));SDRectPrototype.getArea=function(){return this.width*this.height},SDRectPrototype.getAspectRatio=function(){return this.width/this.height},SDRectPrototype.getNormHeight=function(){return this.height/this.width},SDRectPrototype.getTopLeft=function(){return new SDPoint(this.x,this.y)},SDRectPrototype.getBottomRight=function(){return new SDPoint(this.x+this.width,this.y+this.height)},SDRectPrototype.getCenter=function(){return new SDPoint(this.x+this.width/2,this.y+this.height/2)},SDRectPrototype.getSize=function(){return new SDSize(this.width,this.height)},SDRectPrototype.contains=function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+(e.width||0),o=e.y+(e.height||0);return this.x<=e.x&&this.y<=e.y&&t>=n&&i>=o},SDRectPrototype.union=function(e){var t=Math.min(this.x,e.x),i=Math.min(this.y,e.y),n=Math.max(this.x+this.width,e.x+(e.width||0)),o=Math.max(this.y+this.height,e.y+(e.height||0));return new SDRect(t,i,n-t,o-i)},SDRectPrototype.intersect=function(e){var t=Math.max(this.x,e.x),i=Math.max(this.y,e.y),n=-t+Math.min(this.x+this.width,e.x+(e.width||0)),o=-i+Math.min(this.y+this.height,e.y+(e.height||0));return n||o||e instanceof SDRect?n<0||o<0?null:new SDRect(t,i,n,o):new SDPoint(t,i)},SDRectPrototype.scale=function(e,t){var i=t?t.x:this.x,n=t?t.y:this.y;return new SDRect(i-e*(i-this.x),n-e*(n-this.y),this.width*e,this.height*e)},SDRectPrototype.translate=function(e){return new SDRect(this.x+(e.x||0),this.y+(e.y||0),this.width,this.height)},SDRectPrototype.equals=function(e){return this.x===(e.x||0)&&this.y===(e.y||0)&&this.width===(e.width||0)&&this.height===(e.height||0)},SDRectPrototype.toString=function(){return["[",this.x,",",this.y,"|",this.width,"x",this.height,"]"].join("")};var SDString=SD.String={},SDString_format=SDString.format=function(e,t){var i,n;if(2===arguments.length&&t&&t.constructor&&(t.constructor===Array||t.constructor===Object))i=t;else for(i=new Array(arguments.length-1),n=0;n<i.length;n++)i[n]=arguments[n+1];return e.replace(/\{[\d\w]+\}/g,function(e){var t=e.match(/[\d\w]+/);return i[t]||""})},SDDebug=SD.Debug={alert:0,enabled:3},SDDebug_log=SDDebug.log=function(e,t){SDDebug.enabled<3||(arguments.length>1&&(e=SDString_format.apply(this,arguments)),"undefined"!=typeof console&&console.log?console.log(e):SDDebug.alert>=3&&alert(e))},SDDebug_warn=SDDebug.warn=function(e){SDDebug.enabled<2||(arguments.length>1&&(e=SDString_format.apply(this,arguments)),"undefined"!=typeof console&&console.warn?console.warn(e):SDDebug.alert>=2&&alert(e))},SDDebug_error=SDDebug.error=function(e,t){if(!(SDDebug.enabled<1))throw"undefined"!=typeof console&&console.error?console.error(e):SDDebug.alert>=1&&alert(e),t||new Error(e)},SDObject=SD.Object={},SDObject_extend=SDObject.extend=function(e,t,i){for(var n in t)(i||t.hasOwnProperty(n))&&(e[n]=t[n]);return e},SDObject_clone=SDObject.clone=function(e,t){return SDObject_extend({},e,t)},SDFunction=SD.Function={},SDFunction_EMPTY=SDFunction.EMPTY=function(){},SDFunction_bind=SDFunction.bind=function(e,t,i){var n,o=new Array(arguments.length-2),r=o.length;for(n=0;n<r;n++)o[n]=arguments[n+2];return"string"==typeof t&&(t=e[t]),function(){var i,n=arguments.length;for(i=0;i<n;i++)o.push(arguments[i]);t.apply(e,o)}},SDFunction_callback=SDFunction.callback=function(e,t){var i,n=arguments.length,o=new Array(n+1);for(o[0]=null,i=0;i<n;i++)o[i+1]=arguments[i];return SDFunction_bind.apply(SDFunction,o)},SDFunction_delay=SDFunction.delay=function(e,t){return function(){setTimeout(SDFunction_bind(this,e),t)}},SDBrowser=SD.Browser={},SDBrowser_TRIDENT=SDBrowser.TRIDENT="Trident",SDBrowser_GECKO=SDBrowser.GECKO="Gecko",SDBrowser_WEBKIT=SDBrowser.WEBKIT="Webkit",SDBrowser_PRESTO=SDBrowser.PRESTO="Presto",SDBrowser_IE=SDBrowser.IE="IE",SDBrowser_FF=SDBrowser.FIREFOX="Firefox",SDBrowser_SAFARI=SDBrowser.SAFARI="Safari",SDBrowser_CHROME=SDBrowser.CHROME="Chrome",SDBrowser_OPERA=SDBrowser.OPERA="Opera",SDBrowser_isIE,SDBrowser_isFF,SDBrowser_isSafari,SDBrowser_isChrome,SDBrowser_isGecko,SDBrowser_isWebkit,SDBrowser_isOpera;!function(){var e=SDBrowser_parseUserAgent(navigator.userAgent),t=e.name,i=e.version,n=parseInt(i),o=(parseFloat(i),e.engine),r=e.engineVersion;parseFloat(r);SDBrowser.name=t,SDBrowser.version=i,SDBrowser.engine=o,SDBrowser.engineVersion=r,e.name===SDBrowser_IE?SDBrowser_isIE=n:e.name===SDBrowser_FF?SDBrowser_isFF=n:e.name===SDBrowser_SAFARI?SDBrowser_isSafari=n:e.name===SDBrowser_CHROME&&(SDBrowser_isChrome=n)}();var SDMath=SD.Math={},SDMath_max=Math.max,SDMath_min=Math.min,SDMath_clamp=SDMath.clamp=function(e,t,i){return SDMath_max(t,SDMath_min(i,e))},SDMath_ln=Math.log,SDMath_LN2=Math.LN2,SDMath_LN10=Math.LN10,SDMath_exp=Math.exp,SDMath_log=SDMath.log=function(e,t){return t?SDMath_ln(e)/SDMath_ln(t):SDMath_ln(e)},SDMath_log2=SDMath.log2=function(e){return SDMath_ln(e)/SDMath_LN2},SDMath_log10=SDMath.log10=function(e){return SDMath_ln(e)/SDMath_LN10},SDMath_morton=SDMath.morton=function(e){var t,i,n,o,r,a=arguments[0];for("object"==typeof a?(t=a.x,i=a.y):(t=a,i=arguments[1]),n=0,o=0,r=1;r<=t||r<=i;)r&t&&(n|=1<<2*o+1),r&i&&(n|=1<<2*o),o++,r=1<<o;return n},SDMath_reverseMorton=SDMath.reverseMorton=function(e){for(var t,i=[],n=[],o=0,r=0;e>0;)n.push(e%2),e>>=1,i.push(e%2),e>>=1;for(t=0;t<i.length;t++)o+=(1<<t)*i[t];for(t=0;t<n.length;t++)r+=(1<<t)*n[t];return new SDPoint(o,r)},SDMath_ceil=Math.ceil,SDMath_floor=Math.floor,SDMath_round=SDMath.round=function(e,t,i){return"undefined"==typeof i&&(i=1),"undefined"==typeof t&&(t=.5),e/=i,(e%1+1)%1<t?SDMath_floor(e)*i:SDMath_ceil(e)*i},SDUri=SD.Uri={},SDUri_FILE_HOSTNAME=SDUri.FILE_HOSTNAME="localhost",SDUri_PAGE_HOSTNAME=location.hostname||SDUri_FILE_HOSTNAME,SDUri_getHostname=SDUri.getHostname=function(e){var t,i=/^http[s]?:\/\/([\w-.]+)/i.exec(e);return i?i[1].toLowerCase():(t=/^file:\/\//i.exec(e))?SDUri_FILE_HOSTNAME:SDUri_PAGE_HOSTNAME},SDXml=SD.Xml={},SDXml_fetch=SDXml.fetch=function(){function e(e,t){return function(){4===this.readyState&&(0===this.status||this.status>=200&&this.status<300?e.call(this):t.call(this))}}var t,i,n,o,r=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml3.XMLHTTP"],a="undefined"!=typeof XDomainRequest;if("undefined"!=typeof XMLHttpRequest)n=XMLHttpRequest;else if("undefined"!=typeof ActiveXObject){for(i=0;i<r.length;i++){t=r[i];try{new ActiveXObject(t),n=ActiveXObject,o=t;break}catch(s){SDDebug_warn("Seadragon2.Xml: {0} ActiveX failed.",t)}}i>=r.length&&SDDebug_error("Seadragon2.Xml: no ActiveX worked.")}else SDDebug_error("Seadragon2.Xml: no fetching ability.");return n?function(t,i,r,s,l){var c=new n(o),u=s?"POST":"GET",h=!1;c.onreadystatechange=e(i,r),t=t.replace(/#.*/,"");try{c.open(u,t,!0)}catch(d){if(!a)throw d;c=new XDomainRequest,c.onload=i,c.onerror=r,c.timeout=3e4,c.ontimeout=function(){},c.onprogress=function(){},c.open(u,t),h=!0}return s&&c.setRequestHeader&&c.setRequestHeader("Content-Type",l||"text/plain"),h?setTimeout(function(){c.send(s||null)},0):c.send(s||null),c}:SDFunction_EMPTY}(),SDXml_parse=SDXml.parse=function(){return"undefined"!=typeof DOMParser?function(e){var t=new DOMParser,i=t.parseFromString(e,"text/xml"),n=i&&i.documentElement;return n&&"parsererror"!==n.nodeName?i:null}:"undefined"!=typeof ActiveXObject?function(e){var t=new ActiveXObject("Microsoft.XMLDOM");return t.async=!1,t.loadXML(e)&&t}:(SDDebug_error("Seadragon2.Xml: no parsing ability."),SDFunction_EMPTY)}(),SDElement=SD.Element={},SDElement_$=SDElement.$=function(e){return"string"==typeof e?document.getElementById(e):e},SDElement_getWindowDimensions=SDElement.getWindowDimensions=function(){return(SDElement_getWindowDimensions="undefined"!=typeof innerWidth?SDElement.getWindowDimensions=function(){return new SDRect(0,0,innerWidth,innerHeight)}:document.documentElement&&document.documentElement.clientHeight?SDElement.getWindowDimensions=function(){var e=document.documentElement;return new SDRect(0,0,e.clientWidth,e.clientHeight)}:document.body.clientHeight?SDElement.getWindowDimensions=function(){var e=document.body;return new SDRect(0,0,e.clientWidth,e.clientHeight)}:SDElement.getWindowDimensions=function(){return new SDRect(0,0,1/0,1/0)})()},SDElement_getBoundingClientRect=SDElement.getBoundingClientRect=function(e){var t=e.getBoundingClientRect();return new SDRect(t.left,t.top,t.right-t.left,t.bottom-t.top)},SDElement_getStyle=SDElement.getStyle=function(e){return window.getComputedStyle?getComputedStyle(e,null):e.currentStyle?e.currentStyle:void SDDebug_error("Unknown element style, no known technique.")},SDElement_getOffsetParent=SDElement.getOffsetParent=function(e,t){return t&&e!==document.body?document.body:e.offsetParent},SDElement_getPosition=SDElement.getPosition=function(e){for(var t=new SDPoint,i="fixed"===SDElement_getStyle(e).position,n=SDElement_getOffsetParent(e,i);n;)t.x+=e.offsetLeft,t.y+=e.offsetTop,i&&(t=t.plus(SDPage_getScroll())),e=n,i="fixed"===SDElement_getStyle(e).position,n=SDElement_getOffsetParent(e,i);return t},SDElement_getClippingBounds=SDElement.getClippingBounds=function(e,t,i){t=t||SDElement_getBoundingClientRect(e),i=i||SDElement_getWindowDimensions();var n,o,r,a,s=t.y,l=t.width+t.x,c=t.height+t.y,u=t.x,h=i.x,d=i.y,m=h+i.width,f=d+i.height;return n=SDMath_max(0,d-s),o=SDMath_max(0,h-u),r=SDMath_min(l,m)-u-o,a=SDMath_min(c,f)-s-n,new SDRect(o,n,r,a)},SDElement_setOpacity=SDElement.setOpacity=function(){var e=document.createElement("div");return"undefined"!=typeof e.style.opacity?function(e,t){e.style.opacity=t}:"undefined"!=typeof e.style.filter?function(e,t){var i,n,o,r="progid:DXImageTransform.Microsoft.Alpha(Opacity="+100*t+")";for(e.style.filter=r,i=e.children,o=i.length,n=0;n<o;n++)try{SDElement_setOpacity(i[n],t)}catch(a){}}:function(){}}(),SDElement_customElements={},SDElement_dce=document.createElement,SDElement_registerCustomElement=function(e,t){SDElement_customElements["sd_"+e]=t,SDElement_dce.call(document,e)},SDElement_transform=SDElement.transform=function(){var e,t,i,n,o=["MozTransform","msTransform","OTransform","WebkitTransform","transform"],r=document.documentElement.style,a="";for(e=o.length-1;e>=0;e--)if("undefined"!=typeof r[o[e]]){t=o[e],i=t+"Origin";break}return"MozTransform"===t&&(a="px"),n=t?function(e,n,o,r){var s=e.sdStyle;s||(s=e.sdStyle=e.style,s[i]="0 0"),n+=a,o+=a,r+=",",s[t]="matrix("+r+"0,0,"+r+n+","+o+")"}:function(e,t,i,n){var o=e.style;o.left=t+"px",o.top=i+"px",o.fontSize=n+"em",o.width=100*n+"%",o.height=100*n+"%"}}();document.createElement=function(e){var t=SDElement_customElements["sd_"+e];return t?new t:SDElement_dce.apply(this,arguments)};var SDEvent=SD.Event={},SDEvent_$=SDEvent.$=function(e){return e?e:"undefined"!=typeof event?event:null},SDEvent_raise=SDEvent.raise=function(){return document.createEvent?function(e,t,i){i=i||!1;var n=document.createEvent("HTMLEvents");return n.initEvent(t,i,!0),e.dispatchEvent(n)}:document.createEventObject?function(e,t){var i=document.createEventObject();try{return e.fireEvent("on"+t,i)}catch(n){SDDebug_warn("Event not fired: "+t+". "+n.message)}}:(SDDebug_error("Seadragon2.Event: no raise ability."),SDFunction_EMPTY)}(),SDEvent_cancel=function(e){e=SDEvent_$(e),e.preventDefault&&e.preventDefault(),e.cancel=!0,e.returnValue=!1},SDEvent_stop=function(e){e=SDEvent_$(e),e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0},SDEvent_add=SDEvent.add=function(){return"function"==typeof addEventListener?function(e,t,i,n){n=n||!1,e.addEventListener(t,i,n),"mousewheel"===t?e.addEventListener("DOMMouseScroll",i,n):"DOMMouseScroll"===t&&e.addEventListener("mousewheel",i,n)}:"undefined"!=typeof attachEvent?function(e,t,i,n){e.attachEvent("on"+t,i),"DOMMouseScroll"===t&&e.attachEvent("onmousewheel",i),n&&e.setCapture&&e.setCapture()}:(SDDebug_error("Seadragon2.Event: no add ability."),SDFunction_EMPTY)}(),SDEvent_remove=SDEvent.remove=function(){return"function"==typeof removeEventListener?function(e,t,i,n){n=n||!1,e.removeEventListener(t,i,n),"mousewheel"===t?e.removeEventListener("DOMMouseScroll",i,n):"DOMMouseScroll"===t&&e.removeEventListener("mousewheel",i,n)}:"undefined"!=typeof detachEvent?function(e,t,i,n){e.detachEvent("on"+t,i),"DOMMouseScroll"===t&&e.detachEvent("onmousewheel",i),n&&e.releaseCapture&&e.releaseCapture()}:(SDDebug_error("Seadragon2.Event: no remove ability."),SDFunction_EMPTY)}(),SDTimer=SD.Timer=new function(){function e(){var e,t,i=(new Date).getTime();for(e=s;e;e=e.next){try{t=e.callback(e.arg,i)}catch(n){SDDebug_warn("Exception caught in timer: "+n.message)}t||a.unregister(e)}}var t,i,n,o,r,a=this,s=null,l=16,c=null;this.register=function(e,t){var n={callback:e,arg:t};return n.next=s,s&&(s.prev=n),n.prev=null,s=n,i(),n},this.unregister=function(e){e.dead||(e.next&&(e.next.prev=e.prev),e.prev?e.prev.next=e.next:s=e.next,s||n(),e.dead=!0)},"function"==typeof requestAnimationFrame?o=requestAnimationFrame:"function"==typeof mozRequestAnimationFrame?o=mozRequestAnimationFrame:"function"==typeof webkitRequestAnimationFrame?o=webkitRequestAnimationFrame:"function"==typeof msRequestAnimationFrame&&(o=msRequestAnimationFrame),o?(t=function(){return r?(r=!1,void(c=null)):(e(),void o(t))},i=function(){r=!1,c||(c=!0,o(t))},n=function(){c&&(r=!0)}):(i=function(){null===c&&(c=setInterval(e,l))},n=function(){null!==c&&(clearInterval(c),c=null)})},SDEventManager=SD.EventManager=function(){var e={};this.addListener=function(t,i){"function"==typeof i&&(e.hasOwnProperty(t)||(e[t]=[]),e[t].push(i))},this.removeListener=function(t,i){var n=e[t];if("function"==typeof i&&n){var o,r=n.length;for(o=0;o<r;o++)if(i===n[o])return void n.splice(o,1)}},this.clearListeners=function(t){e.hasOwnProperty(t)&&delete e[t]},this.listListeners=function(t){if(e.hasOwnProperty(t)){var i=e[t];if(i&&i.length)return i.slice(0)}},this.trigger=function(t){var i=e[t],n=[].slice.call(arguments,1);if(i){i=i.slice(0);var o,r=i.length;for(o=0;o<r;o++)try{i[o].apply(window,n)}catch(a){SDDebug_warn(a.name+" while executing "+t+" handler: "+a.message,a)}}}},SDMouse=SD.Mouse={},SDMouse_getPosition=SDMouse.getPosition=function(e){var t=new SDPoint;return"DOMMouseScroll"===e.type&&SDBrowser_isFF<3?(t.x=e.screenX,t.y=e.screenY):"number"==typeof e.pageX?(t.x=e.pageX,t.y=e.pageY):"number"==typeof e.clientX?(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop):SDDebug_error("Unknown event mouse position, no known technique."),t},SDMouse_getScroll=SDMouse.getScroll=function(e){var t=0;return"number"==typeof e.wheelDelta?t=e.wheelDelta:"number"==typeof e.detail?t=-e.detail:Seadragon2.Debug.fail("Unknown event mouse scroll, no known technique."),t?t/Math.abs(t):0};SDTileCache.prototype.insert=function(e){var t=null;return this.capacity<=0&&(t=this.oldest,this.remove(t)),this.capacity--,e.cacheOlder=this.newest,this.newest?this.newest.cacheNewer=e:this.oldest=e,this.newest=e,e.cacheNewer=null,t},SDTileCache.prototype.remove=function(e){this.capacity++,e.cacheOlder?e.cacheOlder.cacheNewer=e.cacheNewer:this.oldest=e.cacheNewer,e.cacheNewer?e.cacheNewer.cacheOlder=e.cacheOlder:this.newest=e.cacheOlder},SDTileCache.prototype.refresh=function(e){this.remove(e),this.insert(e)};var SDTileInfo=SD.TileInfo=function(e,t){this.url=e,this.crop=t?SDRect_$(t):null},SDTileInfo_$=SDTileInfo.$=function(e){return e instanceof SDTileInfo?e:"string"==typeof e?new SDTileInfo(e,null):new SDTileInfo(e.url,e.crop)},SDTileSource=SD.TileSource=function(e,t,i,n,o,r,a){3===arguments.length&&"object"==typeof i&&(n=i.height,i=i.width);var s=SDMath_log2(Math.max(e,t)),l=SDMath_ceil(s),c=SDMath_log2(i);this.width=e,this.height=t,this.tileWidth=i||n,this.tileHeight=n||i,this.tileOverlap=o||0,this.minLevel=SDMath_clamp(r||0,0,l),this.overviewLevel=SDMath_clamp("number"==typeof a?a:c,this.minLevel,l),this.dimensions=new SDSize(e,t),this.aspectRatio=e/t,this.normHeight=t/e,this.tileSize=new SDSize(this.tileWidth,this.tileHeight),this.maxLevel=l,this.sharpen=l-s},SDTileSource_$=SDTileSource.$=function(e){var t,i,n,o;if(e instanceof SDTileSource)return e;"object"==typeof e.tileSize?(n=e.tileSize.width,o=e.tileSize.height):"number"==typeof e.tileSize&&(n=o=e.tileSize),t=new SDTileSource(e.width,e.height,e.tileWidth||n,e.tileHeight||o,e.tileOverlap,e.minLevel,e.maxLevel);for(i in e)e.hasOwnProperty(i)&&"tileSize"!==i&&(t[i]=e[i]);return t},SDTileSourcePrototype=SDTileSource.prototype;SDTileSourcePrototype.getLevelScale=function(e){var t=this.maxLevel-e;return t<31?1/(1<<t):Math.pow(.5,t)},SDTileSourcePrototype.getNumTiles=function(e){var t=this.getLevelScale(e);return new SDSize(Math.ceil(t*this.width/this.tileWidth),Math.ceil(t*this.height/this.tileHeight))},SDTileSourcePrototype.getPixelRatio=function(e){var t=this.getLevelDimensions(e);
return new SDSize(1/t.width,1/t.height)},SDTileSourcePrototype.getTileAtPoint=function(e,t,i){var n=SDPoint_$(t).times(this.getLevelDimensions(e).width);return i&&(n.x%1===0&&n.x--,n.y%1===0&&n.y--),new SDPoint(Math.floor(n.x/this.tileWidth),Math.floor(n.y/this.tileHeight))},SDTileSourcePrototype.getTilesInRect=function(e,t){var i,n,o,r,a=this.getTileAtPoint(e,t.getTopLeft()),s=this.getTileAtPoint(e,t.getBottomRight(),!0),l=this.getNumTiles(e);return i=SDMath_max(a.x,0),o=SDMath_max(a.y,0),n=SDMath_min(s.x,l.width-1),r=SDMath_min(s.y,l.height-1),new SDRect(i,o,n-i,r-o)},SDTileSourcePrototype.getTileBounds=function(e,t,i){var n,o,r=this.getLevelDimensions(e),a=1/r.width,s=this.normHeight/r.height;return n=0===t?0:this.tileWidth*t-this.tileOverlap,o=0===i?0:this.tileHeight*i-this.tileOverlap,new SDRect(a*n,s*o,a*Math.min(this.tileWidth+(0===t?1:2)*this.tileOverlap,r.width-n),s*Math.min(this.tileHeight+(0===i?1:2)*this.tileOverlap,r.height-o))},SDTileSourcePrototype.getTileInfo=function(e,t,i){return null},SDTileSourcePrototype.levelExists=function(e){return!0},SDTileSourcePrototype.tileExists=function(e,t,i){return!0},SDTileSourcePrototype.getLevelDimensions=function(e){return this.dimensions.times(this.getLevelScale(e)).apply(SDMath_ceil)},SDTileSourcePrototype.getTileBelow=function(e,t,i,n){var o,r,a;return"undefined"==typeof n&&(n=e-1),n<this.minLevel||!this.levelExists(n)?null:(o=this.getLevelScale(e),r=this.getLevelScale(n),a=r/o,new SDPoint(SDMath_floor(t*a),SDMath_floor(i*a)))},SDTileSourcePrototype.getTilesAbove=function(e,t,i,n){var o,r,a,s,l;return"undefined"==typeof n&&(n=e+1),n>this.maxLevel||!this.levelExists(n)?null:(l=this.getNumTiles(n),o=this.getLevelScale(e),r=this.getLevelScale(n),a=r/o,s=new SDRect(t*a,i*a,a-1,a-1),s.x+s.width>=l.width&&(s.width=l.width-s.x-1),s.y+s.height>=l.height&&(s.height=l.height-s.y-1),s)},SDTileSourcePrototype.getNumTilesAbove=function(e,t,i,n){var o=this.getTilesAbove(e,t,i,n);return o?(o.width+1)*(o.height+1):1/0};var SDDisplayRect=SD.DisplayRect=function(e,t,i,n,o,r){this.base(e,t,i,n),this.base=this.base.prototype,this.minLevel=o||0,this.maxLevel=r||Number.POSITIVE_INFINITY},SDDisplayRect$=SDDisplayRect.$=function(e){return e instanceof SDDisplayRect?e:new SDDisplayRect(e.x,e.y,e.width,e.height,e.minLevel,e.maxLevel)},SDDisplayRectPrototype=SDDisplayRect.prototype=new SDRect;SDDisplayRectPrototype.base=SDRect,SDDisplayRectPrototype.equals=function(e){return this.base.equals.call(this,e)&&(this.minLevel===e.minLevel||0)&&(this.maxLevel===e.maxLevel||0)},SDDisplayRectPrototype.toString=function(){return this.base.toString.call(this).replace("]",["|",this.minLevel,"-",this.maxLevel,"]"].join(""))};var SDDziTileSource=SD.DziTileSource=function(e,t,i,n,o,r,a){this.base(e,t,i,i,n),this.base=this.base.prototype,this.tilesUrl=o,this.imageFormat=r,this.displayRects=a,this.isSparse=!!(a&&a.length>1),this.displayRectsByLevel=function(){var e,t,i,n,o,r=this.displayRects,a={};if(!this.isSparse)return null;for(e=0;e<r.length;e++)for(t=r[e],n=Math.max(t.minLevel,this.minLevel),o=Math.min(t.maxLevel,this.maxLevel),i=n;i<=o;i++)a[i]?a[i].push(t):a[i]=[t];return a}.call(this)},SDDziTileSource$=SDDziTileSource.$=function(e){var t;return e instanceof SDDziTileSource?e:(t=e.tileSize,"object"==typeof t&&(t=t.width||t.height),new SDDziTileSource(e.width,e.height,t||e.tileWidth||e.tileHeight,e.tileOverlap,e.tilesUrl,e.imageFormat,e.displayRects))},SDDziTileSourcePrototype=SDDziTileSource.prototype=new SDTileSource;SDDziTileSourcePrototype.base=SDTileSource,SDDziTileSourcePrototype.getTileInfo=function(e,t,i){return[this.tilesUrl,e,"/",t,"_",i,".",this.imageFormat].join("")},SDDziTileSourcePrototype.tileExists=function(e,t,i){var n,o,r,a,s,l,c,u,h,d,m,f;if(!this.isSparse)return!0;if(r=this.displayRectsByLevel[e],!r||!r.length)return!1;for(n=0;n<r.length;n++)if(o=r[n],a=this.getLevelScale(e),s=o.x*a,c=o.y*a,l=s+o.width*a,u=c+o.height*a,h=Math.floor(s/this.tileWidth),m=Math.floor(c/this.tileHeight),d=Math.ceil(l/this.tileWidth),f=Math.ceil(u/this.tileHeight),h<=t&&t<d&&m<=i&&i<f)return!0;return!1},SDDziTileSourcePrototype.getTileBelow=function(e,t,i,n){return void 0===n&&(n=e-1),n<=this.dzcMaxLevel?n<this.minLevel||!this.levelExists(n)?null:SDPoint_origin:SDTileSourcePrototype.getTileBelow.call(this,e,t,i,n)};var SDDzcTileSource=SD.DzcTileSource=function(e,t,i,n,o,r,a,s,l){this.base(e,t,i),this.base=this.base.prototype,this.dzcTileSize=i,this.dzcMaxLevel=n,this.dzcItemId=o,this.dzcTilesUrl=r,this.dzcImageFormat=a,this.dzcExpansionUrl=l,this.dziSource=null,this.dziSourceRequested=!1,this.dzcItemCoords=SDMath_reverseMorton(s)},SDDzcTileSource$=SDDzcTileSource.$=function(e){return e instanceof SDDzcTileSource?e:new SDDzcTileSource(e.width,e.height,e.dzcTileSize,e.dzcMaxLevel,e.dzcItemId,e.dzcTilesUrl,e.dzcImageFormat,e.dzcItemN,e.dzcExpansionUrl)},SDDzcTileSourcePrototype=SDDzcTileSource.prototype=new SDTileSource;SDDzcTileSourcePrototype.base=SDTileSource,SDDzcTileSourcePrototype.isDzc=!0,SDDzcTileSourcePrototype.getTileInfo=function(e){var t=1<<e,i=this.dzcTileSize/(1<<e),n=this.getLevelScale(e),o=this.dzcItemCoords.y,r=this.dzcItemCoords.x,a=Math.floor(o/i),s=Math.floor(r/i);return new SDTileInfo([this.dzcTilesUrl,e,"/",a,"_",s,".",this.dzcImageFormat].join(""),new SDRect(o%i*t,r%i*t,Math.max(1,Math.floor(n*this.width)),Math.max(1,Math.floor(n*this.height))))},SDDzcTileSourcePrototype.levelExists=function(e){return e<=this.dzcMaxLevel},SDDzcTileSourcePrototype.getTilesAbove=function(e,t,i,n){if(void 0===n&&(n=e+1),n>this.dzcMaxLevel){var o,r=this.dziSource;return r&&(o=this.getNumTiles(n))?new SDRect(0,0,o.width-1,o.height-1):null}return new SDRect(0,0,0,0)},function(){var e;for(e in SDDzcTileSourcePrototype)!function(){var t=e,i=SDDzcTileSourcePrototype[t];"base"!==t&&"function"==typeof i&&(SDDzcTileSourcePrototype[t]=function(e,n,o,r){var a=this.dziSource;return e>this.dzcMaxLevel&&a?a[t](e,n,o,r):i.call(this,e,n,o,r)})}()}(),SDDzcTileSourcePrototype.expand=function(){var e;this.dziSource||this.dziSourceRequested||!this.dzcExpansionUrl||(this.dziSourceRequested=!0,e=this,SDDeepZoom_fetchTileSource(this.dzcExpansionUrl,function(t){e.dziSource=t,t.dzcMaxLevel=e.dzcMaxLevel}))},SDDzcTileSourcePrototype.contract=function(){this.dziSource=null,this.dziSourceRequested=!1};var SDDeepZoom=SD.DeepZoom={},SDDeepZoom_storedXml={},SDDeepZoom_parseDziXml=function(e){var t,i,n,o,r=e.getElementsByTagName("Size")[0],a=e.getElementsByTagName("DisplayRect"),s={width:parseInt(r.getAttribute("Width"),10),height:parseInt(r.getAttribute("Height"),10),tileSize:parseInt(e.getAttribute("TileSize"),10),tileOverlap:parseInt(e.getAttribute("Overlap"),10),imageFormat:e.getAttribute("Format"),dispRects:[]};for(t=0;t<a.length;t++)i=a[t],n=i.getElementsByTagName("Rect")[0],o=new SDDisplayRect(parseInt(n.getAttribute("X"),10),parseInt(n.getAttribute("Y"),10),parseInt(n.getAttribute("Width"),10),parseInt(n.getAttribute("Height"),10),0,parseInt(i.getAttribute("MaxLevel"),10)),s.dispRects.push(o);return s},SDDeepZoom_parseDzcXml=function(e){var t,i,n,o,r,a,s,l=e.getAttribute("Format"),c=parseInt(e.getAttribute("MaxLevel"),10),u=parseInt(e.getAttribute("TileSize"),10),h=e.getElementsByTagName("I"),d=h.length,m=new Array(d);for(t=0;t<h.length;t++)i=h[t],n=i.getElementsByTagName("Size")[0],o=i.getElementsByTagName("Viewport"),r={id:parseInt(i.getAttribute("Id"),10),n:parseInt(i.getAttribute("N"),10),width:parseInt(n.getAttribute("Width"),10),height:parseInt(n.getAttribute("Height"),10),source:i.getAttribute("Source"),viewport:null,dzcTileSize:u,dzcMaxLevel:c,dzcImageFormat:l},o.length>=1&&(a=o[0],s=parseFloat(a.getAttribute("Width")),r.viewport=new SDRect(parseFloat(a.getAttribute("X")),parseFloat(a.getAttribute("Y")),s,s*r.height/r.width)),m[t]=r;return m},SDDeepZoom_parseXml=function(e){var t,i;return"string"==typeof e&&(e=SDXml_parse(e)),e&&e.documentElement?(t=e.documentElement,i=t.tagName,"Image"===i?SDDeepZoom_parseDziXml(t):"Collection"===i?SDDeepZoom_parseDzcXml(t):null):null},SDDeepZoom_getTilesUrl=SDDeepZoom.getTilesUrl=function(e){var t=e.split("/"),i=t.length-1,n=t[i],o=n.lastIndexOf(".");return o>-1&&(t[i]=n.slice(0,o)),t.join("/")+"_files/"},SDDeepZoom_getExpansionUrl=function(e,t){return t?e.substr(0,e.lastIndexOf("/"))+"/"+t:null},SDDeepZoom_makeDzcSources=function(e,t,i){var n,o,r=e.length,a=new Array(r);for(n=0;n<r;n++)o=e[n],o.dzcItemId=o.id,o.dzcItemN=o.n,o.dzcTilesUrl=i,o.dzcExpansionUrl=SDDeepZoom_getExpansionUrl(t,o.source),a[n]=SDDzcTileSource$(o);return a},SDDeepZoom_infoToTileSource=function(e,t){var i,n=SDDeepZoom_getTilesUrl(t);return e instanceof Array?(i=parseInt(t.substring(t.lastIndexOf("#")+1),10),isNaN(i)?SDDeepZoom_makeDzcSources(e,t,n):(e=e[i],e.dzcItemId=e.id,e.dzcItemN=e.n,e.dzcTilesUrl=n,e.dzcExpansionUrl=SDDeepZoom_getExpansionUrl(t,e.source),SDDzcTileSource$(e))):(e.tilesUrl=n,SDDziTileSource$(e))},SDDeepZoom_getTileSource=function(e,t){var i=SDDeepZoom_parseXml(t);return SDDeepZoom_infoToTileSource(i,e)},SDDeepZoom_fetchTileSource=SDDeepZoom.fetchTileSource=function(e,t){var i,n=e.split("#",1)[0],o=SDDeepZoom_storedXml[n];o?setTimeout(function(){t(SDDeepZoom_infoToTileSource(o,e))},0):(i=SDNetwork_tryMakeXmlHttpRequest(n,function(i,n,o){var r,a;if(n){if(a=SDDeepZoom_storedXml[i],!a){if(r=o.responseXML||o.responseText,a=SDDeepZoom_parseXml(r),!a)return;SDDeepZoom_storedXml[i]=a}t(SDDeepZoom_infoToTileSource(a,e))}else SDDebug_warn("DeepZoom.fetchTileSource (callback): XML fetch failed.")},!0),i||SDDebug_warn("DeepZoom.fetchTileSource: Failed to make request."))},SDNetwork=SD.Network={},SDNetwork_MAX_CONNECTIONS_PER_HOSTNAME=SDNetwork.MAX_CONNECTIONS_PER_HOSTNAME=6,SDNetwork_MAX_CONNECTIONS_TOTAL=SDNetwork.MAX_CONNECTIONS_TOTAL=30,SDNetwork_numRequestsTo={},SDNetwork_numRequestsTotal=0,SDNetwork_imageRequests={},SDNetwork_xmlHttpRequests={},SDNetwork_numSpotsAvailable=SDNetwork.numSpotsAvailable=function(e){var t=Math.max(0,SDNetwork_MAX_CONNECTIONS_TOTAL-(SDNetwork_numRequestsTotal||0));return e?Math.min(t,Math.max(0,SDNetwork_MAX_CONNECTIONS_PER_HOSTNAME-(SDNetwork_numRequestsTo[e]||0))):t},SDNetwork_markSpotOpen=SDNetwork.markSpotOpen=function(e){SDNetwork_numRequestsTo[e]=Math.max(0,(SDNetwork_numRequestsTo[e]||0)-1),SDNetwork_numRequestsTotal=Math.max(0,(SDNetwork_numRequestsTotal||0)-1)},SDNetwork_markSpotTaken=SDNetwork.markSpotTaken=function(e){SDNetwork_numRequestsTo[e]=(SDNetwork_numRequestsTo[e]||0)+1,SDNetwork_numRequestsTotal=(SDNetwork_numRequestsTotal||0)+1},SDNetwork_tryMakeImageRequest=SDNetwork.tryMakeImageRequest=SDNetwork_generateTryMakeRequestMethod(SDNetwork_imageRequests,function(e){var t=document.createElement("img");return t.onload=SDNetwork_onImageLoad,t.onerror=t.onabort=SDNetwork_onImageError,t.src=e,t}),SDNetwork_tryMakeXmlHttpRequest=SDNetwork.tryMakeXmlHttpRequest=SDNetwork_generateTryMakeRequestMethod(SDNetwork_xmlHttpRequests,function(e){return SDXml_fetch(e,SDNetwork_onXmlHttpSuccess,SDNetwork_onXmlHttpFailure)}),SDNetwork_onImageLoad=SDNetwork_generateResponseHandler(SDNetwork_imageRequests,!0),SDNetwork_onImageError=SDNetwork_generateResponseHandler(SDNetwork_imageRequests,!1),SDNetwork_onXmlHttpSuccess=SDNetwork_generateResponseHandler(SDNetwork_xmlHttpRequests,!0),SDNetwork_onXmlHttpFailure=SDNetwork_generateResponseHandler(SDNetwork_xmlHttpRequests,!1);Tile.prototype.resetCoverage=function(){this.covered=0},Tile.prototype.covers=function(){return this.drawnOpaque||this.tilesAbove===this.covered},Tile.prototype.isCovered=function(){return this.covered===this.tilesAbove},Tile.prototype.cover=function(){return this.covered++,this.covered>this.tilesAbove&&SDDebug_error("tile coverage is broken!"),this.covered===this.tilesAbove},Tile.prototype.uncover=function(){return this.covered--,this.covered<0&&SDDebug_error("tile coverage is broken"),this.covered+1===this.tilesAbove},Tile.prototype.drawn=function(){return(this.drawnOpaque||this.isCovered())&&SDDebug_error("tile coverage is broken"),this.drawnOpaque=!0,!0};var SDTileLoader_imgInfos={},SDTileLoader_trigger=!1,SDTileLoader_triggerProcessing,SDTileLoader_cache=new SDTileCache(1e3),SDTileLoader_nominations={},SDTileLoader_nullImgInfo={loading:!1,loaded:!1,failed:!1,img:null,owners:null,tileInfos:null};SDTileLoader_triggerProcessing=function(){SDTileLoader_trigger||(SDTileLoader_trigger=!0,setTimeout(SDTileLoader_processNominations,0))};var SDImageManager=SD.ImageManager={},SDImageManager_markupCheckToken=null,SDImageManager_isEnabled=!0;SDImageManager.register=function(e,t){if(SDImageManager_isEnabled)return SDTimer.register(e,t)},SDImageManager.unregister=function(e){return SDTimer.unregister(e)},SDImageManager.enableMarkupChecking=function(){SDImageManager_markupCheckToken||(SDImageManager_markupCheckToken=SDTimer.register(SDImageManager_checkForInit))},SDImageManager.disableMarkupChecking=function(){SDImageManager_markupCheckToken&&(SDTimer.unregister(SDImageManager_markupCheckToken),SDImageManager_markupCheckToken=null)},SDImageManager.enable=function(){SDImageManager_isEnabled=!0},SDImageManager.disable=function(){SDImageManager_isEnabled=!1};var SDDrawer_CANVAS_API_AVAILABLE="function"==typeof document.createElement("canvas").getContext,SDDrawer=function(e,t){this.container=e,this.normHeight=t},SDDrawerPrototype=SDDrawer.prototype,SDDrawer_$=function(e,t){return SDDrawer_CANVAS_API_AVAILABLE?new SDCanvasDrawer(e,t):new SDImgDrawer(e,t)},SDDrawer_nullDrawer=new SDDrawer;SDDrawerPrototype.drawTile=function(e,t,i){return e},SDDrawerPrototype.addLevelOnTop=function(){return!0},SDDrawerPrototype.addLevelBehind=function(e){return!0},SDDrawerPrototype.removeLevel=function(e){},SDDrawerPrototype.updateBlend=function(e,t,i){},SDDrawerPrototype.updateFade=function(e,t){},SDDrawerPrototype.discardTile=function(e,t){},SDDrawerPrototype.setLevelDimensions=function(e){};var SDCanvasDrawer=function(){SDDrawer.apply(this,arguments)},SDCanvasDrawerPrototype=SDCanvasDrawer.prototype=new SDDrawer;SDCanvasDrawerPrototype.drawTile=function(e,t,i,n){var o,r,a,s,l,c,u,h=t.crop,d=t.bounds,m=0;return e.complete?("number"!=typeof n?n=t.opacity:m=t.opacity,i.canvas?(o=i.canvas,r=o.getContext("2d"),a=i.fullSize,s=i.normalizedBounds,1!==n&&(r.save(),m=m||0,r.globalAlpha=(n-m)/(1-m)),c=a.width/s.width,u=a.height/s.height,l=new SDRect((d.x-s.x)*c,(d.y-s.y)*u,d.width*c,d.height*u),h?r.drawImage(e,h.x,h.y,h.width,h.height,l.x,l.y,l.width,l.height):r.drawImage(e,l.x,l.y,l.width,l.height),1!==n&&r.restore(),e):void SDDebug_warn("SDCanvasDrawer: nonexistent level")):void SDDebug_warn("Seadragon2.Canvas.drawImage: ignoring incomplete image: "+e.src)},SDCanvasDrawerPrototype.updateBlend=function(e,t,i){t.canvas||SDDebug_error("CanvasDrawer: Attempting to blend tile on nonexistent level!"),this.drawTile(e.view,e,t,i)},SDCanvasDrawerPrototype.updateFade=function(e,t){SDElement_setOpacity(e.canvas,t)},SDCanvasDrawerPrototype.positionLevel=function(e){var t=e.canvas,i=e.normalizedBounds,n=t.style;n.left=(100*i.x).toFixed(8)+"%",n.top=(i.y/this.normHeight*100).toFixed(8)+"%",n.width=(100*i.width).toFixed(8)+"%",n.height=(i.height/this.normHeight*100).toFixed(8)+"%"},SDCanvasDrawerPrototype.setLevelDimensions=function(e){var t,i,n,o,r,a=e.view.canvas,s=e.bounds,l=e.tiles,c=s.x,u=s.y,h=s.width+c,d=s.height+u,m=e.dimensions;if(r=l[c][u].bounds.union(l[h][d].bounds),m=r.scale(m.width,new SDPoint(0,0)),m.width=SDMath_round(m.width)||1,m.height=SDMath_round(m.height)||1,a.width=m.width,a.height=m.height,e.view.fullSize=m,e.view.normalizedBounds=r,this.positionLevel(e.view),l)for(n=c;n<=h;n++)for(t=l[n],o=u;o<=d;o++)i=t[o],i.view&&this.drawTile(i.view,i,e.view)},SDCanvasDrawerPrototype.makeCanvas=function(e){var t=document.createElement("canvas"),i=t.style;return i.display="block",i.position="absolute",i.overflow="hidden",i.width="100%",i.height="100%",e.canvas=t,e.normalizedBounds=new SDRect(0,0,1,this.normHeight),t},SDCanvasDrawerPrototype.addLevelOnTop=function(){var e={};return this.container.appendChild(this.makeCanvas(e)),e},SDCanvasDrawerPrototype.addLevelBehind=function(e){var t={};return this.container.insertBefore(this.makeCanvas(t),e.canvas),t},SDCanvasDrawerPrototype.removeLevel=function(e){this.container.removeChild(e.canvas),delete e.canvas};var SDImgDrawer_MS_INTERPOLATION_MODE=document.documentMode?"bicubic":"nearest-neighbor",SDImgDrawer=function(){SDDrawer.apply(this,arguments)},SDImgDrawerPrototype=SDImgDrawer.prototype=new SDDrawer;SDImgDrawerPrototype.drawTile=function(e,t,i){var n,o,r,a,s=t.crop,l=t.bounds,c=t.opacity;return i||SDDebug_error("SDImgDrawer: nonexistent level"),n=document.createElement("img"),o=n.style,n.src=e.src,o.position="absolute",o.msInterpolationMode=SDImgDrawer_MS_INTERPOLATION_MODE,s?(r=document.createElement("div"),a=r.style,a.position="absolute",a.overflow="hidden",o.left=(-100*s.x/s.width).toFixed(8)+"%",o.top=(-100*s.y/s.height).toFixed(8)+"%",o.width=(100*e.width/s.width).toFixed(8)+"%",o.height=(100*e.height/s.height).toFixed(8)+"%",r.appendChild(n)):(r=n,a=o),a.left=(100*l.x).toFixed(8)+"%",a.top=(100*l.y/this.normHeight).toFixed(8)+"%",a.width=(100*l.width).toFixed(8)+"%",a.height=(100*l.height/this.normHeight).toFixed(8)+"%",i.appendChild(r),"number"==typeof c&&SDElement_setOpacity(r,c),r},SDImgDrawerPrototype.updateBlend=function(e,t,i){SDElement_setOpacity(e.view,i)},SDImgDrawerPrototype.updateFade=function(e,t){SDElement_setOpacity(e,t)},SDImgDrawerPrototype.makeDiv=function(){var e=document.createElement("div"),t=e.style;return t.display="block",t.position="absolute",t.overflow="visible",t.width="100%",t.height="100%",e},SDImgDrawerPrototype.addLevelOnTop=function(){var e=this.makeDiv();return this.container.appendChild(e),e},SDImgDrawerPrototype.addLevelBehind=function(e){var t=this.makeDiv();return this.container.insertBefore(t,e),t},SDImgDrawerPrototype.removeLevel=function(e){this.container.removeChild(e)},SDImgDrawerPrototype.discardTile=function(e,t){t.removeChild(e.view)};var SDImageState=function(e,t,i,n){this.blendInTime=i||0,this.fadeOutTime=n||0,this.source=e,this.drawer=t,this.maxLevel=e.minLevel-1,this.clip=new SDRect(0,0,1,e.normHeight),this.levels={},this.position=SDRect_nullRect},SDImageStatePrototype=SDImageState.prototype,SDImageState_animator=SDTimer;SDImageStatePrototype.update=function(e,t,i){var n,o=this.source,r=this.position,a=o.normHeight;if(i=i||0,e&&!r.equals(e)&&(this.position=e),t&&(t=new SDRect(t.x/e.width,t.y*a/e.height,t.width/e.width,t.height*a/e.height)),e)for(n=SDMath_clamp(SDMath_ceil(SDMath_log2(SDMath_max(e.width,e.height))-i+o.sharpen),o.minLevel,o.maxLevel),o.isDzc&&(n>o.dzcMaxLevel?o.expand():o.contract());!o.levelExists(n);)n--;else n=this.maxLevel;n!==this.maxLevel&&this.setLevel(n),t&&!t.equals(this.clip)&&this.setClipBounds(t)},SDImageStatePrototype.setLevel=function(e){var t,i,n,o=this.maxLevel,r=this.clip;if(this.maxLevel=e,o<e)for(t=o+1;t<=e;t++)i=this.initLevelData(t),this.setLevelClipBounds(i,r),this.drawLevel(i,null,!0);else if(o>e){for(t=o;t>e;t--)i=this.levels[t],i&&i.visible&&(n=this.levels[t]),this.fadeLevel(t),this.setLevelClipBounds(i,SDRect_nullRect);this.redrawAllLevels(n)}},SDImageStatePrototype.redrawAllLevels=function(e){var t,i=this.maxLevel,n=this.source.minLevel,o=this.levels;for(t=i;t>=n;t--)this.drawLevel(o[t],e),o[t].visible&&(e=o[t])},SDImageStatePrototype.setClipBounds=function(e){var t,i=this.source.minLevel,n=this.maxLevel,o=this.levels;for(this.clip=e,t=i;t<=n;t++)this.setLevelClipBounds(o[t],e);this.redrawAllLevels()},SDImageStatePrototype.destroy=function(){var e,t=this.levels;for(e=this.minLevel;e<=this.maxLevel;e++)t[e].view&&this.drawer.removeLevel(t[e].view);this.levels=null,this.blendTile=SDFunction_EMPTY,this.onTileDrawn=SDFunction_EMPTY,this.getTilePriority=function(){return 0},this.drawer=null},SDImageStatePrototype.blendTile=function(e,t){var i=(new Date).getTime(),n=this.levels[t.level];t.opacity=0,t.view=this.drawer.drawTile(e,t,n.view),SDImageState_animator.register(SDImageState_blendCallback,{levelData:n,tile:t,startTime:i,state:this})},SDImageStatePrototype.fadeLevel=function(e){var t=this.levels[e],i=(new Date).getTime();t.fading=!0,SDImageState_animator.register(SDImageState_fadeCallback,{state:this,level:e,startTime:i,levelData:t})},SDImageStatePrototype.initLevelData=function(e){var t=this.levels,i=t[e];return i&&i.visible&&(this.drawer.removeLevel(i.view),i.visible=!1),t[e]=i=new Level(e,this.source),i},SDImageStatePrototype.checkRemoveLevel=function(e){e.tilesVisible<0&&SDDebug_error("coverage is broken"),0!==e.tilesVisible||e.fading||(e.visible=!1,e.view&&(this.drawer.removeLevel(e.view),e.view=null))},SDImageStatePrototype.onUncover=function(e){e.uncover()&&(e.inBounds&&this.levels[e.level].tilesVisible++,e.tileBelow&&this.onUncover(e.tileBelow))},SDImageStatePrototype.onCover=function(e){var t;e.cover()&&(t=this.levels[e.level],e.view&&(this.drawer.discardTile(e,t.view),e.view=null),e.drawnOpaque?e.drawnOpaque=!1:e.tileBelow&&this.onCover(e.tileBelow),t.tilesVisible--,this.checkRemoveLevel(t))},SDImageStatePrototype.onDrawn=function(e){e.drawn(),e.tileBelow&&this.onCover(e.tileBelow)},SDImageStatePrototype.setLevelClipBounds=function(e,t){var i,n,o,r,a,s,l=e.num,c=this.source,u=e.bounds,h=c.getTilesInRect(l,t),d=e.tiles,m=h.x,f=h.y,p=h.height+f,g=h.width+m,v=u.x,S=u.y,D=v+u.width,w=S+u.height,y=e.fading&&this.drawer===SDDrawer_nullDrawer;if(!d||!u)return void SDDebug_error("uninitialized level "+l);if(!h.equals(u)){for(o=m;o<=g;o++)for(i=d[o],i||(d[o]={},i=d[o]),r=f;r<=p;r++)n=i[r],n||(a=c.getTileBelow(l,o,r),a?(s=this.levels[l-1].tiles[a.x][a.y],s||SDDebug_error("coverage is broken")):s=null,i[r]=new Tile(e.num,o,r,c,s),e.tilesVisible++);for(o=v;o<=D;o++){for(i=d[o],r=S;r<=w;r++)o>=m&&o<=g&&r>=f&&r<=p?r=p:(n=i[r],n.view&&!e.fading&&this.drawer.discardTile(n,e.view),n.isCovered()||e.tilesVisible--,n.inBounds=!1,n.drawnOpaque&&this.onUncover(n.tileBelow),y||delete i[r]);!y&&(o<m||o>g)&&delete d[o]}y||(e.bounds=h),this.checkRemoveLevel(e),e.visible&&!e.fading&&this.drawer.setLevelDimensions(e)}},SDImageStatePrototype.drawLevel=function(e,t,i){var n,o,r,a,s,l,c,u=e.bounds,h=e.num,d=u.x,m=d+u.width,f=u.y,p=f+u.height,g=this.source,v=this.drawer;if(0!==e.tilesVisible)for(e.tilesVisible<0&&SDDebug_error("coverage is broken"),e.visible||(e.visible=!0,t?e.view=v.addLevelBehind(t.view):e.view=v.addLevelOnTop(),v.setLevelDimensions(e)),n=d;n<=m;n++)for(o=f;o<=p;o++)g.tileExists(h,n,o)&&(r=new SDPoint(n,o),a=e.tiles[n][o],a.covers()||a.view||a.loading||(s=SDTileLoader_getImgInfo(a.url),s.failed||(l=a.bounds,s.loaded?i?this.blendTile(s.img,a):(a.opacity=1,a.view=v.drawTile(s.img,a,e.view),this.onDrawn(a)):(c=this.position,l=l.intersect(this.clip),l=new SDRect(l.x*c.width+c.x,l.y*c.height/g.normHeight+c.y,l.width*c.width,l.height*c.height/g.normHeight),a.area=l.getArea(),a.distance=l.getCenter().distanceTo(SDPoint_origin),a.loading=!0,SDTileLoader_nominate(a,SDImageState_onTileLoad,{levelData:e,state:this})))))};var SDImage_init,SDImage=SD.Image=function(e,t){return SDObject_extend(this,e),this.state=null,this.lastSrc="",this.container=document.createElement("div"),t&&t.attributes.src?this.src=t.attributes.src.value:this.src=this.lastSrc,this.complete=!0,t||(t=SDElement_dce.call(document,"sdimg")),SDImage_init(SDObject_extend(t,this,!0))},SDImagePrototype=SDImage.prototype,SDImage_pixelRatio=0;"undefined"!=typeof devicePixelRatio&&(SDImage_pixelRatio=SDMath_log2(devicePixelRatio)),SDElement_registerCustomElement("sdimg",SDImage),SDImagePrototype.blendTime=500,SDImagePrototype.fadeTime=500,SDImagePrototype.manualUpdates=!1,SDImagePrototype.clipParent=null,SDImagePrototype.immediateMode=!0,SDImagePrototype.blur=0,function(){var e,t,i,n="sdimg",o="display:inline-block",r=n+" {"+o+"}";if(document.createStyleSheet)try{t=document.styleSheets.length>0?document.styleSheets[0]:document.createStyleSheet(),t.addRule(n,o,0)}catch(a){SDDebug_warn("Error while creating default styles: "+a.message)}else e=document.documentElement.firstChild,t=document.createElement("style"),i=document.createTextNode(r),t.appendChild(i),e.insertBefore(t,e.firstChild)}(),SDImage_init=function(e){var t=e.container,i=t.style;return t.className="sdimgcontainerdiv",i.textAlign="left",i.overflow="hidden",e.style&&(e.appendChild(t),i.position="relative",i.width=i.height="100%"),e.manualUpdates||(e.timerID=SDImageManager.register(SDImage_onTick,e)),e},SDImagePrototype.update=function(e,t){SDImage_onTick(this,null,e,t)},SDImagePrototype.destroy=function(){this.drawer.destroy(),this.timerID&&SDImageManager.unregister(this.timerID)},SDImage.drawImage=function(e,t,i,n,o,r,a,s,l,c){var u,h,d,m,f,p,g,v,S,D,w,y,_,b,T,x,k,E,M,P,L,I,C,N,R=!0;if(t=t.state,!t)return SDDebug_warn("Image.drawImage: Image isn't ready yet!"),!1;for(N=t.maxLevel,void 0===o?(a=i,s=n,l=t.position.width,c=t.position.height):void 0===a?(a=i,s=n,l=o,c=r):(e.save(),e.beginPath(),e.rect(a,s,l,c),e.clip(),C=!0,a-=i*l/o,s-=n*c/r,l*=t.position.width/o,c*=t.position.height/r),u=t.source.normHeight,h=t.levels,d=t.source.minLevel;p=h[d];d++)if(p.visible){for(v=p.bounds,g=p.opacity,1!==g&&(e.save(),e.globalAlpha*=g,R=!1),D=v.x,y=v.y,w=D+v.width,_=y+v.height,S=p.tiles,m=D;m<=w;m++)for(b=S[m],f=y;f<=_;f++)T=b[f],T.view?(x=T.opacity,1!==x&&(e.save(),e.globalAlpha*=x,R=!1),k=T.crop,E=T.bounds,M=a+E.x*l,P=s+E.y*c/u,L=E.width*l,I=E.height*c/u,k?e.drawImage(T.view,k.x,k.y,k.width,k.height,M,P,L,I):e.drawImage(T.view,M,P,L,I),1!==x&&e.restore()):R=!1;1!==g&&e.restore()}return(N!==d-1||h[N]&&!h[N].visible)&&(R=!1),C&&e.restore(),R},function(){function e(e){return SDMouse_getPosition(e)}function t(e,t){var i=SDMouse_getPosition(e),n=SDElement_getPosition(t);return i.minus(n)}function i(e,t){for(var i=document.body;t&&e!==t&&i!==t;)try{t=t.parentNode}catch(n){return!1}return e===t}function n(){h=!0}function o(){h=!1}if(!SD.MouseTracker){var r,a,s,l,c,u="function"!=typeof addEventListener,h=!1,d=!1,m={},f=[];navigator.msPointerEnabled?(r="MSPointerDown",a="MSPointerUp",s="MSPointerOver",l="MSPointerOut",c="MSPointerMove"):(r="mousedown",a="mouseup",s="mouseover",l="mouseout",c="mousemove"),u?(SDEvent_add(document,r,n,!1),SDEvent_add(document,a,o,!1)):(SDEvent_add(window,r,n,!0),SDEvent_add(window,a,o,!0)),SD.MouseTracker=function(n,o){function p(e,t){var i,n=m;for(i in n)n.hasOwnProperty(i)&&N!==i&&n[i][e](t)}function g(){var e;for(e in O)if(O.hasOwnProperty(e)&&O[e])return!0;return!1}function v(e){e=e||window.event,u&&B&&!i(e.srcElement,n)&&p("onMouseOver",e);var o=e.target||e.srcElement,r=e.relatedTarget||e.fromElement,a=e.pointerId||0;i(n,o)&&!i(n,r)&&(O[a]=!0,C.trigger("enter",C,a,t(e,n),!!z[a],h))}function S(e){e=e||window.event,u&&B&&!i(e.srcElement,n)&&p("onMouseOut",e);var o=e.target||e.srcElement,r=e.relatedTarget||e.toElement,a=e.pointerId||0;i(n,o)&&!i(n,r)&&(O[a]=!1,C.trigger("exit",C,a,t(e,n),!!z[a],h))}function D(i){if(i=i||window.event,2!==i.button){var o=i.pointerId||0;z[o]=!0,O[o]=!0,H[o]=A[o]=e(i),F[o]=(new Date).getTime(),C.trigger("press",C,o,t(i,n)),(C.listListeners("press")||C.listListeners("drag"))&&SDEvent_cancel(i),u&&d?u&&f.push(I):(P(),d=!0,f=[I])}}function w(i){if(i=i||window.event,2!==i.button){var o=i.pointerId||0,r=(new Date).getTime()-F[o],a=e(i),s=H[o].distanceTo(a),l=r<=Z&&s<=W,c=i.target,u=document.body,h=!1;for(c=i.target;c&&c!==n&&c!==u;c=c.parentNode)V.hasOwnProperty(c.tagName)&&(h=!0);C.trigger("click",C,o,t(i,n),l,i.shiftKey,h)}}function y(e){e=e||window.event;var i=e.pointerId||0,o=!!z[i],r=!!O[i];2!==e.button&&(z[i]=!1,C.trigger("release",C,i,t(e,n),o,r),o&&r&&w(e))}function _(e){e=e||window.event;var t,i;if(2!==e.button){for(t=0;t<f.length;t++)i=f[t],i.hasMouse()||i.onMouseUp(e);L(),d=!1,e.srcElement.fireEvent("on"+e.type,document.createEventObject(e)),SDEvent_stop(e)}}function b(e){O[e.pointerId||0]||y(e),L()}function T(i){i=i||window.event;var o=i.pointerId||0,r=e(i),a=r.minus(A[o]||r);A[o]=r,(a.x||a.y)&&C.trigger("drag",C,o,t(i,n),a,i.shiftKey),C.listListeners("drag")&&SDEvent_cancel(i)}function x(e){var t;for(t=0;t<f.length;t++)f[t].onMouseMove(e);SDEvent_stop(e)}function k(e){e=e||window.event;var i=SDMouse_getScroll(e);i&&C.trigger("scroll",C,t(e,n),i,e.shiftKey),C.listListeners("scroll")&&SDEvent_cancel(e)}function E(){R||(SDEvent_add(n,s,v,!1),SDEvent_add(n,l,S,!1),SDEvent_add(n,r,D,!1),SDEvent_add(n,a,y,!1),SDEvent_add(n,"mousewheel",k,!1),R=!0,m[N]=I)}function M(){if(R){for(SDEvent_remove(n,s,v,!1),SDEvent_remove(n,l,S,!1),SDEvent_remove(n,r,D,!1),SDEvent_remove(n,a,y,!1),SDEvent_remove(n,"mousewheel",k,!1);B;)L();R=!1,delete m[N]}}function P(){B||(u?(SDEvent_remove(n,a,y,!1),SDEvent_add(n,a,_,!0),SDEvent_add(n,c,x,!0)):(SDEvent_add(window,a,b,!0),SDEvent_add(window,c,T,!0))),++B}function L(){1===B&&(u?(SDEvent_remove(n,c,x,!0),SDEvent_remove(n,a,_,!0),SDEvent_add(n,a,y,!1)):(SDEvent_remove(window,c,T,!0),SDEvent_remove(window,a,b,!0))),--B}o=o||{};var I,C=this,N=Math.random(),R=!1,B=0,z={},O={},A={},F={},H={},V={A:1,INPUT:1,TEXTAREA:1,SELECT:1,OPTION:1,OPTGROUP:1,BUTTON:1,LABEL:1},Z=o.clickTimeThreshold||500,W=o.clickDistThreshold||5;this.target=n,I={hasMouse:g,onMouseOver:v,onMouseOut:S,onMouseUp:y,onMouseMove:T},SDEventManager.call(this),this.isTracking=function(){return R},this.setTracking=function(e){e?E():M()}}}}();var SDMouseTracker=SD.MouseTracker,SDSpring=SD.Spring=function(e){function t(e){return(1-SDMath_exp(-e*o))/r}e=e||{};var i,n=e.initialValue||0,o=e.stiffness||5,r=1-SDMath_exp(-o),a=e.animationTime||1.5,s=e.decayTime||1,l=n,c=n,u=(new Date).getTime(),h=u,d=u,m=0,f=!1;this.getCurrent=function(){return n},this.getTarget=function(){return c},this.resetTo=function(e){f=!1,c=e,d=u,l=c,h=d},this.springTo=function(e){f=!1,l=n,h=u,c=e,d=h+1e3*a},this.shiftBy=function(e){l+=e,c+=e},this.toss=function(){i=Math.abs(m/(1e3*s)),f=!0},this.grab=function(){f=!1},this.update=function(e){var o,r,a=u,s=n;return u=e||(new Date).getTime(),o=u-a,f?(m>0?(m-=i*o,m<0&&(m=0)):m<0&&(m+=i*o,m>0&&(m=0)),n+=m*o,c=n):(n=u>=d?c:l+(c-l)*t((u-h)/(d-h)),o&&(r=SDMath_exp(-o/40),m=r*m+(1-r)*(n-s)/o)),f}},SDSVGZoomContainer=SD.SVGZoomContainer=function(e){this.update=function(t){e.setAttribute("viewBox",[t.x,t.y,t.width,t.height].join(" "))}},SDHTMLZoomContainer=SD.HTMLZoomContainer=function(e){var t,i,n=document.createElement("div"),o=n.style,r=1;!function(){var t;for(o.width="100%",o.height="100%",o.position="relative",e.appendChild(n);(t=e.firstChild)!==n;)n.appendChild(t)}(),this.setSizeRatio=function(e,n){r=e,e=100*e+"%",o.width=e,o.height=e,n&&void 0!==t&&this.update(t,i)},this.setLocation=function(e,t){var i=e.style;i.left=t.x*r+"px",i.top=t.y*r+"px",i.width=t.width*r+"px",i.height=t.height*r+"px"},this.update=function(e,o){t=e,i=o,SDElement_transform(n,-e.x*o,-e.y*o,o/r)},this.dispose=function(){var t;for(e.removeChild(n);t=n.firstChild;)e.appendChild(t)}},SDCanvasZoomContainer=SD.CanvasZoomContainer=function(e){var t=e.getContext("2d");this.update=function(i){var n=e.width,o=e.height,r=n/i.width;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,n,o),t.setTransform(r,0,0,r,-i.x*r,-i.y*r)}},SDViewport=SD.Viewport=function(e,t,i){function n(){SDEventManager.call(L),L.resizeContent(t),L.goHome(!0),L.update(),F&&SDTimer.register(L.update,H)}function o(e){return Math.pow(2,e)}function r(e,t){var i=e.x,n=e.y,o=SDMath_clamp(i,t.x,t.x+t.width),r=SDMath_clamp(n,t.y,t.y+t.height);return i===o&&n===r?e:new SDPoint(o,r)}function a(e){var t=L.getWidthZoom(e),i=p/t,n=i/z,o=(L.visibilityRatio-.5)*i,r=(L.visibilityRatio-.5)*n,a=p-2*o,s=f-2*r;return a<0&&(o+=.5*a,a=0),s<0&&(r+=.5*s,s=0),new SDRect(o,r,a,s)}function s(){var e=R.getCurrent(),t=R.getTarget();w=e,y=t,S=o(e),D=o(t),_=S*v,b=D*v;var i=SDMath_log2(L.minZoom),n=SDMath_log2(L.maxZoom);T=(w-i)/(n-i)*100,x=(y-i)/(n-i)*100}function l(t){var i=new SDPoint(C.getCurrent(),N.getCurrent()),n=new SDPoint(C.getTarget(),N.getTarget());if(t)return i;if(!B)return n;var o=L.getWidthZoom(),r=p/o,a=r/z,s=new SDRect(i.x-r/2,i.y-a/2,r,a),l=L.pixelFromPoint(B,!0),c=B.minus(s.getTopLeft()).times(e.x/s.width),u=c.minus(l),h=u.divide(e.x/p*o);
return n.plus(h)}function c(e){var t=L.getCenter(e),i=p/L.getWidthZoom(e),n=i/z;return new SDRect(t.x-i/2,t.y-n/2,i,n)}function u(){V=!1,s(),k=l(!0),M=c(!0),E=l(),P=c()}function h(e){return new SDRect(e.x,e.y,e.width,e.height)}function d(e){return new SDPoint(e.x,e.y)}e=new SDPoint(e.x,e.y),i=i||{};var m,f,p,g,v,S,D,w,y,_,b,T,x,k,E,M,P,L=this,I=i.panSpringOptions||{animationTime:.35},C=new SDSpring(I),N=new SDSpring(I),R=new SDSpring(i.zoomSpringOptions),B=null,z=e.x/e.y,O=i.wrapHorizontal||!1,A=i.wrapVertical||!1,F=i.selfUpdating!==!1,H={},V=!0;this.maxZoom="number"==typeof i.maxZoom?i.maxZoom:2,this.minZoom="number"==typeof i.minZoom?i.minZoom:.8,this.visibilityRatio="number"==typeof i.visibilityRatio?i.visibilityRatio:.8,this.getContainerSize=function(){return d(e)},this.getBounds=function(e){return V&&u(),h(e?M:P)},this.getCenter=function(e){return V&&u(),d(e?k:E)},this.getZoom=function(e){return V&&u(),e?S:D},this.getExpZoom=function(e){return V&&u(),e?w:y},this.getWidthZoom=function(e){return V&&u(),e?_:b},this.getZoomPercent=function(e){return V&&u(),e?T:x},this.applyConstraints=function(e){var t=L.getZoom(),i=SDMath_clamp(t,L.minZoom,L.maxZoom);t!==i&&L.zoomTo(i,B,e),i*=v;var n=L.getCenter(),o=r(n,a());if(O&&(o.x=n.x),A&&(o.y=n.y),!n.equals(o)){var s=p/i,l=s/z;L.fitBounds(new SDRect(o.x-.5*s,o.y-.5*l,s,l),e)}},this.fitBounds=function(t,i){var n=z,o=t.getCenter(),r=new SDRect(t.x,t.y,t.width,t.height);r.getAspectRatio()>=n?(r.height=t.width/n,r.y=o.y-r.height/2):(r.width=t.height*n,r.x=o.x-r.width/2),L.panTo(L.getCenter(!0),!0),L.zoomTo(L.getZoom(!0),null,!0);var a=L.getBounds(),s=L.getWidthZoom(),l=p/r.width;if(1.000001*l>s&&.999999*l<s)return void L.panTo(o,i);var c=a.getTopLeft().times(e.x/a.width).minus(r.getTopLeft().times(e.x/r.width)).divide(e.x/a.width-e.x/r.width);L.zoomTo(l/v,c,i)},this.goHome=function(e){var t=L.getCenter();O&&(t.x=(p+t.x%p)%p,C.resetTo(t.x),C.update()),A&&(t.y=(f+t.y%f)%f,N.resetTo(t.y),N.update()),L.fitBounds(g,e)},this.panBy=function(e,t){L.panTo(L.getCenter().plus(e),t)},this.panTo=function(t,i){if(i)return C.resetTo(t.x),N.resetTo(t.y),void(V=!0);if(!B)return C.springTo(t.x),N.springTo(t.y),void(V=!0);var n=L.getWidthZoom(),o=p/n,r=o/z,a=new SDRect(C.getCurrent()-o/2,N.getCurrent()-r/2,o,r),s=L.pixelFromPoint(B,!0),l=B.minus(a.getTopLeft()).times(e.x/a.width),c=l.minus(s),u=c.divide(e.x/p*n),h=t.minus(u);C.springTo(h.x),N.springTo(h.y),V=!0},this.zoomBy=function(e,t,i){L.zoomTo(L.getZoom()*e,t,i)},this.zoomTo=function(e,t,i){i?R.resetTo(SDMath_log2(e)):R.springTo(SDMath_log2(e)),B=t instanceof SDPoint?t:null,V=!0},this.toss=function(){C.toss(),N.toss()},this.resize=function(t,i){var n=L.getBounds(),o=n,r=t.x/e.x;e=new SDPoint(t.x,t.y),z=e.x/e.y,v=z>m?m/z:1,i&&(o.width=n.width*r,o.height=o.width/z),L.fitBounds(o,!0)},this.resizeContent=function(e){var i;i=L.getBounds(),t=e,m=t.x/t.y,f=t.y,p=t.x,g=new SDRect(0,0,p,f),v=z>m?m/z:1,V=!0,L.fitBounds(i,!0)},this.zoomToPercent=function(e,t){var i=SDMath_log2(L.minZoom);L.zoomTo(o(e*(SDMath_log2(L.maxZoom)-i)/100+i),null,t)},this.update=function(e,t){var i,n,o=C.getCurrent(),r=N.getCurrent(),a=R.getCurrent();if(t=t||(new Date).getTime(),B&&(i=L.pixelFromPoint(B,!0)),R.update(t),V=!0,B&&R.getCurrent()!==a){var s=L.pixelFromPoint(B,!0),l=s.minus(i),c=L.deltaPointsFromPixels(l,!0);C.shiftBy(c.x),N.shiftBy(c.y)}else B=null;n=C.update(t),n=N.update(t)||n,V=!0,n&&L.applyConstraints();var u=C.getCurrent()!==o||N.getCurrent()!==r||R.getCurrent()!==a;return u&&L.trigger("change",L),u||e===H},this.deltaPixelsFromPoints=function(t,i){return t.times(e.x/p*L.getWidthZoom(i))},this.deltaPointsFromPixels=function(t,i){return t.divide(e.x/p*L.getWidthZoom(i))},this.pixelFromPoint=function(t,i){var n=L.getBounds(i);return t.minus(n.getTopLeft()).times(e.x/n.width)},this.pointFromPixel=function(t,i){var n=L.getBounds(i);return t.divide(e.x/n.width).plus(n.getTopLeft())},this.rectPixelsFromPoints=function(t,i,n){var o=L.getBounds(i),r=e.x/o.width;return new SDRect((t.x-o.x)*r-(n?e.x/2:0),(t.y-o.y)*r-(n?e.y/2:0),t.width*r,t.height*r)},n()},SDViewer=SD.Viewer=function(e,t){function i(e,t){var i=e>1;h.zoomBy(e,i&&b.zoomInToPoint||!i&&b.zoomOutToPoint?h.pointFromPixel(t.minus(new SDPoint(b.padding.left,b.padding.top)),!0):null),h.applyConstraints()}function n(e){var t,i,n,o=0,r=0,a=0,s=0;for(t in e)if(e.hasOwnProperty(t)){++o,n=e[t],a+=n.x,s+=n.y;for(i in e)e.hasOwnProperty(i)&&i!==t&&(r+=n.distanceTo(e[i]))}return{center:new SDPoint(a/o,s/o),size:r/o/(o-1)}}function o(e,t,n,o,r,a){if(o&&b.isZoomable&&!a){var s=b.zoomPerClick,l=r?1/s:s;i(l,n)}}function r(e,t,i){if(T[t]=x[t]=i,++P,m=h.getCenter(),P>1){var o=n(T);i=o.center,v=i,S=o.size,D=h.getZoom(),w=h.pointFromPixel(i.minus(new SDPoint(b.padding.left,b.padding.top)),!0)}}function a(e,t,i,o){x[t]=i;var r,a=-1;if(P>1){var s=n(x);i=s.center,a=s.size,r=v}else r=T[t];if(b.isZoomable&&a>=0){var l=a/S,c=l*D;h.zoomTo(c,void 0,!0);var u=h.deltaPointsFromPixels(i.minus(r)).times(l),d=m.minus(u).minus(w).divide(l).plus(w);h.panTo(d,!0),h.applyConstraints()}else if(b.isPannable){var f=i.minus(r),p=h.deltaPointsFromPixels(f.negate(),!0);h.panTo(m.plus(p)),b.constrainDuringPan&&h.applyConstraints();var y=b.dragCursor;E&&!g&&y&&(g=!0,k.cursor=y)}}function s(e,t,i,n){if(n)if(--P,delete x[t],delete T[t],P){if(1===P){for(t in x)if(x.hasOwnProperty(t))break;T[t]=x[t],m=h.getCenter(),y=!0}}else b.useMomentum&&!y&&h.toss(),y=!1,h.applyConstraints();g&&(g=!1,k.cursor="")}function l(e,t,n){if(b.isZoomable){var o=Math.pow(b.zoomPerScroll,n);i(o,t)}}function c(){b.ignoreChange||b.redraw()}function u(e,t){return new SDPoint(SDMath_max(e-b.padding.right-b.padding.left,1),SDMath_max(t-b.padding.top-b.padding.bottom,1))}t=t||{};var h,d,m,f,p,g,v,S,D,w,y,_,b=this,T={},x={},k=document.documentElement.style,E=!window.opera,M=0,P=0;b.zoomPerClick=2,b.zoomPerScroll=Math.pow(2,1/3),b.zoomInToPoint=!0,b.zoomOutToPoint=!0,b.isPannable=!0,b.isZoomable=!0,b.constrainDuringPan=!1,b.ignoreChange=!1,b.useMomentum=!0,b.dragCursor="move",b.padding={top:0,right:0,bottom:0,left:0},SDObject_extend(b,t),function(){f=SDMath_max(e.clientWidth,1),p=SDMath_max(e.clientHeight,1);var i,n,o=new SDPoint(f,p),r=b.contentSize||o.times(1);if(!b.zoomContainers){if(window.SVGSVGElement&&e instanceof SVGSVGElement){var a=SDElement_getStyle(e);o=new SDPoint(parseFloat(a.width),parseFloat(a.height)),b.contentSize||(r=new SDPoint(e.viewBox.baseVal.width,e.viewBox.baseVal.height),0===r.x&&0===r.y&&(r=new SDPoint(e.width.baseVal.value,e.height.baseVal.value))),i=new SDSVGZoomContainer(e)}else window.HTMLCanvasElement&&e instanceof HTMLCanvasElement?(b.contentSize||(r=new SDPoint(e.width,e.height)),i=new SDCanvasZoomContainer(e)):i=new SDHTMLZoomContainer(e);b.zoomContainers=[i]}n=u(o.x,o.y),r.x*=n.x/o.x,r.y*=n.y/o.y,h=new SDViewport(n,r,t.viewportOptions),SDEventManager.call(b),e.style.msTouchAction="none"}(),d=new SDMouseTracker(e),d.addListener("click",o),d.addListener("press",r),d.addListener("drag",a),d.addListener("release",s),d.addListener("scroll",l),d.setTracking(!0),h.addListener("change",c),_=SDTimer.register(function(){if(M=(M+1)%30,0===M){var t=SDMath_max(e.clientWidth,1),i=SDMath_max(e.clientHeight,1);t===f&&i===p||(f=t,p=i,h.resize(u(t,i),!0),b.trigger("resize",t,i))}return!0}),b.getBounds=function(e){var t=h.getBounds(e),i=h.getContainerSize();return t.x-=t.width*b.padding.left/i.x,t.y-=t.height*b.padding.top/i.y,t.width*=1+(b.padding.left+b.padding.right)/i.x,t.height*=1+(b.padding.top+b.padding.bottom)/i.y,t},b.redraw=function(){var e,t=b.getBounds(!0),i=h.getZoom(!0),n=b.zoomContainers;for(e=n.length-1;e>=0;e--)n[e].update(t,i)},b.dispose=function(e){if(SDTimer.unregister(_),!e){var t,i,n=b.zoomContainers,o=n.length;for(t=0;t<o;++t)i=n[t],i.dispose&&i.dispose()}},b.redraw(),b.viewport=h,b.tracker=d},Pivot=window.Pivot={},hasOwnProperty={}.hasOwnProperty,makeElement=function(e,t,i){var n=document.createElement(e);return t&&(n.className=t),i&&i.appendChild(n),n},addText=function(e,t){e.appendChild(document.createTextNode(t))},PivotNumber_epsilon=1e-5,PivotDate_getHalfMonth=function(e){return 1===e?15:16},PivotDate_months=["January","February","March","April","May","June","July","August","September","October","November","December"],PivotDate_minScale=-9,PivotDate_chooseDateScale=function(e,t){var i,n,o,r,a;return(i=t.getFullYear()-e.getFullYear())?Math.floor(Math.log(i)/Math.LN10):(r=t.getMonth(),r>e.getMonth()?-1:(n=t.getDate(),o=e.getDate(),a=PivotDate_getHalfMonth(r),o<a&&n>=a?-2:n>o?-3:(i=t.getHours()-e.getHours(),i>=12?-4:i?-5:(i=t.getMinutes()-e.getMinutes(),i>=15?-6:i?-7:(i=t.getSeconds()-e.getSeconds(),i>=5?-8:-9)))))},PivotDate_generateBuckets=function(e,t,i){function n(e,t,i){t&&(e=t+" to "+i,u.leftLabel=t,u.rightLabel=i),u.label=e}if(!(e<=t)||i<PivotDate_minScale)return[];void 0===i&&(i=PivotDate_chooseDateScale(e,t)),i>=0&&(i=Math.pow(10,i));var o,r,a,s,l,c,u,h,d,m=e.getFullYear(),f=0,p=1,g=0,v=0,S=0,D=0;switch(i){case-9:case-8:S=e.getSeconds();case-7:case-6:v=e.getMinutes();case-5:case-4:g=e.getHours();case-3:case-2:p=e.getDate();case-1:f=e.getMonth();break;default:m=Math.floor(m/i)*i}switch(i){case-8:S=5*Math.floor(S/5);break;case-6:v=15*Math.floor(v/15);break;case-4:g=12*Math.floor(g/12);break;case-2:o=PivotDate_getHalfMonth(f),p=p>=o?o:1}switch(e=new Date(m,f,p,g,v,S,D),i){case-9:r=function(e){return new Date(m,f,p,g,v,S+e,0)};break;case-8:r=function(e){return new Date(m,f,p,g,v,S+5*e,0)};break;case-7:r=function(e){return new Date(m,f,p,g,v+e,0,0)};break;case-6:r=function(e){return new Date(m,f,p,g,v+15*e,0,0)};break;case-5:r=function(e){return new Date(m,f,p,g+e,0,0,0)};break;case-4:r=function(e){return new Date(m,f,p,g+12*e,0,0,0)};break;case-3:r=function(e){return new Date(m,f,p+e,0,0,0,0)};break;case-2:r=function(e){p>1&&e++;var t=new Date(m,f+Math.floor(e/2),1,0,0,0,0);return e%2&&t.setDate(PivotDate_getHalfMonth(t.getMonth())),t};break;case-1:r=function(e){return new Date(m,f+e,1,0,0,0,0)};break;default:r=function(e){return new Date(m+e*i,0,1,0,0,0,0)}}switch(i){case-9:case-8:case-7:case-6:case-5:case-4:h=function(){var e,t,i=l.getDate();d===i?e="":(e=l.toLocaleDateString()+" ",d=i),e+=l.toLocaleTimeString(),t=d===c.getDate()?"":c.toLocaleDateString()+" ",t+=c.toLocaleTimeString(),n(void 0,e,t)};break;case-3:h=function(){n(l.toLocaleDateString())};break;case-2:h=function(){n(void 0,l.toLocaleDateString(),c.toLocaleDateString())};break;case-1:h=function(){var e=l.getFullYear(),t=PivotDate_months[l.getMonth()];d!==e&&(d=e,t+=" "+e),n(t)};break;case 1:h=function(){n(l.getFullYear())};break;default:h=function(){n(Math.floor(l.getFullYear()/i)*i+"s")}}a=[],s=0,c=e;do s++,l=c,c=r(s),u={lowerBound:l,upperBound:c,items:[]},h(),a.push(u);while(c<=t);return a},PivotDatePicker=function(e,t,i,n){function o(e){var t=e.target;t.checked?(n.push(t.filterInfo),p.trigger("filter",i,n)):(n.splice(n.indexOf(t.filterInfo),1),p.trigger("filter",i,n.length?n:void 0))}function r(e){var t=e.target.filterInfo;n.forEach(function(e){e.checkBox.checked=!1}),t.checkBox.checked=!0,n=[t],p.trigger("filter",i,n)}function a(e){var t,i,a,s,l;t=makeElement("li",null,d),i=makeElement("input","pivot pivot_facetcheckbox",t),i.setAttribute("type","checkbox"),n&&n.some(function(t,i){return t.lowerBound.getTime()===e.lowerBound.getTime()&&t.upperBound.getTime()===e.upperBound.getTime()&&(n[i]=e,!0)})&&(i.checked=!0),e.checkBox=i,i.onclick=o,a=makeElement("div","pivot_outerlabel",t),a.onclick=r,s=makeElement("div","pivot_facetcount",a),addText(s,e.count),l=makeElement("div","pivot_facetlabel",a),addText(l,e.label),t.title=e.label,l.filterInfo=s.filterInfo=i.filterInfo=a.filterInfo=e}var s,l,c,u,h,d,m=1/0,f=-(1/0),p=this;return n=n||[],Seadragon2.EventManager.call(p),t.forEach(function(e){var t=e.facets[i];t&&t.forEach(function(e){e>f&&(f=e),e<m&&(m=e)})}),m===1/0?(l=makeElement("div","pivot_numberlabel",e),addText(l,"Not Currently Applicable"),this):(s=PivotDate_chooseDateScale(m,f),c=PivotDate_generateBuckets(m,f,s),u=PivotDate_generateBuckets(m,f,s-1),h=c.concat(u),h.forEach(function(e){e.count=0}),t.forEach(function(e){var t=e.facets[i];t&&t.forEach(function(e){h.forEach(function(t){e>=t.lowerBound&&e<t.upperBound&&t.count++})})}),d=makeElement("ul","pivot",e),c.forEach(a),makeElement("li","pivot_horizbar",d),void u.forEach(a))},templateRegex=/<\?(?:\??[^>]+)*\?>/g,makeTemplate=function(template,item,parent){var result,inputString=template.template,outputChunks=[],outputString,lastIndex=0,curIndex,matchString,matchLength,evalResult,type=template.type,img,doPaint;if("html"!==type&&"fakehtml"!==type||(parent?(parent.innerHTML="",result=parent):result=makeElement("div","pivot_item"),result.style.width=template.width+"px",result.style.height=(template.height||template.width)+"px"),"canvas"===type)result="function"==typeof inputString?inputString:new Function("ctx","x","y","w","h","item",inputString);else{for(;matchString=templateRegex.exec(inputString);){matchString=matchString[0],curIndex=templateRegex.lastIndex,matchLength=matchString.length,outputChunks.push(inputString.substring(lastIndex,curIndex-matchLength)),matchString=matchString.substring(2,matchLength-2);try{!function(){with(item)evalResult=eval(matchString)}(),"number"==typeof evalResult?evalResult=PivotNumber_format(evalResult):evalResult instanceof Date&&(evalResult=evalResult.toLocaleString()),outputChunks.push(evalResult)}catch(e){Seadragon2.Debug.warn("Error caught in filling template: "+e.message||e)}lastIndex=curIndex}outputChunks.push(inputString.substring(lastIndex,inputString.length)),outputString=outputChunks.join(""),"html"===type||"fakehtml"===type?result.unsetHTML=outputChunks.join(""):"color"===type?result=function(e,t,i,n,o){return e.fillStyle=outputString,e.fillRect(t,i,n,o),!0}:"img"===type&&(img=makeElement("img"),img.onload=function(){doPaint=!0},img.unsetSrc=outputString,result=function(e,t,i,n,o){var r=img.unsetSrc;return r&&(img.src=img.unsetSrc,delete img.unsetSrc),doPaint&&e.drawImage(img,t,i,n,o),doPaint})}return result},Button=function(e,t,i,n){this.htmlElement=makeElement(e,t,i),this.htmlElement.title=n};Button.prototype.select=function(){this.htmlElement.className=this.htmlElement.className.replace(" pivot_hoverable","")+" pivot_activesort"},Button.prototype.deselect=function(){this.htmlElement.className=this.htmlElement.className.replace(" pivot_activesort","")+" pivot_hoverable"};var BaseView=function(e,t){this.isSelected=t,this.container=e};BaseView.prototype.createView=function(e){},BaseView.prototype.select=function(){this.isSelected=!0,this.onSelected()},BaseView.prototype.deselect=function(){this.isSelected=!1},BaseView.prototype.onSelected=function(){},BaseView.prototype.onClick=function(e){},BaseView.prototype.update=function(e){};var GridView=function(e,t){BaseView.call(this,e,t)};GridView.prototype=Object.create(BaseView.prototype),GridView.prototype.constructor=GridView,GridView.prototype.createView=function(e){e.mapLayer.style="visibility: hidden;",this.container.allSortedItems=this.container.activeItemsArr;var t=this;this.container.allSortedItems.sort(function(e,i){if(e=e.facets[t.container.sortFacet],i=i.facets[t.container.sortFacet],!e)return i?1:0;if(!i)return-1;e=e[0],i=i[0];var n=t.container.facet.comparator||t.container.comparators[t.container.facet.type];return n(e,i)}),this.container.totalItemCount=this.container.allSortedItems.length,this.container.numPerRow=this.container.computeLayoutWidth(this.container.totalItemCount,this.container.containerRect.width,this.container.containerRect.height,this.container.avgHeight),this.container.widthPerItem=this.container.containerRect.width/this.container.numPerRow,this.container.numPerRow>this.container.totalItemCount&&(this.container.widthPerItem=Math.min(this.container.containerRect.width/this.container.totalItemCount,this.container.containerRect.height/this.container.avgHeight));var i=this.container.placeGrid(0,0,this.container.allSortedItems,this.container.numPerRow,this.container.widthPerItem,this.container.widthPerItem*this.container.avgHeight);this.container.finalItemWidth=i.itemWidth,this.container.topLeftItemInfo=i.topLeft,this.container.rightmostItemInfo=i.rightmost};var GraphView=function(e,t){BaseView.call(this,e,t)};GraphView.prototype=Object.create(BaseView.prototype),GraphView.prototype.constructor=GraphView,GraphView.prototype.createView=function(e){e.mapLayer.style="visibility: hidden;",this.container.allSortedItems=this.container.bucketize[this.container.facet.type||"String"](this.container.sortFacet);var t=this.container.containerRect.width/this.container.allSortedItems.length,n=.86*t;this.container.bars=[],this.container.topLeftItemInfo=this.container.rightmostItemInfo=void 0;var o,r=0;for(i=0;i<this.container.allSortedItems.length;i++)o=this.container.allSortedItems[i],o.items.length>r&&(r=o.items.length);var a=100/t;if(this.container.backZoomContainer.setSizeRatio(a),this.container.barTemplate.style.height=a*this.container.containerRect.height+"px",35/a>70){var s=Math.max(5,Math.round(70*a));this.container.barTemplate.firstChild.style.bottom=s+7+"px",this.container.barTemplate.lastChild.style.height=s+"px",this.container.barTemplate.style.fontSize=s/2+"px",this.container.containerRect.height-=(s+13)/100*t}else this.container.barTemplate.firstChild.style.bottom="",this.container.barTemplate.lastChild.style.height="",this.container.barTemplate.style.fontSize="",this.container.containerRect.height-=.48*t;var l=this.container.containerRect.height-.06*t;this.container.numPerRow=this.container.computeLayoutWidth(r,n,l,this.container.avgHeight),this.container.widthPerItem=n/this.container.numPerRow;var c,u,h,d,m;for(i=0;i<this.container.allSortedItems.length;i++){var f=t*(i+.07);o=this.container.allSortedItems[i],this.container.totalItemCount=o.items.length;var p=this.container.clone(this.container.barTemplate);p.style.left=100*i+1+"px";var g=p.firstChild,v=g.firstChild,S=g.nextSibling;if(e.backLayer.appendChild(p),o.leftLabel){var D=makeElement("div","pivot_leftlabel",S);addText(D,o.leftLabel),c?(c.parentNode.removeChild(c),D.style.left=-D.offsetWidth/2+"px",D.style.textAlign="center"):D.style.width="50%";var w=makeElement("div","pivot_rightlabel",S);addText(w,o.rightLabel),c=w}else addText(S,o.label),c=void 0;if(this.container.totalItemCount<this.container.numPerRow&&this.container.totalItemCount>0){var y=86*this.container.totalItemCount/this.container.numPerRow;f=t*i+(100-y)/2*t/100,y+=4,y=2*Math.round(y/2),v.style.width=y+"px",v.style.left=(98-y)/2+"px"}u=this.container.placeGrid(this.container.containerRect.height,f,o.items,this.container.numPerRow,this.container.widthPerItem,this.container.widthPerItem*this.container.avgHeight,!0),this.container.finalItemWidth=u.itemWidth,this.container.topLeftItemInfo||(this.container.topLeftItemInfo=u.topLeft),u.rightmost&&(this.container.rightmostItemInfo=u.rightmost),h&&(d=h.lowest,m=u.topLeft,d&&m&&(d.item.destination[d.index].down=m,m.item.destination[m.index].up=d),d&&!u.lowest&&(u.lowest=d),d=h.rightmost,d&&m&&(d.item.destination[d.index].right=m,m.item.destination[m.index].left=d),d&&!u.rightmost&&(u.rightmost=d)),h=u,v.style.height=Math.round(100*Math.ceil(o.items.length/this.container.numPerRow)*this.container.widthPerItem*this.container.avgHeight/t+4)+"px";var _;switch(this.container.facets[this.container.sortFacet].type){case"String":case"Link":_=o.values;break;case"Number":case"DateTime":_=[{lowerBound:o.lowerBound,upperBound:o.upperBound,inclusive:o.inclusive}];break;default:Seadragon2.Debug.warn("Unrecognized category type: "+this.container.facets[optins.sortFacet].type)}this.container.bars.push({bar:p,values:_,min:t*i,name:o.label,count:this.container.totalItemCount})}},GraphView.prototype.update=function(e){var t;if(this.container.lastMousePosition)for(t=this.container.bars.length,i=0;i<t&&this.container.bars[i].min<=this.container.contentMousePosition.x;i++)this.container.hoveredBar=this.container.bars[i];this.container.hoveredBar&&!this.container.hoveredBar.count&&(this.container.hoveredBar=void 0),this.container.hoveredBar!==this.container.lastHoveredBar&&(this.container.hoveredBar?(this.container.hoveredBar.bar.className="pivot_bar pivot_highlight",e.container.title=this.container.hoveredBar.name):e.container.title="",this.container.lastHoveredBar&&(this.container.lastHoveredBar.bar.className="pivot_bar"))},GraphView.prototype.onClick=function(e){var t;for(t=this.container.bars.length,i=0;i<t&&this.container.bars[i].min<=this.container.position.x;i++)this.container.hoveredBar=this.container.bars[i];this.container.hoveredBar&&!this.container.hoveredBar.count&&(this.container.hoveredBar=void 0)};var MapView=function(e,t){BaseView.call(this,e,t)};MapView.prototype=Object.create(BaseView.prototype),MapView.prototype.constructor=MapView,MapView.prototype.createView=function(e){function t(){var e=window.innerWidth-220,t=window.innerHeight-41;n.style="width: "+e+"px; height:"+t+"px; position: relative; margin-left: 215px; margin-top: 6px;"}function i(e){var t=u.getCenter();"undefined"!=typeof e.layer.options.crs?u.setCrs(e.layer.options.crs):u.setCrs(L.CRS.EPSG3857),u.setView(t,u.getZoom())}if(e.mapLayer.style="visibility: visible;",null==this.map){var n=makeElement("div","",e.mapLayer);t(),window.addEventListener("optimizedResize",function(){t()});var o=L.tileLayer("http://mt{s}.google.com/vt/lyrs=m&z={z}&x={x}&y={y}&lang=ru_RU",{subdomains:["0","1","2","3"],attribution:'<a http="google.ru" target="_blank">Google</a>',reuseTiles:!0,updateWhenIdle:!1}),r=L.tileLayer("http://mt{s}.google.com/vt/lyrs=y&z={z}&x={x}&y={y}&lang=ru_RU",{subdomains:["0","1","2","3"],attribution:'<a http="google.ru" target="_blank">Google</a>',reuseTiles:!0,updateWhenIdle:!1}),a=L.tileLayer("http://a.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'<a http="google.ru" target="_blank">Open Streets</a>',reuseTiles:!0,updateWhenIdle:!1}),s=new L.Yandex,l=new L.Yandex("null",{traffic:!0,opacity:1,overlay:!1}),c=new L.Yandex("hybrid"),u=(new L.Yandex("publicMap"),L.map(n,{layers:[s]}).setView([0,0],2));L.Map.prototype.setCrs=function(e){this.options.crs=e};var h={"Яндекс":s,"Яндекс спутник":c,"Яндекс пробки":l,Google:o,"Google спутник":r,"Open Streets":a};u.on("baselayerchange",i),L.control.layers(h,null,{position:"bottomright"}).addTo(u),this.map=u;var d=[],m=[],f="",p="",g="",v=!0,S=!1,D=50,w=10,y="",_="Content/images/icon-point-gas.png",b="Content/images/icon-point-gas-inverted.png",T=[],x=function(e,t){var i=e;return null!=t[0]&&void 0!=t[0]&&(i=i.replace("{LABEL}",t[0])),null!=t[1]&&void 0!=t[1]&&(i=i.replace("{HINT}",t[1])),null!=t[2]&&void 0!=t[2]&&(i=i.replace("{URL}",t[2])),null!=t[3]&&void 0!=t[3]&&Array.isArray(t[3])&&t[3].forEach(function(e,t){i=i.replace("{DIM"+t+"}",e)}),i},k=function(e,t){e.setIcon(new L.Icon({iconUrl:t,iconAnchor:[12,41],popupAnchor:[0,-41]}))},E=function(){for(var e=0;e<T.length;e++)k(T[e],_);T=[]},M=function(e,t){if("js"==t){var i=document.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src",y+e)}else if("css"==t){var i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.setAttribute("href",y+e)}"undefined"!=typeof i&&document.getElementsByTagName("head")[0].appendChild(i)};S?M("Content/MarkerCluster.Default.css","css"):M("Content/MarkerCluster.Redefined.css","css"),data.forEach(function(e){var t=e.LATITUDE,i=e.LONGITUDE,n=e.ORG_NAME,o=e.ORG_NAME;if("undefined"!=typeof t&&null!=t&&"undefined"!=typeof i&&null!=i){if(marker=new L.marker([t,i]),""!=p)marker.bindPopup(x(p,[n,o]));else if(""!=g){var r='<iframe style="width:300px;height:300px;" src="'+g+'" />"';marker.bindPopup(x(r,[n,o]))}else marker.bindPopup(o);k(marker,_),marker.options.dataRow=e,d.push(marker)}}),null!=this.markerLayer&&u.removeLayer(this.markerLayer),v&&d.length>=w?(this.markerLayer=L.markerClusterGroup(),this.markerLayer.options.maxClusterRadius=D):this.markerLayer=new L.featureGroup(d);for(var P=0;P<d.length;++P)if(""!=f){var I=void 0;void 0!=d[P]._popup&&(I=d[P]._popup._content);var C=L.marker([d[P]._latlng.lat,d[P]._latlng.lng],{dataRow:d[P].options.dataRow});void 0!=I&&C.bindPopup(I),k(C,_),this.markerLayer.addLayer(C),m.push(C)}else this.markerLayer.addLayer(d[P]);u.addLayer(this.markerLayer),d.length>0&&setTimeout(function(){u.fitBounds(this.markerLayer.getBounds())}.bind(this),100),0==d.length&&u.setView([0,0],2),this.markerLayer.on("click",function(e){var t=e.layer;E(),k(t,b),T.push(t)}),this.markerLayer.on("mouseover",function(e){e.layer.openPopup()})}};var PivotViewer=Pivot.PivotViewer=function(e,t,i,n,o,r,a,s){function l(){$={},X.activeItemsArr=[],U.forEach(function(e){ae.every(function(t){return t(e)})&&($[e.id]=e,X.activeItemsArr.push(e))})}function c(e,t){if(!t||t<0)if(Me){var i=Me;Me=function(){i(),e()}}else Me=e;else c(function(){c(e,t-1)})}function u(e){var t,i,n,o=G.getContainerSize(),r=o.times(.5),a=o.x+o.y,s=[],l=e.length;for(i=0;i<l;i++)n=e[i],t=n.getCenter().minus(r),t=t.times(a/t.distanceTo(Se)),s.push(new Seadragon2.Rect(t.x-100,t.y-100,1.2*n.width,1.2*n.height));return s}function h(e){var t=e.unsetHTML;t&&(e.innerHTML=t,delete e.unsetHTML),i.appendChild(e)}function d(e){var t,i,n=!1,o=e.source,r=e.destination,a=o.length,s=e.startTime=[],l=e.id,c=G.getContainerSize(),u=c.x/2,h=c.y/2,d=e.sdimg[Ee];for(t=0;t<a;t++)i=r[t],o[t].equals(i)||(n=!0,s[t]=300*Math.random()+ie,hasOwnProperty.call(K,l)||te.push(e),K[l]=e,d&&d.update(new Seadragon2.Rect(i.x-u,i.y-h,i.width,i.height)));return n}function m(){var e,t,n,o,r,a,s,l,c;for(c=te.length-1;c>=0;c--){for(o={},e=te[c],a=e.source=[],s=e.destination,e.destination=void 0,l=s.length,r=0;r<l;r++)t=s[r],n=t.toString(),o.hasOwnProperty(n)||(o[n]=!0,a.push(t));l=a.length,e.html.forEach(function(e,t){if("html"===Te[t].type){var n=e.splice(l,e.length-l);t===Ee&&n.forEach(function(e){i.removeChild(e),e.pvInDom=!1})}})}K={},te=[]}function f(e,t){we(e,ke*t.x,ke*t.y,t.width/xe*ke)}function p(){X.removeListener("animationfinish",p),q.setTracking(!0),Y=!1,m(),X.trigger("finishedRearrange"),U.length||X.activeItemsArr.length||X.trigger("itemsCleared")}function g(){X.removeListener("animationfinish",g),m();var e,t,i,n=!1;for(i=X.activeItemsArr.length-1;i>=0;i--)t=X.activeItemsArr[i],e=t.id,hasOwnProperty.call(J,e)||(t.source=u(t.destination),d(t),Q[e]=t,n=!0,t.html.forEach(function(e,i){if("html"===Te[i].type){var n;for(n=t.source.length-1;n>0;n--)e.push(X.clone(e[0]))}}),"html"===Te[Ee].type&&t.html[Ee].forEach(function(e,i){f(e,t.source[i]),h(e),e.pvInDom=!0}));n?X.addListener("animationfinish",p):p()}function v(){X.removeListener("animationfinish",v);var e,t,n,o,r,a,s,l,c=!1;if("html"===Te[Ee].type)for(s=te.length-1;s>=0;s--)l=te[s].html[Ee],l.forEach(function(e){i.removeChild(e),e.pvInDom=!1}),l.splice(1,l.length-1);m(),X.finalItemWidth&&Te.length&&_(1);for(e in J)if(hasOwnProperty.call(J,e)&&hasOwnProperty.call($,e)){for(t=J[e],n=t.source,o=t.destination,r=n.length,a=o.length,l=t.html,s=r;s<a;s++)n.push(n[0]),l.forEach(function(e,t){if("html"===Te[t].type){var i=e[0],o=X.clone(i);e.push(o),t===Ee&&(f(o,n[0]),h(o),o.pvInDom=!0)}});for(s=a;s<r;s++)o.push(o[0]);d(t)&&(c=!0)}c?X.addListener("animationfinish",g):g()}function S(){var e,t,i=!1;for(e in J)hasOwnProperty.call(J,e)&&!hasOwnProperty.call($,e)&&(i=!0,t=J[e],t.destination=u(t.source),d(t),delete Q[e]);i?X.addListener("animationfinish",v):v()}function D(e){var t=Math.floor(Math.log(e)/Math.LN10),i=e*Math.pow(10,-t),n=i<2.5?1:i<5?2.5:5;return n*Math.pow(10,t)}function w(){var e=U.reduce(function(e,t){var i=t.normHeight;return i||(i=t.normHeight=t.sdimg[-1].state.source.normHeight),e+Math.log(i)},1),t=Math.exp(e/U.length);return t=t<1?(t+2*ge)/(1+2*ge):(1+2*ge)/(1/t+2*ge)}function y(){var e;e=Pe.parentNode,e&&e.removeChild(Pe),e=Le.parentNode,e&&e.removeChild(Le)}function _(e,t){if(Te.length){var n,o,r=Ee;for(Ee=0;Te[Ee]&&Te[Ee].width<X.finalItemWidth*e;)Ee++;if(Ee>Te.length-1&&(Ee=Te.length-1),Ee!==r){if(xe=Te[Ee].width,y(),"html"===Te[r].type)for(n in Q)if(hasOwnProperty.call(Q,n)){o=Q[n];var a=o.html[r];a.forEach(function(e,t){e.pvInDom&&(e.pvInDom=!1,Be&&(a[t]=X.clone(e)))})}i.innerHTML=""}var s=ke;if(ke=xe/X.finalItemWidth,s!==ke&&(fe.setSizeRatio(ke,!t),"html"===Te[Ee].type))for(n in Q)hasOwnProperty.call(Q,n)&&(o=Q[n],o.html[Ee].forEach(function(e,i){var n=o.source[i];f(e,n),Ee===r||t&&!x(t,n)||(h(e),e.pvInDom=!0)}))}}function b(){X.removeListener("animationfinish",b),X.trigger("hideDetails"),X.trigger("hideInfoButton"),Y=!0,ye=!0,m(),J=Seadragon2.Object.clone(Q),l(),n.innerHTML="",X.avgHeight=w(),X.facet=X.facets[X.sortFacet]||{};var c=G.getContainerSize();X.containerRect=new Seadragon2.Rect(0,0,c.x,c.y);for(var u=X.activeItemsArr.length-1;u>=0;u--)X.activeItemsArr[u].destination=[];X.views.filter(function(e){return e.isSelected})[0].createView({canvas:e,container:t,frontLayer:i,backLayer:n,mapLayer:o,leftRailWidth:r,rightRailWidth:a,inputElmt:s}),Ee===-1&&X.finalItemWidth&&Te.length&&_(1),G.maxZoom=c.x/X.widthPerItem*2,S()}function T(){q.setTracking(!1),G.goHome(),ce=void 0,y(),j=!0,t.title="",X.clearListeners("animationfinish"),X.addListener("animationfinish",b)}function x(e,t){return t.x+t.width>e.x&&e.x+e.width>t.x&&t.y+t.height>e.y&&e.y+e.height>t.y}function k(e,t,i,n,o,r){var a,s;e?(a=e.source[t],"html"!==Te[Ee].type?(n.lineWidth=r,n.strokeStyle=i,n.strokeRect(a.x,a.y,a.width,a.height)):(s=e.html[Ee][t],s.appendChild(o),r=r*ke+"px",o.pvtop.style.height=o.pvright.style.width=o.pvbottom.style.height=o.pvleft.style.width=r)):Ee!==-1&&(s=o.parentNode,s&&s.removeChild(o))}function E(e,t,i,n,o,r){e.save();var a;try{a=r.canvas[Ee](e,t,i,n,o,r)}catch(s){}return e.restore(),a}function M(l,c){var u=G.getContainerSize();ie=c||(new Date).getTime();var d,m,p,g,v;if(Me){var S=Me;Me=void 0,S()}var D,w,y,b;if(Y){X.redraw(),D=Te[Ee].type,w="sdimg"===D||"fakehtml"===D,y="html"===D,b="canvas"===D||"color"===D||"img"===D;var T,M,P,L,I,C,N,R,B,z,O,A,F=!0;if(w||b)for(v=X.activeItemsArr.length-1;v>=0;v--)if(m=X.activeItemsArr[v],d=m.id,!hasOwnProperty.call(K,d)&&(P=m.source))for(g=m.sdimg[Ee],p=P.length-1;p>=0;p--)B=P[p],w&&g?De(re,g,B.x,B.y,B.width,B.height):E(re,B.x,B.y,B.width,B.height,m);for(v=te.length-1;v>=0;v--)for(m=te[v],P=m.source,L=m.destination,A=m.startTime,g=m.sdimg[Ee],p=P.length-1;p>=0;p--)B=P[p],z=L[p],O=A[p],T=void 0===O?1:Math.max((ie-O)/700,0),T>=1?(T=1,M=0):(F=!1,T=T<.5?(Math.exp(T*ne)-1)*oe:1-(Math.exp((1-T)*ne)-1)*oe,M=1-T),I=B.x*M+z.x*T,C=B.y*M+z.y*T,N=B.width*M+z.width*T,R=B.height*M+z.height*T,w&&g?De(re,g,I,C,N,R):y?f(m.html[Ee][p],new Seadragon2.Rect(I,C,N,R)):E(re,I,C,N,R,m);F&&X.trigger("animationfinish",X)}else{var H=G.update();if(!j&&H&&X.trigger("animationstart",X),ye=ye||H){ye=!1,se=void 0,X.lastHoveredBar=X.hoveredBar,X.hoveredBar=void 0;var V,Z,W,U,q,$,J,Q=1/0;V=X.getBounds(!0),_(G.getZoom(!0),V),D=Te[Ee].type,w="sdimg"===D||"fakehtml"===D,y="html"===D,b="canvas"===D||"color"===D||"img"===D,X.redraw(),Z=X.getBounds(),q=G.getZoomPercent(),X.trigger("zoom",q),X.lastMousePosition&&(X.contentMousePosition=G.pointFromPixel(X.lastMousePosition.minus(new Seadragon2.Point(X.padding.left,X.padding.top)),!0)),X.views.filter(function(e){return e.isSelected})[0].update({canvas:e,container:t,frontLayer:i,backLayer:n,mapLayer:o,leftRailWidth:r,rightRailWidth:a,inputElmt:s});var ee,ae,fe=.5*(u.x-a),pe=.5*u.y,ge=new Seadragon2.Point(-a/2,0);for(he=void 0,me=!1,v=X.activeItemsArr.length-1;v>=0;v--)for(m=X.activeItemsArr[v],ee=m.source,g=m.sdimg[Ee],p=ee.length-1;p>=0;p--)W=ee[p],W&&(x(V,W)?(x(Z,W)&&(U=G.rectPixelsFromPoints(W,!1,!0),w&&g&&g.update(U),(U.width>fe||U.height>pe)&&(me=!0),J=U.getCenter().distanceTo(ge),J<Q&&(Q=J,he=m,de=p,$=W)),w&&g?ye=!De(re,g,W.x,W.y,W.width,W.height)||ye:y?(ae=m.html[Ee][p],ae.pvInDom||(h(ae),ae.pvInDom=!0)):ye=!E(re,W.x,W.y,W.width,W.height,m)||ye,X.lastMousePosition&&W.contains(X.contentMousePosition)&&(se=m,le=p)):y&&(ae=m.html[Ee][p],ae.pvInDom&&(i.removeChild(ae),ae.pvInDom=!1)));var Se=G.deltaPointsFromPixels(new Seadragon2.Point(3,0)).x;
k(se,le,Ie,re,Pe,Se),he&&me?(ve?X.trigger("showDetails",he,X.facets):X.trigger("showInfoButton"),G.visibilityRatio=(u.x-a)/u.x):(ve?X.trigger("hideDetails"):X.trigger("hideInfoButton"),G.visibilityRatio=1),k(ce,ue,Ce,re,Le,Se)}j&&!H&&X.trigger("animationfinish",X),j=H}return!0}function P(){X.lastMousePosition=void 0,ye=!0}function L(e){e=e||window.event,X.lastMousePosition=Seadragon2.Mouse.getPosition(e).minus(Seadragon2.Element.getPosition(t)),ye=!0}function I(l,c,u,h,d,m){var f,p=(new Date).getTime();if(u){X.position=G.pointFromPixel(u.minus(new Seadragon2.Point(X.padding.left,X.padding.top)),!0);var g,v,S,D;for(X.views.filter(function(e){return e.isSelected})[0].onClick({canvas:e,container:t,frontLayer:i,backLayer:n,mapLayer:o,leftRailWidth:r,rightRailWidth:a,inputElmt:s}),v=X.activeItemsArr.length-1;v>=0;v--)for(D=X.activeItemsArr[v],S=D.source,g=S.length-1;g>=0;g--)f=S[g],f&&f.contains(X.position)&&(se=D,le=g)}if(!m&&h&&p-_e>be){if(!se||ce===se&&ue===le)!se&&X.hoveredBar?X.trigger("filterrequest",{facet:X.sortFacet,values:X.hoveredBar.values,type:X.facets[X.sortFacet].type}):(ce=void 0,G.goHome());else{ce=se,ue=le,f=se.source[le];var w,y=G.getContainerSize(),_=y.x,b=y.y,T=ve?_-a:_;w=Math.max((T/f.width*f.height/b*1.4-1)/2,.2),f=new Seadragon2.Rect(f.x-f.width*w,f.y,f.width*(1+2*w)*_/T,f.height),G.fitBounds(f)}_e=p}}function C(){s.focus()}function N(){var e=document.documentElement;pe=!1,e.className=e.className.replace(" pivot_move","")}function R(){pe||(pe=!0,document.documentElement.className+=" pivot_move"),ce=void 0}function B(){ce=void 0,s.focus()}function z(e){var t,i,n=e.keyCode;if(n>=37&&n<=40){if(G.getZoomPercent())switch(t=he.source[de],n){case 37:i=t.left;break;case 38:i=t.up;break;case 39:i=t.right;break;case 40:i=t.down}else switch(n){case 37:case 38:i=X.rightmostItemInfo;break;case 39:case 40:i=X.topLeftItemInfo}i&&(ce===i.item&&ue===i.index||(se=i.item,le=i.index,I(void 0,0,void 0,!0))),e.preventDefault&&e.preventDefault()}}function O(t,i){c(function(){e.width=t,e.height=i}),G.resizeContent(G.getContainerSize()),G.update(),T()}function A(e){var t,i,n,o,r=makeElement("div"),a=["top","right","bottom","left"];for(n=0;n<4;n++)for(t=r["pv"+a[n]]=makeElement("div",e,r),i=t.style,o=0;o<4;o++)n!==o&&(i[a[o]]="-1px");return r}function F(){X.backZoomContainer=new Seadragon2.HTMLZoomContainer(n),fe=new Seadragon2.HTMLZoomContainer(i),Seadragon2.Viewer.call(X,t,{constrainDuringPan:!0,ignoreChange:!0,viewportOptions:{minZoom:1,visibilityRatio:1,selfUpdating:!1},padding:{top:5,right:5,bottom:5,left:r+5},dragCursor:"",zoomContainers:[X.backZoomContainer,new Seadragon2.CanvasZoomContainer(e),fe]}),n=n.firstChild,i=i.firstChild,q=X.tracker,G=X.viewport,q.clearListeners("click"),q.addListener("exit",P),Seadragon2.Event.add(t,"mousemove",L,!1),q.addListener("click",I),q.addListener("press",C),q.addListener("release",N),q.addListener("drag",R),q.addListener("scroll",B),s.addEventListener("keydown",z,!1),X.addListener("resize",O),Seadragon2.Timer.register(M),X.barTemplate=makeElement("div","pivot_bar");var o;o=makeElement("div","pivot_outerbar",X.barTemplate),makeElement("div","pivot_innerbar",o),makeElement("div","pivot_barlabel",X.barTemplate),Pe=A("pivot_hoverborder"),Le=A("pivot_selectedborder"),i.appendChild(Pe),i.appendChild(Le),Ie=Seadragon2.Element.getStyle(Pe.pvtop).backgroundColor,Ce=Seadragon2.Element.getStyle(Le.pvtop).backgroundColor,i.removeChild(Pe),i.removeChild(Le)}function H(){var e;for(e in Oe)if(hasOwnProperty.call(Oe,e)){var t=Oe[e];!function(){var i=parseInt(e,10),n=t.level,o=t.items;Seadragon2.Xml.fetch(t.url,function(){var e;try{e=JSON.parse(X.responseText)}catch(t){return void Seadragon2.Debug.warn("Error in parsing JSON from content endpoint")}if(e.ready){delete Oe[i],Ae--,n===Ee.toString()&&(ye=!0);var r=e.dzi,a=r.url;a=a.substr(0,a.length-4)+"_files/";var s=r.width,l=r.height,c=r.tileSize,u=r.tileFormat,h=Math.min(Math.log(c)/Math.LN2,Math.ceil(Math.log(Math.max(s,l))/Math.LN2));o.forEach(function(e,t){var i=e.sdimg[n]=new Seadragon2.Image(Re);i.src=new Seadragon2.DzcTileSource(s,l,c,h,t,a,u,t),i.update()})}e.failed&&(delete Oe[i],Ae--)},function(){Seadragon2.Debug.warn("Received failure code from server-side renderer")})}()}Ae&&c(H,60)}function V(){var e,t,i,n,o,r,a=[].reduce;n={href:location.href,style:a.call(document.styleSheets,function(e,t){return e+a.call(t.cssRules,function(e,t){return e+t.cssText},"")},"")};for(t in ze)hasOwnProperty.call(ze,t)&&(i=ze[t],r=Te[t],e=r.renderer+"pivot/",n.width=r.width,n.height=r.height||r.width,n.items=i.map(function(e){return e.html[t][0].innerHTML}),o=JSON.stringify(n),o=lzwEncode(o),function(){var n=t,a=r.renderer,s=i;Seadragon2.Xml.fetch(e,function(){var e;try{e=JSON.parse(X.responseText)}catch(t){return void Seadragon2.Debug.warn("Failed to parse JSON response from server.")}Oe[Fe++]={level:n,url:a+"content/"+e.id,items:s},Ae++,1===Ae&&c(H,60)},function(){Seadragon2.Debug.warn("Failed to post collection data. Status text: "+X.statusText+"; response: "+X.responseText)},o)}());ze={},Ne=void 0}function Z(e){var t,i,n=e.html,o=e.html=[],r=e.canvas,a=e.canvas=[],s=e.sdimg,l=e.sdimg=[],u=!n;if(s&&(l[-1]=s[-1]),Te.forEach(function(h,d){switch(h.type){case"canvas":o.push([]),a.push(h.func),l.push(void 0);break;case"img":case"color":o.push([]),a.push(makeTemplate(h,e)),l.push(void 0);break;case"sdimg":o.push([]),a.push(void 0),l.push(l[-1]);break;case"fakehtml":u?(t=h.renderer,i=ze[d]=ze[d]||[],i.push(e),void 0===Ne&&(Ne=!0,c(V)),o.push([makeTemplate(h,e)]),a.push(makeTemplate(h.fallback||{type:"color",template:"gray"},e)),l.push(void 0)):(o.push(n[d]),a.push(r[d]),l.push(s[d]));break;case"html":n?(o.push(n[d]),n[d].forEach(function(t){makeTemplate(h,e,t)})):o.push([makeTemplate(h,e)]),a.push(void 0),l.push(void 0);break;default:Seadragon2.Debug.warn("updateTemplate: unrecognized template type")}}),Te.length){var h=Te[Te.length-1];e.normHeight=(h.height||h.width)/h.width}}function W(e,t){hasOwnProperty.call(e,t)?e[t]++:e[t]=1}var X=this;X.allSortedItems=void 0,X.facets={},X.facet={};var U=[];X.sortFacet="",X.numPerRow=void 0,X.widthPerItem=void 0,X.totalItemCount=void 0,X.containerRect=void 0,X.avgHeight=void 0,X.activeItemsArr=[];var q,G,j=!1,Y=!1,$={},J={},K={},Q={},ee={},te=[],ie=(new Date).getTime(),ne=8,oe=1/(2*(Math.exp(ne/2)-1)),re=e.getContext("2d"),ae=[];X.lastMousePosition=void 0,X.contentMousePosition=void 0,X.lastHoveredBar=void 0,X.position=void 0;var se,le,ce,ue,he,de;X.topLeftItemInfo=void 0,X.rightmostItemInfo=void 0;var me;X.hoveredBar=void 0,X.barTemplate=void 0,X.bars=[],X.backZoomContainer=void 0;var fe,pe,ge=.05,ve=!0,Se=new Seadragon2.Point(0,0),De=Seadragon2.Image.drawImage,we=Seadragon2.Element.transform,ye=!0,_e=0,be=300,Te=[];Te[-1]={type:"sdimg"};var xe,ke,Ee=-1;X.finalItemWidth=void 0;var Me,Pe,Le,Ie,Ce,Ne,Re={manualUpdates:!0},Be=function(){var e=makeElement("div"),t=makeElement("div");return t.innerHTML="a",e.appendChild(t),e.innerHTML="",!t.firstChild}(),ze={},Oe={},Ae=0,Fe=0;X.GridView=new GridView(X,(!0)),X.GraphView=new GraphView(X,(!1)),X.MapView=new MapView(X,(!1)),X.views=[X.GridView,X.GraphView,X.MapView],X.clone=function(e){var t=e.cloneNode(!0);return t.unsetHTML=e.unsetHTML,t},X.placeGrid=function(e,t,i,n,o,r,a){var s,l,c,u,h,d,m,f,p,g,v,S,D,w,y,_,b=i.length,T=0,x=[],k=[];for(a&&(e-=r),s=0;T<b;s++){for(m=Math.max(o,r)*ge/(1+2*ge),f=r-2*m,p=o-2*m,l=[],u=0;u<n&&T<b;u++)h=i[T],h.normHeight>f/p?(d=f/h.normHeight,c=new Seadragon2.Rect(t+(u+.5)*o-d/2,e+m,d,f)):(d=p*h.normHeight,c=new Seadragon2.Rect(t+u*o+m,e+.5*r-d/2,p,d)),h.destination.push(c),S={item:h,index:h.destination.length-1},l.push(S),T++,g=l[u-1]||!a&&k[k.length-1],g&&(c.left=g,g.item.destination[g.index].right=S),v=a?x:k,D=a?-1:0,g=v[u+D],g&&(c.up=g,g.item.destination[g.index].down=S),v=a?k:x,D=a?0:1,g=v[u+D],g&&(c.down=g,g.item.destination[g.index].up=S);a&&(g=k[0],g&&(c.right=g,g.item.destination[g.index].left=S)),c.down||(y=S),s||(x=l),k=l,e+=a?-r:r}return _=a?k[0]:x[0],a?(g=x[x.length-1],y=g,w=g):w=k[k.length-1],{topLeft:_,lowest:y,rightmost:w,itemWidth:p}},X.comparators={Number:function(e,t){return e-t},String:function(e,t){return e>t?1:e===t?0:-1},Link:function(e,t){return e=e.content,t=t.content,e>t?1:e===t?0:-1}},X.comparators.DateTime=X.comparators.Number,X.comparators.LongString=X.comparators.String,X.bucketize={String:function(e){function t(e){e=e.content||e,r=l[e],r||(r=l[e]={}),r[n]=i}var i,n,o,r,a,s,l={},c=[];for(s=X.activeItemsArr.length-1;s>=0;s--)i=X.activeItemsArr[s],n=i.id,o=i.facets[e],o?o.forEach(t):t("(no info)");for(a in l)hasOwnProperty.call(l,a)&&c.push({label:a,items:l[a],values:[a]});var u=X.facets[e].comparator||function(e,t){return e>t?1:e===t?0:-1};c.sort(function(e,t){var i=u(e.label,t.label);return i?i>0&&"(no info)"!==t.label||"(no info)"===e.label?1:-1:0});var h=Math.ceil(c.length/12);if(h>1){var d,m,f,p=[];c.forEach(function(e,t){if(t%h===0||"(no info)"===e.label)f={label:e.label},p.push(f),d=f.values=e.values,m=f.items=e.items;else{d.push(e.values[0]);var i,n=e.items;for(i in n)hasOwnProperty.call(n,i)&&(m[i]=n[i]);t%h!==h-1&&t!==c.length-1&&"(no info)"!==c[t+1].label||(f.label+=" to "+e.label)}}),c=p}return c.forEach(function(e){var t,i=[],n=e.items;for(t in n)hasOwnProperty.call(n,t)&&i.push(n[t]);e.items=i}),c},Number:function(e,t){function i(e){e>f&&(f=e),e<p&&(p=e)}var n,o,r,a,s,l,c,u,h,d,m,f=-(1/0),p=1/0,g=[];for(a=X.activeItemsArr.length-1;a>=0;a--)n=X.activeItemsArr[a],o=n.facets[e],o?o.forEach(i):s=!0;if(t)g=PivotDate_generateBuckets(p,f);else for(r=D((f-p)/4),r&&(p=r*Math.floor(p/r)),a=p;a<f||0===r&&!g.length;a+=r)u=a+r,h=PivotNumber_format(a),d=PivotNumber_format(u),g.push({label:h+" to "+d,lowerBound:a,upperBound:u,leftLabel:h,rightLabel:d,items:[]});for(g.length&&(c=g.length-1,g[c].inclusive=!0),s&&(l=[],g.push({label:"(no info)",items:l})),m=t?function(e){var t,i;for(t=0;t<=c;t++)if(i=g[t],e<i.upperBound||t===c){i.items.push(n);break}}:function(e){var t=Math.floor((e-p)/r);(isNaN(t)||t<0)&&(t=0),t>c&&(t=c),g[t].items.push(n)},a=X.activeItemsArr.length-1;a>=0;a--)n=X.activeItemsArr[a],o=n.facets[e],o?o.forEach(m):l.push(n);return g}},X.bucketize.LongString=X.bucketize.String,X.bucketize.Link=X.bucketize.String,X.bucketize.DateTime=function(e){return X.bucketize.Number(e,!0)},X.computeLayoutWidth=function(e,t,i,n){for(var o=Math.ceil(Math.sqrt(n*t*e/i));Math.ceil(e/o)*t/o*n>i;)o++;return o},X.showView=function(){T()};var He=function(){var e=0;return function(){var t;do t=(e++).toString();while(hasOwnProperty.call(ee,t));return t}}();X.zoomToPercent=function(e){G.zoomToPercent(e),G.applyConstraints()},X.moveLeft=function(){z({keyCode:37})},X.moveRight=function(){z({keyCode:39})},X.setCenterItem=function(e){if(!hasOwnProperty.call(ee,e))throw"setCenterItem: No matching ID found: "+e;if(!q.isTracking())throw"setCenterItem: Can't execute during rearrange.";if(!hasOwnProperty.call($,e))throw"setCenterItem: Item is currently not filtered in.";var t=ee[e];t!==ce&&(se=t,le=0,I(void 0,0,void 0,!0))},X.collapseDetails=function(){ve=!1,ce&&(se=ce,le=ue,ce=void 0,I(void 0,0,void 0,!0)),X.trigger("hideDetails"),X.trigger("showInfoButton")},X.expandDetails=function(){ve=!0,ce&&(se=ce,le=ue,ce=void 0,I(void 0,0,void 0,!0)),X.trigger("hideInfoButton"),X.trigger("showDetails",he,X.facets)},X.sortBy=function(e){X.sortFacet=e,T()},X.filter=function(){T()},X.addFilter=function(e){"function"==typeof e&&ae.push(e)},X.removeFilter=function(e){var t=ae.indexOf(e);t!==-1&&ae.splice(t,1)},X.clearFilters=function(){ae=[]},X.setFacets=function(e){if(U.length)throw"You must set self.facet categories before adding items.";ae=[],X.facets=e;var t,i,n;for(t in X.facets)hasOwnProperty.call(X.facets,t)&&(i=X.facets[t],n=i.orders,n&&n.length&&!function(){var e=n[0].order,t={};e.forEach(function(e,i){t[e]=i}),i.comparator=function(e,i){var n=hasOwnProperty.call(t,e),o=hasOwnProperty.call(t,i);return n?o?t[e]-t[i]:-1:o?1:e===i?0:e>i?1:-1}}());X.trigger("hideDetails"),X.trigger("hideInfoButton"),X.trigger("facetsSet",X.facets)},X.addItems=function(e){function t(){i--,i||(U=U.concat(n),e.forEach(Z),X.filter())}if(!U.length&&(X.activeItemsArr.length||te.length))return void c(function(){X.addItems(e)});var i=1,n=[];e.forEach(function(e){var o,r=e.sdimg=e.sdimg||[];e.img&&(o=r[-1]=r[-1]||new Seadragon2.Image(Re),o.src=e.img,o.update(),o.state||(i++,o.addEventListener("load",t,!1)));var a=e.id;a||"number"==typeof a||(a=e.id=He()),e.name||(e.name=""),e.description||(e.description=""),e.href||(e.href=""),e.facets||(e.facets={}),hasOwnProperty.call(ee,a)||(ee[a]=e,n.push(e)),he===e&&me&&ve&&(X.trigger("hideDetails"),X.trigger("showDetails",e,X.facets))}),t()},X.setTemplates=function(e){if(U.length||X.activeItemsArr.length||te.length)throw"You must set templates before adding items!";Te=e.sort(function(e,t){return e.width-t.width}),Te[-1]={type:"sdimg"},Te.forEach(function(e){"canvas"===e.type&&(e.func=makeTemplate(e)),"html"===e.type&&e.renderer&&(e.type="fakehtml")}),Ee=-1},X.clearItems=function(){U=[],ee={},X.filter()},X.getItemById=function(e){return ee[e]},X.setTitle=function(e){X.trigger("titleChange",e)},X.setCopyright=function(e){X.trigger("copyright",e)},X.runFiltersWithout=function(e){X.removeFilter(e);var t=U.filter(function(e){return ae.every(function(t){return t(e)})});return X.addFilter(e),t},X.runSearch=function(e,t){function i(t){t=t.content||t,"number"==typeof t?t=PivotNumber_format(t):t instanceof Date&&(t=t.toLocaleDateString()+" "+t.toLocaleTimeString());var i=t.toLowerCase().indexOf(e);0===i?W(n,t):i>0&&W(o,t)}var n,o,r;return t?(n={},o={},r={front:n,rest:o}):n=o={},e=e.toLowerCase(),e&&U.forEach(function(e){var t,n=e.facets;for(t in n)hasOwnProperty.call(n,t)&&n[t].forEach(i);i(e.name)}),r},F()},PivotCxmlLoader=Pivot.CxmlLoader={load:function(e,t){function i(){Seadragon2.Debug.error("Failed to fetch CXML: "+t)}function n(){function s(e,t,i){if(e.getAttributeNS)return e.getAttributeNS(t,i);var n,o,r=e.attributes,a=r.length;for(o=0;o<a;o++)if(n=r[o],n.namespaceURI===t&&n.baseName===i)return n.value;return null}var l=this.responseXML||Seadragon2.Xml.parse(this.responseText);if(!l)return void Seadragon2.Debug.error("Failed to parse CXML: "+t);var c,u,h,d,m,f,p,g,v,S,D,w,y,_,b,T,x,k,E,M,P,L,I,C,N,R=[];if(c=l.documentElement,N=c.ELEMENT_NODE||1,M=s(c,o,"Supplement"),M&&Seadragon2.Xml.fetch(t.split("/").slice(0,-1).join("/")+"/"+M,n,i),P=c.getAttribute("Name"),P&&e.setTitle(P),u=c.getElementsByTagName("FacetCategories")[0]){for(u=u.childNodes,m=u.length,d=0;d<m;d++)if(h=u[d],h.nodeType===N)for(a[h.getAttribute("Name")]=f={index:d},f.type=h.getAttribute("Type"),f.isFilterVisible="true"===s(h,o,"IsFilterVisible"),f.isMetaDataVisible="true"===s(h,o,"IsMetaDataVisible"),f.isWordWheelVisible="true"===s(h,o,"IsWordWheelVisible"),g=h.childNodes,S=g.length,v=0;v<S;v++)if(_=g[v].firstChild,_&&"SortOrder"===(_.localName||_.baseName)&&_.namespaceURI===o)for(f.orders=f.orders||[],I={name:_.getAttribute("Name")},L=I.order=[],f.orders.push(I),_=_.childNodes,y=_.length,w=0;w<y;w++)P=_[w],"SortValue"===(P.localName||P.baseName)&&P.namespaceURI===o&&L.push(P.getAttribute("Value"));e.setFacets(a)}for(u=c.childNodes,d=u.length-1;d>=0;d--)P=u[d],"Extension"===P.tagName&&(g=P.firstChild,g&&"Copyright"===(g.localName||g.baseName)&&g.namespaceURI===o&&e.setCopyright({href:t.split("/").slice(0,-1).join("/")+"/"+g.getAttribute("Href"),name:g.getAttribute("Name")}));if(u=c.getElementsByTagName("Items")[0]){for(P=u.getAttribute("ImgBase"),P&&(r=t.slice(0,t.lastIndexOf("/")+1)+P.replace("\\","/")),u=u.childNodes,m=u.length,d=0;d<m;d++)if(h=u[d],h.nodeType===N&&(E=h.getAttribute("Id"),p=e.getItemById(E),p?C=!0:(p={},p.id=E,p.facets={}),R.push(p),P=h.getAttribute("Href"),P&&(p.href=P),P=h.getAttribute("Name"),P&&(p.name=P),P=h.getAttribute("Img"),P&&(p.img=r+P),k=h.getElementsByTagName("Description"),k.length&&(p.description=k[0].textContent||k[0].text),g=h.getElementsByTagName("Facets")[0]))for(g=g.childNodes,S=g.length,v=0;v<S;v++)if(h=g[v],h.nodeType===N)for(D=h.getAttribute("Name"),f=a[D],p.facets[D]=x=[],_=h.childNodes,y=_.length,w=0;w<y;w++)if(h=_[w],h.nodeType===N){switch(f.type){case"String":case"LongString":b=T=h.getAttribute("Value").trim();break;case"Link":b=h.getAttribute("Name").trim(),T={content:b,href:h.getAttribute("Href")};break;case"Number":b=h.getAttribute("Value"),T=parseFloat(b);break;case"DateTime":b=h.getAttribute("Value"),T=new Date(b);break;default:Seadragon2.Debug.warn("Unknown facet type "+f.type),b=T=h.getAttribute("Value")}x.push(T)}R.length&&e.addItems(R)}}var o="http://schemas.microsoft.com/livelabs/pivot/collection/2009";e.setTitle(t);var r,a={};Seadragon2.Xml.fetch(t,n,i)}},Pivot_init=Pivot.init=function(e,t){function i(){W.style.height="80px",X.innerHTML="more",X.onclick=Y}function n(e,t,i){var n,o,r=De[e];if(t&&t.length>0)if(r)r.values=t;else{switch(i){case"String":case"LongString":case"Link":o=function(t){return r.values.some(function(i){var n=t.facets[e];return n?n.some(function(e){return e=e.content||e,i===e}):"(no info)"===i})};break;case"DateTime":case"Number":o=function(t){return r.values.some(function(i){var n=t.facets[e];return n?n.some(function(e){return e>=i.lowerBound&&(i.inclusive?e<=i.upperBound:e<i.upperBound)}):void 0===i.lowerBound})};break;default:return void Seadragon2.Debug.warn("Unrecognized facet type "+i)}r=De[e]={filter:o,values:t},A.addFilter(r.filter),we++,n=_e[e],n&&(n.style.visibility="visible"),1===we&&(ye.style.visibility="visible")}else r&&(delete De[e],A.removeFilter(r.filter),we--),n=_e[e],n&&(n.style.visibility=""),we||le||(ye.style.visibility="")}function o(e){var t,i=De[ve],o=ve;e.target.checked?i?i.values.push(e.target.name):n(o,[e.target.name],Se):(t=i.values.indexOf(e.target.name),t!==-1&&i.values.splice(t,1),i.values.length||n(ve)),A.filter()}function r(e){var t=De[ve],i=e.target.parentNode.previousSibling;i.checked=!0;var n,r,a,s=i.name;if(t){for(a=pe.lastChild.childNodes,r=a.length,n=0;n<r;n++)i=a[n].firstChild,i.name!==s&&(i.checked=!1);t.values=[s],A.filter()}else o({target:i})}function a(e,t,i,o){n(e,[{lowerBound:t,upperBound:i,inclusive:o}],"Number"),A.filter()}function s(e){n(e),A.filter()}function l(e,t){n(e,t,"DateTime"),A.filter()}function c(e,t){return t.count-e.count}function u(e,t){return e=e.value,t=t.value,e===t?0:"(no info)"===e?1:"(no info)"===t?-1:e>t?1:-1}function h(){ge.currentComparator=(ge.currentComparator+1)%ge.comparators.length,m()}function d(e){pe&&(pe.style.height="0px",pe.style.overflow="hidden");var t=e.target;t.name||(t=t.parentNode),ge=t,ve=t.name,Se=t.facetType;var i=t.nextSibling;i.innerHTML="";var n,c,u,d,m,f,p,g,v,S,D=De[ve]||{},w=A.runFiltersWithout(D.filter);switch(Se){case"Link":case"String":case"LongString":n={},S=function(e){e=e.content||e,n[e]||(n[e]=0),n[e]++},w.forEach(function(e){e.facets[ve]?e.facets[ve].forEach(S):S("(no info)")}),u=[];for(c in n)hasOwnProperty.call(n,c)&&u.push({value:c,count:n[c]});u.sort(t.comparators[t.currentComparator]);var y=makeElement("div","pivot_sortlabel",i);addText(y,t.comparatorNames[t.currentComparator]),y.onclick=h;var _=makeElement("ul","pivot",i);g=D.values||[],u.forEach(function(e){d=makeElement("li",null,_),m=makeElement("input","pivot pivot_facetcheckbox",d),m.setAttribute("type","checkbox"),m.name=e.value,g.indexOf(e.value)!==-1&&(m.checked=!0),m.onclick=o,v=makeElement("div","pivot_outerlabel",d),v.onclick=r,p=makeElement("div","pivot_facetcount",v),addText(p,e.count),f=makeElement("div","pivot_facetlabel",v),addText(f,e.value),d.title=e.value});break;case"Number":var b=new PivotNumberPicker(i,w,ve,D.values);b.addListener("filter",a),b.addListener("unfilter",s);break;case"DateTime":var T=new PivotDatePicker(i,w,ve,D.values);T.addListener("filter",l);break;default:Seadragon2.Debug.warn("Unrecognized facet type: "+Se)}i.style.height=Math.max(150,parseFloat(Seadragon2.Element.getStyle(z).height)+fe)+"px",i.style.overflowY="auto",pe=i}function m(){pe&&d({target:pe.previousSibling})}function f(e){n(e.target.parentNode.name),A.filter(),m(),e.stopPropagation()}function p(e){var t=e.facets,i=le.trim().toLowerCase().split(" ");return i.every(function(i){return e.name.toLowerCase().indexOf(i)!==-1||be.some(function(e){var n=t[e];return n&&n.some(function(e){return e=e.content||e,"number"==typeof e&&(e=PivotNumber_format(e)),e instanceof Date&&(e=e.toLocaleDateString()+" "+e.toLocaleTimeString()),e.toLowerCase().indexOf(i)!==-1})})})}function g(){le?(se.value=le,ue.className="pivot_searchbtn pivot_clrsearch",ue.onmousedown=v):(ae.className="pivot_watermark",se.value="Search...",ue.onmousedown=null),ce.innerHTML="",de=-1,he=0}function v(e){ue.className="pivot_searchbtn",le=null,we||(ye.style.visibility=""),g(),A.removeFilter(p),e!==!0&&(A.filter(),m())}function S(e){A.clearFilters();var t;for(t in _e)hasOwnProperty.call(_e,t)&&(_e[t].style.visibility="");le&&v(!0),ye.style.visibility="",De={},we=0,e!==!0&&(A.filter(),m())}function D(){var e=!!le;le=se.value,e||A.addFilter(p),ye.style.visibility="visible",g(),A.filter(),m()}function w(e){var t,i=[];for(t in e)hasOwnProperty.call(e,t)&&i.push({value:t,count:e[t]});i.sort(function(e,t){return t.count-e.count}),i.every(function(e){if(he>=10)return!1;var t=makeElement("li",null,ce);return addText(t,e.value),t.onmousedown=function(){se.value=e.value,D()},he++,!0})}function y(e){var t=ce.childNodes[de];t&&(t.className=""),de=e,de>=he?de=-1:de<-1&&(de=he-1),de===-1?se.value=me:(t=ce.childNodes[de],t.className="pivot_highlight",se.value=t.firstChild.textContent)}function _(e){switch(e.keyCode){case 38:y(de-1);break;case 40:y(de+1);break;case 13:k.focus();break;default:me=se.value;var t=A.runSearch(me,!0);ce.innerHTML="",de=-1,he=0,w(t.front),w(t.rest)}}function b(){le?(ue.className="pivot_searchbtn",_({})):(ae.className="",se.value=""),ue.onmousedown=D}function T(){var e,t={};for(e in De)if(hasOwnProperty.call(De,e)){var i,n,o=De[e].values,r=[],a=o.length;for(n=0;n<a;++n){var s=o[n];if("string"==typeof s)r.push(s),i="String";else{var l=s.lowerBound,c=s.upperBound;"number"!=typeof l&&"number"!=typeof c?(l=l.getTime(),c=c.getTime(),i="DateTime"):i="Number",r.push({lowerBound:l,upperBound:c,inclusive:s.inclusive})}}t[e]={values:r,dataType:i}}return JSON.stringify({filters:t,search:le,sortBy:oe.value,view:ie.className.indexOf("pivot_activesort")!==-1?"grid":"graph"})}function x(e){e=JSON.parse(e);var t,i=e.filters,o=e.search,r=e.sortBy;for(t in i)if(hasOwnProperty.call(i,t)){var a=i[t],s=a.dataType,l=a.values;"DateTime"===s&&l.forEach(function(e){e.lowerBound=new Date(e.lowerBound),e.upperBound=new Date(e.upperBound)}),"Number"===s&&l.forEach(function(e){null===e.lowerBound&&(e.lowerBound=-(1/0)),null===e.upperBound&&(e.upperBound=1/0)}),n(t,l,s)}o&&(se.value=o,D()),r&&(oe.value=r,A.sortBy(r)),"graph"===e.view&&te.onclick(),m()}for(;e.firstChild;)e.removeChild(e.firstChild);if(!makeElement("canvas").getContext)return void addText(e,"Your browser doesn't support canvas! Get a better one.");var k=makeElement("input","pivot_input",e);k.setAttribute("type","checkbox");var E=makeElement("div","pivot pivot_viewbox",e),M=makeElement("div","pivot pivot_topbar",E),P=makeElement("div","pivot pivot_title",M),L=makeElement("div","pivot pivot_canvas",E),I=makeElement("div","pivot pivot_layer",L),C=makeElement("div","pivot pivot_layer",I),N=makeElement("canvas","pivot",I);N.height=N.offsetHeight,N.width=N.offsetWidth;var R=makeElement("div","pivot pivot_layer",I),B=makeElement("div","pivot pivot_layer map_layer",I),z=makeElement("div","pivot pivot_pane pivot_filterpane",L),O=z.offsetLeft+z.offsetWidth,A=new PivotViewer(N,I,R,C,B,O,O,k),F=makeElement("div","pivot pivot_pane pivot_detailspane",L);F.style.opacity=0,F.style.display="none";var H=makeElement("div","pivot_hoverable pivot_left pivot_larr",F);H.onclick=function(){A.moveLeft()},H=makeElement("div","pivot_left pivot_subtle pivot_vertbar",F),addText(H,"|"),H=makeElement("div","pivot_hoverable pivot_left pivot_rarr",F),H.onclick=function(){A.moveRight()},H=makeElement("div","pivot_hoverable pivot_right pivot_collapse",F),H.onclick=function(){A.collapseDetails()};var V=makeElement("h2","pivot",F);V=makeElement("a","pivot",V),V.setAttribute("target","_blank");var Z=makeElement("div","pivot pivot_scrollable",F),W=makeElement("div","pivot pivot_description",Z),X=makeElement("div","pivot_sortlabel",Z),U=makeElement("dl","pivot",Z);makeElement("div","pivot_horizbar",F);var q,G=makeElement("div","pivot_copyright",F),j=makeElement("div","pivot_info",L);j.style.display="none",j.onclick=function(){A.expandDetails()};var Y,$=!1;Y=function(){W.style.height="auto",X.innerHTML="less",X.onclick=i};var J,K;A.addListener("showDetails",function(e,t){if(q||(F.style.display="",setTimeout(function(){F.style.opacity=1},0),z.className+=" pivot_faded",void 0!==K&&(clearTimeout(K),K=void 0)),e!==q){V.innerHTML="",addText(V,e.name||"???");var o=e.href;o&&V.setAttribute("href",o),Z.style.height=parseFloat(Seadragon2.Element.getStyle(F).height)-Z.offsetTop-25+"px",W.innerHTML="",e.description&&addText(W,e.description),W.style.height="auto",W.offsetHeight>80?(i(),X.style.display="block"):X.style.display="none",U.innerHTML="";var r,a,s,l,c,u,h,d,f,p,g,v=e.facets,D=[];for(r in v)g=t[r],hasOwnProperty.call(v,r)&&g&&g.isMetaDataVisible&&D.push(r);D.sort(function(e,i){return(t[e].index||0)-(t[i].index||0)});var w,y=D.length;for(w=0;w<y;++w)for(r=D[w],g=t[r],s=makeElement("dt","pivot",U),addText(s,r),a=v[r],a=v[r],h=a.length,l=makeElement("dd","pivot",U),u=0;u<h;u++){switch(c=makeElement("div",void 0,l),d=void 0,f=a[u],g.type){case"String":case"LongString":addText(c,f),d=f;break;case"Link":p=makeElement("a",void 0,c),p.target="_blank",p.href=f.href,addText(p,f.content);break;case"Number":addText(c,PivotNumber_format(f)),d={upperBound:f,lowerBound:f,inclusive:!0};break;case"DateTime":addText(c,f.toLocaleDateString()+" "+f.toLocaleTimeString()),d={lowerBound:f,upperBound:new Date(f.getTime()+1e3)};break;default:Seadragon2.Debug.warn("Unrecognized facet type in details pane: "+g.type)}void 0!==d&&g.isFilterVisible&&(c.className+=" pivot_filterable",function(){var e=r,t=[d],i=g.type;c.onclick=function(){S(!0),n(e,t,i),m(),A.filter()}}())}q=e}}),A.addListener("hideDetails",function(){q&&(F.style.opacity=0,K=setTimeout(function(){F.style.display="none",K=void 0},500),q=null,z.className=z.className.replace(" pivot_faded",""))}),A.addListener("showInfoButton",function(){$||(j.style.display="",setTimeout(function(){j.style.opacity=1},0),z.className+=" pivot_faded",$=!0,void 0!==J&&(clearTimeout(J),J=void 0))}),A.addListener("hideInfoButton",function(){$&&(j.style.opacity=0,J=setTimeout(function(){j.style.display="none",J=void 0},500),$=!1,z.className=z.className.replace(" pivot_faded",""))});var Q=makeElement("div","pivot pivot_sorttools pivot_zoomslider",M);Q=new PivotSlider(Q,0,100,0,"Zoom Out","Zoom In");var ee=new Button("div","pivot_sorttools pivot_map pivot_hoverable",M,"Map View"),te=new Button("div","pivot_sorttools pivot_graph pivot_hoverable",M,"Graph View"),ie=new Button("div","pivot_sorttools pivot_grid pivot_activesort",M,"Grid View"),ne=[ie,te,ee];A.views.forEach(function(e,t,i){e.onSelected=function(){i.forEach(function(t,i,n){t!=e&&(ne[i].deselect(),t.deselect())}),A.showView()}}),ne.forEach(function(e,t,i){e.htmlElement.onclick=function(){e.select(),A.views[t].select()}});var oe=makeElement("select","pivot pivot_sorttools",M);oe.onchange=function(){A.sortBy(oe.value)};var re=makeElement("div","pivot_sorttools pivot_subtle",M);addText(re,"Sort:"),A.addListener("zoom",function(e){Q.setValue(e)}),Q.addListener("change",function(e){A.zoomToPercent(e)}),A.addListener("titleChange",function(e){P.innerHTML="",addText(P,e)}),A.addListener("copyright",function(e){G.innerHTML="";var t=makeElement("a",void 0,G);t.href=e.href,t.target="_blank",addText(t,e.name)});var ae,se,le,ce,ue,he,de,me,fe,pe,ge,ve,Se,De,we,ye,_e,be;return A.addListener("resize",m),A.addListener("filterrequest",function(e){var t=e.type,i=e.values;n(e.facet,i,t),"String"!==t&&"Link"!==t&&"LongString"!==t||1!==i.length?A.filter():(A.views[0].select(),ne[0].select(),A.views.forEach(function(e,t,i){0!==t&&(e.deselect(),ne[t].deselect())}),A.showView()),m()}),A.addListener("facetsSet",function(e){var i,n;be=[],oe.innerHTML="";for(i in e)hasOwnProperty.call(e,i)&&(e[i].isFilterVisible&&(n=makeElement("option",null,oe),n.value=i,addText(n,i)),e[i].isWordWheelVisible&&be.push(i));A.sortBy(oe.value),De={},we=0,de=-1,he=0,le=null,me=null,pe=null,ve="",Se=null,z.innerHTML="",fe=-10;var o,r,a,s,l;ye=makeElement("div","pivot_clrlabel pivot_clr",z),ye.onclick=S,_e={},l=makeElement("div","pivot_clrbtn pivot_clr",ye),l.innerHTML="&times;",addText(ye,"Clear All"),ae=makeElement("form",null,z),ae.onsubmit=function(e){D(),e.preventDefault()},se=makeElement("input","pivot_searchbox",ae),se.type="text",se.onfocus=b,se.onblur=g,se.onkeyup=_,ue=makeElement("span","pivot_searchbtn",ae),ue.innerHTML="&times;",ce=makeElement("ul","pivot pivot_results",ae),g(),fe-=ae.offsetHeight+ye.offsetHeight;var h=[];for(i in e)hasOwnProperty.call(e,i)&&e[i].isFilterVisible&&h.push(i);h.sort(function(t,i){return(e[t].index||0)-(e[i].index||0)});var m,p=h.length;for(m=0;m<p;++m){if(i=h[m],a=e[i],o=makeElement("div","pivot pivot_facetname",z),o.onclick=d,o.name=i,o.facetType=a.type,"String"===a.type||"LongString"===a.type||"Link"===a.type){var v=o.comparatorNames=[],w=o.comparators=[];o.currentComparator=0,a.orders&&a.orders.length&&a.comparator&&(!function(){var e=a.comparator;w.push(function(t,i){return e(t.value,i.value)})}(),v.push("Sort: "+a.orders[0].name)),v.push("Sort: Quantity"),w.push(c),v.push("Sort: A-Z"),w.push(u)}l=_e[i]=l.cloneNode(!0),l.onclick=f,o.appendChild(l),s=makeElement("div","pivot_facetlabel",o),addText(s,i),fe-=o.offsetHeight,r=makeElement("div","pivot pivot_facetvalues",z),r.style.height=0,r.style.overflow="hidden"}if(t){var y=location.hash;if(y&&y.length>2)try{x(decodeURIComponent(y.substr(1)))}catch(T){Seadragon2.Debug.warn("bad URL hash")}}}),e.addEventListener("click",function(e){var t=e.target;t!==se&&t!==oe&&k.focus()}),t&&A.addListener("finishedRearrange",function(){location.hash="#"+encodeURIComponent(T())}),A};Seadragon2.ImageManager.disable(),addEventListener("load",function(){var e,t,i,n,o,r=document.getElementsByClassName("pivot_ajax_viewer");for(t=r.length,e=0;e<t;e++){i=r[e],n=i.getAttribute("data-collection");var a=i.getAttribute("data-use-hash");a=a&&"false"!==a.toLowerCase(),o=Pivot_init(i,a),i.pivotViewer=o,n&&PivotCxmlLoader.load(o,n)}},!1);