function SDBrowser_parseUserAgent(e){var t=null,n=null,i=null,r=null,o=/MSIE ([^\s;)]+)/.exec(e),a=/Firefox\/(\S+)/.exec(e),s=/Safari\/(\S+)/.exec(e),l=/Chrome\/(\S+)/.exec(e),c=/Version\/(\S+)/.exec(e),u=/; Trident\/([^\s;)]+)/.exec(e),d=/rv\:([^\s)]+)\) Gecko\//.exec(e),h=/WebKit\/(\S+)/.exec(e);return o?(t=SDBrowser_IE,n=o[1],i=SDBrowser_TRIDENT,u&&(r=u[1])):d?(i=SDBrowser_GECKO,r=d[1],a&&(t=SDBrowser_FF,n=a[1])):h&&(i=SDBrowser_WEBKIT,r=h[1],l?(t=SDBrowser_CHROME,n=l[1]):s&&c&&(t=SDBrowser_SAFARI,n=c[1],r=s[1])),{name:t,version:n,engine:i,engineVersion:r}}function SDPage_getScroll(){var e=new SDPoint,t=document.documentElement||{},n=document.body||{};return"number"==typeof window.pageXOffset?(e.x=pageXOffset,e.y=pageYOffset):n.scrollLeft||n.scrollTop?(e.x=n.scrollLeft,e.y=n.scrollTop):(t.scrollLeft||t.scrollTop)&&(e.x=t.scrollLeft,e.y=t.scrollTop),e}function SDTileCache(e){this.capacity=e>1?e:2,this.oldest=null,this.newest=null}function SDNetwork_generateTryMakeRequestMethod(e,t){return function(n,i,r){var o,a=e[n];return a?("function"==typeof i&&a.seadragon.callbacks.push(i),!0):(o=SDUri_getHostname(n),!(!SDNetwork_numSpotsAvailable(o)&&!r)&&(!!(a=t(n))&&(SDNetwork_markSpotTaken(o),e[n]=a,a.seadragon={url:n,hostname:o,callbacks:"function"==typeof i?[i]:[]},!0)))}}function SDNetwork_tryCallAll(e,t,n,i){var r,o=e.length;for(r=0;r<o;r++)try{e[r](t,n,i)}catch(a){SDDebug_warn("Seadragon2.Network callback {0} for {1} threw an error:\n{2}",r,t,a)}}function SDNetwork_generateResponseHandler(e,t){function n(){var n=this.seadragon,i=n.url;SDNetwork_markSpotOpen(n.hostname),delete e[i];try{delete this.seadragon}catch(r){this.seadragon=null}SDNetwork_tryCallAll(n.callbacks,i,t,this)}return window.ActiveXObject?SDFunction_delay(n,0):n}function Tile(e,t,n,i,r){var o=SDTileInfo_$(i.getTileInfo(e,t,n));this.level=e,this.col=t,this.row=n,this.tileBelow=r,this.url=o.url,this.crop=o.crop,this.bounds=i.getTileBounds(e,t,n),this.drawnOpaque=!1,this.tilesAbove=i.getNumTilesAbove(e,t,n),this.covered=0,this.loading=!1,this.area=0,this.distance=0,this.opacity=1,this.inBounds=!0,this.view=null}function Level(e,t){this.bounds=SDRect_nullRect,this.tiles={},this.num=e,this.visible=!1,this.fading=!1,this.tilesVisible=0,this.opacity=1,this.dimensions=t.getLevelDimensions(e),this.view=null}function SDTileLoader_compareNominatedUrls(e,t){var n,i=SDTileLoader_nominations[e],r=SDTileLoader_nominations[t],o=r.area-i.area;return o?o:(n=i.distance-r.distance,n?n:i.level-r.level)}function SDTileLoader_imgCallback(e,t,n){var i,r,o,a,s,l,c=SDTileLoader_imgInfos[e];c||SDDebug_error("Seadragon2.TileLoader: [internal] no img info for "+e),l=SDTileLoader_cache.insert(c),l&&delete SDTileLoader_imgInfos[l.url],c.loading=!1,c.loaded=t,c.failed=!t,c.img=n,i=c.tiles,r=c.callbacks,o=c.args;try{delete c.tiles,delete c.callbacks,delete c.args}catch(u){c.tiles=null,c.callbacks=null,c.args=null}for(s=i.length,a=0;a<s;a++)i[a]&&r[a](o[a],i[a],c);SDTileLoader_triggerProcessing()}function SDTileLoader_processNominations(){var e,t,n,i,r=[],o=SDNetwork_numSpotsAvailable();SDTileLoader_trigger=!1;for(n in SDTileLoader_nominations)SDTileLoader_nominations.hasOwnProperty(n)&&SDTileLoader_nominations[n]&&r.push(n);for(r.sort(SDTileLoader_compareNominatedUrls),t=r.length,e=0;e<t&&o>0;e++)if(n=r[e],SDNetwork_tryMakeImageRequest(n,SDTileLoader_imgCallback)){o--,i=SDTileLoader_nominations[n],SDTileLoader_imgInfos[n]={loading:!0,loaded:!1,failed:!1,img:null,tiles:i.tiles,callbacks:i.callbacks,args:i.args,url:n};try{delete SDTileLoader_nominations[n]}catch(a){SDTileLoader_nominations[n]=null}}}function SDTileLoader_nominate(e,t,n){var i=e.url,r=SDTileLoader_imgInfos[i];return r?void(r.tiles?(r.tiles.push(e),r.callbacks.push(t),r.args.push(n),r.nominators++):SDDebug_warn("Nomination dropped: "+i)):(r=SDTileLoader_nominations[i],r?(r.tiles.push(e),r.callbacks.push(t),r.args.push(n),r.area+=e.area,r.distance=SDMath_min(r.distance,e.distance),r.nominators++):SDTileLoader_nominations[i]={tiles:[e],callbacks:[t],args:[n],nominators:1,area:e.area,distance:e.distance,level:e.level},SDTileLoader_triggerProcessing(),SDTileLoader_nominations[i].tiles.length-1)}function SDTileLoader_getImgInfo(e){var t=SDTileLoader_imgInfos[e];return t&&!t.loading&&SDTileLoader_cache.refresh(t),t||SDTileLoader_nullImgInfo}function SDImageManager_checkForInit(){var e,t,n,i,r,o=document.getElementsByTagName("sdimg"),a=o.length;for(e=0;e<a;e++)if(t=o[e],!t.update){for(i=t.nextSibling,r=t.parentNode;t.hasChildNodes();)n=t.firstChild,t.removeChild(n),"sdimgcontainerdiv"!==n.className&&(i?r.insertBefore(n,i):r.appendChild(n));new SDImage(null,o[e])}return!0}function SDImageState_blendCallback(e,t){var n,i=e.levelData,r=e.tile,o=e.startTime,a=e.state,s=e.last||o;return!(!i.visible||!r.inBounds||r.isCovered()||i.fading||r.drawnOpaque)&&(n=(t-o)/a.blendInTime,(n>1||t-s>67)&&(n=1),a.drawer.updateBlend(r,i.view,n),r.opacity=n,1===n?(i.fading||a.onDrawn(r),!1):(e.last=t,!0))}function SDImageState_fadeCallback(e,t){var n,i=e.state,r=e.levelData,o=e.level,a=i.levels,s=e.startTime,l=e.last||s;return a[o]===r&&(n=1-(t-s)/i.fadeOutTime,t-l>67&&(n=0),n<=0?(r.visible&&i.drawer.removeLevel(r.view),delete a[o],!1):(r.visible&&(r.opacity=n,i.drawer.updateFade(r.view,n)),e.last=t,!0))}function SDImageState_onTileLoad(e,t,n){var i=e.levelData,r=i.bounds,o=e.state;t.loading=!1,!n.failed&&r&&t.inBounds&&i.visible&&!i.fading&&(t.isCovered()||o.blendTile(n.img,t))}function SDImage_onSrcClear(e){e.state&&e.state.destroy(),e.state=null}function SDImage_onTileSourceLoad(e,t,n){e.immediateMode&&e.parentNode?e.immediateMode=!1:e.skippedParentCheck=SDMath_floor(30*Math.random());var i=e.immediateMode?SDDrawer_nullDrawer:SDDrawer_$(e.container,t.normHeight);e.state=new SDImageState(t,i,e.blendTime,e.fadeTime),SDEvent_raise(e,"load",!1)}function SDImage_fetchSrc(e,t){SDDeepZoom_fetchTileSource(t,function(n){n instanceof SDTileSource?SDImage_onTileSourceLoad(e,n):SDDebug_warn("SDImage: failed to fetch tile source at "+t)})}function SDImage_onSrcSet(e){var t=e.src,n=typeof t;"string"===n?SDImage_fetchSrc(e,t):"object"===n?SDImage_onTileSourceLoad(e,SDTileSource_$(t)):SDDebug_error("Unsupported src type: "+n)}function SDImage_onSrcChange(e){SDImage_onSrcClear(e),SDImage_onSrcSet(e)}function SDImage_onTickSrcEmpty(e){}function SDImage_onTickSrcSet(e,t,n){if(e.state){e.immediateMode&&(e.skippedParentCheck>30?(e.parentNode&&(e.immediateMode=!1,SDImage_onTileSourceLoad(e,e.state.source)),e.skippedParentCheck=0):e.skippedParentCheck++);var i,r,o=e.container,a=t||SDElement_getBoundingClientRect(o),s=a.width,l=a.height;t||n?r=n:(i=SDElement_getWindowDimensions(),e.clipParent&&(i=i.intersect(SDElement_getBoundingClientRect(e.clipParent)),i||(i=new SDRect(0,0,0,0))),r=SDElement_getClippingBounds(o,a,i)),s&&l&&(t||(a.x-=i.width/2,a.y-=i.height/2),e.state.update(a,r,e.blur-SDImage_pixelRatio))}}function SDImage_onTick(e,t,n,i){var r=e.lastSrc,o=e.src;return!r&&o?SDImage_onSrcSet(e):r&&!o?SDImage_onSrcClear(e):o!==r?SDImage_onSrcChange(e):o?o?SDImage_onTickSrcSet(e,n,i):SDDebug_warn("SDImage_onTick: unknown state! src={0}, lastSrc={1}",o,r):SDImage_onTickSrcEmpty(e),e.lastSrc=o,!0}function parseHTML(e){return(new DOMParser).parseFromString(e,"text/html")}function isHTML(e){if(""!==e&&null!==e&&void 0!==e){var t=parseHTML(e);if(null!==t&&null!==t.body&&null!=t.body.childNodes&&void 0!==t&&void 0!==t.body&&void 0!=t.body.childNodes)return Array.from(t.body.childNodes).some(function(e){return 1===e.nodeType})}return!1}function getTextFromHTML(e){if(isHTML(e)){var t=parseHTML(e),n="",i=0;return t.body.childNodes.forEach(function(e){i>0&&(n+=" "),n+=e.textContent,i+=1}),n}return e}function getHrefFromHTML(e){if(isHTML(e)){var t=parseHTML(e),n="",i=0;return t.body.childNodes.forEach(function(e){i>0&&(n+=" ");var t=e.getAttribute("href");void 0!==t&&(n+=t),i+=1}),n}}function deleteAdditionalProperties(e){var t=Object.assign({},e.facets);return Object.entries(t).forEach(function(e){"_"===e[0][0]&&delete t[e[0]]}),t}function cleanUTF8String(e){for(var t="",n=0;n<e.length;n++)e.charCodeAt(n)<=127&&(t+=e.charAt(n));return t}function arraysEqual(e,t){return JSON.stringify(e)==JSON.stringify(t)}function debounce(e,t,n){var i;return function(){var r=this,o=arguments,a=function(){i=null,n||e.apply(r,o)},s=n&&!i;clearTimeout(i),i=setTimeout(a,t),s&&e.apply(r,o)}}function PivotNumber_format(e){if(!e)return"0";for(var t=Math.floor(Math.log(Math.abs(e))/Math.LN10),n=e/Math.pow(10,t),i=0;i<10&&Math.abs(n)>PivotNumber_epsilon;)i++,n=10*(n-Math.round(n));return t>=i&&t<i+5?e.toFixed(0):e.toPrecision(i)}function PivotNumberPicker(e,t,n,i){function r(e){return Seadragon2.Math.round(e,void 0,u)}function o(){D.innerHTML=N===-(1/0)?B===1/0?"":i18n.t("under")+PivotNumber_format(B):B===1/0?i18n.t("over")+PivotNumber_format(N):N===B?i18n.t("exactly")+PivotNumber_format(N):PivotNumber_format(N)+" &ndash; "+PivotNumber_format(B)}function a(e){var t,n=Math.floor(A/I*g),i=e+"px",a=Math.floor(e/I*g);for(A=e,m.style.left=i,h.style.left=i,N=e?r(P+(C-P)*e/I):-(1/0),o(),t=n;t>a;t--)w.childNodes[t-1].className="pivot_filtergraphbar";for(t=n;t<a;t++)w.childNodes[t].className="pivot_filtergraphbar pivot_deselected"}function s(e){var t,n=Math.floor(O/I*g),i=e+"px",a=Math.floor(e/I*g);for(O=e,p.style.right=i,h.style.right=i,B=e?r(C-(C-P)*e/I):1/0,o(),t=n;t>a;t--)w.childNodes[g-t].className="pivot_filtergraphbar";for(t=n;t<a;t++)w.childNodes[g-t-1].className="pivot_filtergraphbar pivot_deselected"}function l(){var e=document.documentElement;e.className=e.className.replace(M,""),N===-(1/0)&&B===1/0?R.trigger("unfilter",n):R.trigger("filter",n,N,B,!0)}function c(e){return e=" "+e,function(t,n,i){L=i.x,M=e,document.documentElement.className+=e}}var u,d,h,m,p,g,f,v,S,D,w,y,b,T,I,_,L,E,x,k,M,P=1/0,C=-(1/0),R=this,A=0,O=0,N=-(1/0),B=1/0;if(D=makeElement("div","pivot_numberlabel",e),Seadragon2.EventManager.call(R),t.forEach(function(e){var t,i=e.facets[n];i&&(t=i[0],t<P&&(P=t),t>C&&(C=t))}),g=11,f=(C-P)/g,v=[],0===f&&(f=0,g=1),f<0)return D.innerHTML=i18n.t("notApplicable"),R;for(_=0;_<g;_++)v.push(0);return t.forEach(function(e){var t,i=e.facets[n];i&&(t=f?Math.floor((i[0]-P)/f):0,t>g-1&&(t=g-1),v[t]++)}),S=v.reduce(function(e,t){return e>t?e:t},1),w=makeElement("div","pivot_filtergraph",e),v.forEach(function(e,t){var n=makeElement("div","pivot_filtergraphbar",w);n.style.width=100/g*.7+"%",n.style.left=100/g*(t+.15)+"%",n.style.height=100*e/S+"%"}),y=makeElement("div","pivot_sliderouter",e),h=makeElement("div","pivot_slider",y),m=makeElement("div","pivot_sliderhandle pivot_sliderleft",y),p=makeElement("div","pivot_sliderhandle pivot_sliderright",y),b=makeElement("div","pivot_left",e),T=makeElement("div","pivot_right",e),f?(I=parseFloat(Seadragon2.Element.getStyle(h).width)-1,d=Math.floor(Math.log((C-P)/I)/Math.LN10),u=Math.pow(10,d),C=Math.ceil(C/u)*u,P=Math.floor(P/u)*u,b.innerHTML=PivotNumber_format(r(P)),T.innerHTML=PivotNumber_format(r(C)),i&&(i=i[0],N=i.lowerBound,B=i.upperBound,void 0===N?(D.innerHTML=i18n.t("noInfo"),N=-(1/0),B=1/0):(N>P&&(a(Math.min(Math.round((N-P)/(C-P)*I),I)),N=i.lowerBound),B<C&&(s(Math.min(Math.round((C-B)/(C-P)*I),I-A)),B=i.upperBound),o())),E=new Seadragon2.MouseTracker(h),x=new Seadragon2.MouseTracker(m),k=new Seadragon2.MouseTracker(p),E.addListener("release",l),x.addListener("release",l),k.addListener("release",l),x.addListener("press",c("pivot_wresize")),k.addListener("press",c("pivot_eresize")),E.addListener("press",c("pivot_pointer")),x.addListener("drag",function(e,t,n){var i=Math.min(Math.max(A+n.x-L,0),I-O);i!==A&&a(i)}),k.addListener("drag",function(e,t,n){var i=Math.min(Math.max(O-n.x+L,0),I-A);i!==O&&s(i)}),E.addListener("drag",function(e,t,n){var i,r,o=n.x-L>0;o?(i=Math.max(O-n.x+L,0),i!==O&&(r=A-i+O,s(i),a(r))):(r=Math.max(A+n.x-L,0),r!==A&&(i=O-r+A,a(r),s(i)))}),E.setTracking(!0),x.setTracking(!0),void k.setTracking(!0)):(b.innerHTML=P.toPrecision(4),T.innerHTML=C.toPrecision(4),R)}function PivotSlider(e,t,n,i,r,o){var a,s,l,c,u,d,h,m,p,g,f,v,S=this,D=(n-t)/16;Seadragon2.EventManager.call(S),t<n||(t=0,n=1),"number"!=typeof i&&(i=t+(n-t)/2),a=makeElement("div","pivot_zoomout pivot_hoverable",e),a.innerHTML="&minus;",a.title=r,u=makeElement("div","pivot_zoomline",e),d=makeElement("div","pivot_zoomhandle",u),f=u.offsetWidth,v=d.offsetWidth,h=(n-t)/(f-v),s=makeElement("div","pivot_zoomin pivot_hoverable",e),addText(s,"+"),s.title=o,a.onclick=function(){l||S.setValue(i-D,!0)},s.onclick=function(){c||S.setValue(i+D,!0)},m=new Seadragon2.MouseTracker(d),m.addListener("press",function(e,t,n){p=n.x,document.documentElement.className+=" pivot_eresize"}),m.addListener("release",function(){var e=document.documentElement;p=void 0,e.className=e.className.replace(" pivot_eresize","")}),m.addListener("drag",function(e,n,i){S.setValue((g+i.x-p)*h+t,!0)}),m.setTracking(!0),e.onclick=function(n){var i=n.target;if(i===e||i===u){var r=Seadragon2.Mouse.getPosition(n).minus(Seadragon2.Element.getPosition(u)).x;r>=0&&r<f&&S.setValue((r-v/2)*h+t,!0)}},S.setValue=function(e,u){if(void 0===p||u){var m=i;i=e,i<=t?(i=t,l||(l=!0,a.title="",a.className="pivot_zoomout pivot_hoverable pivot_disabled")):l&&(l=!1,a.title=r,a.className="pivot_zoomout pivot_hoverable"),i>=n?(i=n,c||(c=!0,s.title="",s.className="pivot_zoomin pivot_hoverable pivot_disabled")):c&&(c=!1,s.title=o,s.className="pivot_zoomin pivot_hoverable"),g=Math.round((i-t)/h),d.style.left=g+"px",u&&m!==i&&S.trigger("change",i)}},S.setValue(i)}function lzwEncode(e){function t(e){for(1<<c<=s&&c++,d=d<<c|e,h+=c;h>=6;)h-=6,m.push(u[d>>h&63])}e=unescape(encodeURIComponent(e));var n,i,r,o={},a=e[0],s=255,l=e.length,c=8,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=0,h=0,m=[],p=65535;for(i=0;i<256;i++)o[String.fromCharCode(i)]=i;for(i=1;i<l;i++)n=e[i],r=a+n,hasOwnProperty.call(o,r)?a=r:(t(o[a]),s<p&&(s++,o[r]=s),a=n);for(t(o[a]),h&&m.push(u[d<<6-h&63]);m.length%4;)m.push("A");return m.join("")}function toggleShow(e){document.getElementById(e).classList.toggle("show")}function toggleInvisible(e){document.getElementById(e).classList.toggle("invisible")}function makeVisible(e){for(var t=document.getElementById(e).classList,n=!1,i=0;i<t.length;i++)"invisible"==t[i]&&(n=!0);n&&toggleInvisible(e)}function makeInvisible(e){for(var t=document.getElementById(e).classList,n=!1,i=0;i<t.length;i++)"invisible"==t[i]&&(n=!0);n||toggleInvisible(e)}function filterDropdown(e,t){var n,i,r,o;for(n=document.getElementById(t),i=n.value.toUpperCase(),div=document.getElementById(e),r=div.getElementsByTagName("a"),o=0;o<r.length;o++)txtValue=r[o].textContent||r[o].innerText,txtValue.toUpperCase().indexOf(i)>-1?r[o].style.display="":r[o].style.display="none"}function dropdownRowClick(e,t,n){input=document.getElementById(n),input.value=e.text,toggleShow(t)}function toggleDropdownA(){toggleShow("dropdownA")}function toggleDropdownB(){toggleShow("dropdownB")}function filterDropdownA(){filterDropdown("dropdownA","routeInputA")}function filterDropdownB(){filterDropdown("dropdownB","routeInputB")}function dropdownArowClick(e){dropdownRowClick(e,"dropdownA","routeInputA")}function dropdownBrowClick(e){dropdownRowClick(e,"dropdownB","routeInputB")}Array.prototype.forEach||(Array.prototype.forEach=function(e){var t,n;if(null===this)throw new TypeError("this is null or not defined");var i=Object(this),r=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(t=arguments[1]),n=0;n<r;){var o;n in i&&(o=i[n],e.call(t,o,n,i)),n++}}),window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),Object.entries||(Object.entries=function(e){for(var t=Object.keys(e),n=t.length,i=new Array(n);n--;)i[n]=[t[n],e[t[n]]];return i}),Object.values||(Object.values=function(e){return Object.keys(e).map(function(t){return e[t]})}),"function"!=typeof Object.assign&&(Object.assign=function(e,t){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),i=1;i<arguments.length;i++){var r=arguments[i];if(null!=r)for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(n[o]=r[o])}return n}),Array.from||(Array.from=function(){var e=Object.prototype.toString,t=function(t){return"function"==typeof t||"[object Function]"===e.call(t)},n=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t},i=Math.pow(2,53)-1,r=function(e){var t=n(e);return Math.min(Math.max(t,0),i)};return function(e){var n=this,i=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var o,a=arguments.length>1?arguments[1]:void 0;if("undefined"!=typeof a){if(!t(a))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(o=arguments[2])}for(var s,l=r(i.length),c=t(n)?Object(new n(l)):new Array(l),u=0;u<l;)s=i[u],a?c[u]="undefined"==typeof o?a(s,u):a.call(o,s,u):c[u]=s,u+=1;return c.length=l,c}}()),String.prototype.includes||(String.prototype.includes=function(e,t){"use strict";return"number"!=typeof t&&(t=0),!(t+e.length>this.length)&&this.indexOf(e,t)!==-1}),function(e){var t={_updateZIndex:function(e){this._icon.style.zIndex=this.options.forceZIndex?this.options.forceZIndex+(this.options.zIndexOffset||0):this._zIndex+e},setForceZIndex:function(e){this.options.forceZIndex=e?e:null}};e&&e.include(t)}(L.Marker),"remove"in Element.prototype||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)}),HTMLElement.prototype._getBoundingClientRect=HTMLElement.prototype.getBoundingClientRect,HTMLElement.prototype.getBoundingClientRect=function(){try{return this._getBoundingClientRect()}catch(e){return{top:this.offsetTop,left:this.offsetLeft}}},Array.prototype.includes||(Array.prototype.includes=function(e){return!!~this.indexOf(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t,n){"use strict";return function(i,r){if(null===this||void 0===this)throw TypeError("Array.prototype.indexOf called on null or undefined");var o=e(this),a=o.length>>>0,s=n(0|r,a);if(s<0)s=t(0,a+s);else if(s>=a)return-1;if(void 0===i){for(;s!==a;++s)if(void 0===o[s]&&s in o)return s}else if(i!==i){for(;s!==a;++s)if(o[s]!==o[s])return s}else for(;s!==a;++s)if(o[s]===i)return s;return-1}}(Object,Math.max,Math.min)),"undefined"==typeof Seadragon2&&(window.Seadragon2={});var SD=Seadragon2,SD_VERSION=SD.VERSION="2.0.pre";SD.toString=function(){return"Seadragon Ajax v"+SD_VERSION+"\nCopyright (c) Microsoft Corp."};var SDPoint=SD.Point=function(e,t){this.x=e||0,this.y=t||0},SDPoint_$=SDPoint.$=function(e){return e instanceof SDPoint?e:(e=e||{},new SDPoint(e.x,e.y))},SDPointPrototype=SDPoint.prototype,SDPoint_origin=new SDPoint(0,0);SDPointPrototype.plus=function(e){return new SDPoint(this.x+e.x,this.y+e.y)},SDPointPrototype.minus=function(e){return new SDPoint(this.x-e.x,this.y-e.y)},SDPointPrototype.times=function(e){return new SDPoint(this.x*e,this.y*e)},SDPointPrototype.divide=function(e){return new SDPoint(this.x/e,this.y/e)},SDPointPrototype.negate=function(){return new SDPoint((-this.x),(-this.y))},SDPointPrototype.apply=function(e){return new SDPoint(e(this.x),e(this.y))},SDPointPrototype.distanceTo=function(e){var t=this.x-e.x,n=this.y-e.y;return Math.sqrt(t*t+n*n)},SDPointPrototype.asSize=function(){return new SDSize(this.x,this.y)},SDPointPrototype.equals=function(e){return this.x===(e.x||0)&&this.y===(e.y||0)},SDPointPrototype.toString=function(){return["(",this.x,",",this.y,")"].join("")};var SDSize=SD.Size=function(e,t){this.width=e||0,this.height=t||0},SDSize_$=SDSize.$=function(e){return e instanceof SDSize?e:(e=e||{},new SDSize(e.width,e.height))},SDSizePrototype=SDSize.prototype;SDSizePrototype.plus=function(e){return new SDSize(this.width+e.width,this.height+e.height)},SDSizePrototype.minus=function(e){return new SDSize(this.width-e.width,this.height-e.height)},SDSizePrototype.times=function(e){return new SDSize(this.width*e,this.height*e)},SDSizePrototype.divide=function(e){return new SDSize(this.width/e,this.height/e)},SDSizePrototype.negate=function(){return new SDSize((-this.width),(-this.height))},SDSizePrototype.apply=function(e){return new SDSize(e(this.width),e(this.height))},SDSizePrototype.asPoint=function(){return new SDPoint(this.width,this.height)},SDSizePrototype.equals=function(e){return this.width===(e.width||0)&&this.height===(e.height||0)},SDSizePrototype.toString=function(){return["(",this.width,"x",this.height,")"].join("")};var SDRect=SD.Rect=function(e,t,n,i){e&&void 0===n&&void 0!==e.x&&(n=t.width,i=t.height,t=e.y,e=e.x),this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0},SDRect_$=SDRect.$=function(e){return e instanceof SDRect?e:new SDRect(e.x,e.y,e.width,e.height)},SDRectPrototype=SDRect.prototype,SDRect_unitRect=new SDRect(0,0,1,1),SDRect_nullRect=new SDRect((-1),(-1),(-1),(-1));SDRectPrototype.getArea=function(){return this.width*this.height},SDRectPrototype.getAspectRatio=function(){return this.width/this.height},SDRectPrototype.getNormHeight=function(){return this.height/this.width},SDRectPrototype.getTopLeft=function(){return new SDPoint(this.x,this.y)},SDRectPrototype.getBottomRight=function(){return new SDPoint(this.x+this.width,this.y+this.height)},SDRectPrototype.getCenter=function(){return new SDPoint(this.x+this.width/2,this.y+this.height/2)},SDRectPrototype.getSize=function(){return new SDSize(this.width,this.height)},SDRectPrototype.contains=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+(e.width||0),r=e.y+(e.height||0);return this.x<=e.x&&this.y<=e.y&&t>=i&&n>=r},SDRectPrototype.union=function(e){var t=Math.min(this.x,e.x),n=Math.min(this.y,e.y),i=Math.max(this.x+this.width,e.x+(e.width||0)),r=Math.max(this.y+this.height,e.y+(e.height||0));return new SDRect(t,n,i-t,r-n)},SDRectPrototype.intersect=function(e){var t=Math.max(this.x,e.x),n=Math.max(this.y,e.y),i=-t+Math.min(this.x+this.width,e.x+(e.width||0)),r=-n+Math.min(this.y+this.height,e.y+(e.height||0));return i||r||e instanceof SDRect?i<0||r<0?null:new SDRect(t,n,i,r):new SDPoint(t,n)},SDRectPrototype.scale=function(e,t){var n=t?t.x:this.x,i=t?t.y:this.y;return new SDRect(n-e*(n-this.x),i-e*(i-this.y),this.width*e,this.height*e)},SDRectPrototype.translate=function(e){return new SDRect(this.x+(e.x||0),this.y+(e.y||0),this.width,this.height)},SDRectPrototype.equals=function(e){return this.x===(e.x||0)&&this.y===(e.y||0)&&this.width===(e.width||0)&&this.height===(e.height||0)},SDRectPrototype.toString=function(){return["[",this.x,",",this.y,"|",this.width,"x",this.height,"]"].join("")};var SDString=SD.String={},SDString_format=SDString.format=function(e,t){var n,i;if(2===arguments.length&&t&&t.constructor&&(t.constructor===Array||t.constructor===Object))n=t;else for(n=new Array(arguments.length-1),i=0;i<n.length;i++)n[i]=arguments[i+1];return e.replace(/\{[\d\w]+\}/g,function(e){var t=e.match(/[\d\w]+/);return n[t]||""})},SDDebug=SD.Debug={alert:0,enabled:3},SDDebug_log=SDDebug.log=function(e,t){SDDebug.enabled<3||(arguments.length>1&&(e=SDString_format.apply(this,arguments)),"undefined"!=typeof console&&console.log?console.log(e):SDDebug.alert>=3&&alert(e))},SDDebug_warn=SDDebug.warn=function(e){SDDebug.enabled<2||(arguments.length>1&&(e=SDString_format.apply(this,arguments)),"undefined"!=typeof console&&console.warn?console.warn(e):SDDebug.alert>=2&&alert(e))},SDDebug_error=SDDebug.error=function(e,t){if(!(SDDebug.enabled<1))throw"undefined"!=typeof console&&console.error?console.error(e):SDDebug.alert>=1&&alert(e),t||new Error(e)},SDObject=SD.Object={},SDObject_extend=SDObject.extend=function(e,t,n){for(var i in t)(n||t.hasOwnProperty(i))&&(e[i]=t[i]);return e},SDObject_clone=SDObject.clone=function(e,t){return SDObject_extend({},e,t)},SDFunction=SD.Function={},SDFunction_EMPTY=SDFunction.EMPTY=function(){},SDFunction_bind=SDFunction.bind=function(e,t,n){var i,r=new Array(arguments.length-2),o=r.length;for(i=0;i<o;i++)r[i]=arguments[i+2];return"string"==typeof t&&(t=e[t]),function(){var n,i=arguments.length;for(n=0;n<i;n++)r.push(arguments[n]);t.apply(e,r)}},SDFunction_callback=SDFunction.callback=function(e,t){var n,i=arguments.length,r=new Array(i+1);for(r[0]=null,n=0;n<i;n++)r[n+1]=arguments[n];return SDFunction_bind.apply(SDFunction,r)},SDFunction_delay=SDFunction.delay=function(e,t){return function(){setTimeout(SDFunction_bind(this,e),t)}},SDBrowser=SD.Browser={},SDBrowser_TRIDENT=SDBrowser.TRIDENT="Trident",SDBrowser_GECKO=SDBrowser.GECKO="Gecko",SDBrowser_WEBKIT=SDBrowser.WEBKIT="Webkit",SDBrowser_PRESTO=SDBrowser.PRESTO="Presto",SDBrowser_IE=SDBrowser.IE="IE",SDBrowser_FF=SDBrowser.FIREFOX="Firefox",SDBrowser_SAFARI=SDBrowser.SAFARI="Safari",SDBrowser_CHROME=SDBrowser.CHROME="Chrome",SDBrowser_OPERA=SDBrowser.OPERA="Opera",SDBrowser_isIE,SDBrowser_isFF,SDBrowser_isSafari,SDBrowser_isChrome,SDBrowser_isGecko,SDBrowser_isWebkit,SDBrowser_isOpera;!function(){var e=SDBrowser_parseUserAgent(navigator.userAgent),t=e.name,n=e.version,i=parseInt(n),r=(parseFloat(n),e.engine),o=e.engineVersion;parseFloat(o);SDBrowser.name=t,SDBrowser.version=n,SDBrowser.engine=r,SDBrowser.engineVersion=o,e.name===SDBrowser_IE?SDBrowser_isIE=i:e.name===SDBrowser_FF?SDBrowser_isFF=i:e.name===SDBrowser_SAFARI?SDBrowser_isSafari=i:e.name===SDBrowser_CHROME&&(SDBrowser_isChrome=i)}();var SDMath=SD.Math={},SDMath_max=Math.max,SDMath_min=Math.min,SDMath_clamp=SDMath.clamp=function(e,t,n){return SDMath_max(t,SDMath_min(n,e))},SDMath_ln=Math.log,SDMath_LN2=Math.LN2,SDMath_LN10=Math.LN10,SDMath_exp=Math.exp,SDMath_log=SDMath.log=function(e,t){return t?SDMath_ln(e)/SDMath_ln(t):SDMath_ln(e)},SDMath_log2=SDMath.log2=function(e){return SDMath_ln(e)/SDMath_LN2},SDMath_log10=SDMath.log10=function(e){return SDMath_ln(e)/SDMath_LN10},SDMath_morton=SDMath.morton=function(e){var t,n,i,r,o,a=arguments[0];for("object"==typeof a?(t=a.x,n=a.y):(t=a,n=arguments[1]),i=0,r=0,o=1;o<=t||o<=n;)o&t&&(i|=1<<2*r+1),o&n&&(i|=1<<2*r),r++,o=1<<r;return i},SDMath_reverseMorton=SDMath.reverseMorton=function(e){for(var t,n=[],i=[],r=0,o=0;e>0;)i.push(e%2),e>>=1,n.push(e%2),e>>=1;for(t=0;t<n.length;t++)r+=(1<<t)*n[t];for(t=0;t<i.length;t++)o+=(1<<t)*i[t];return new SDPoint(r,o)},SDMath_ceil=Math.ceil,SDMath_floor=Math.floor,SDMath_round=SDMath.round=function(e,t,n){return"undefined"==typeof n&&(n=1),"undefined"==typeof t&&(t=.5),e/=n,(e%1+1)%1<t?SDMath_floor(e)*n:SDMath_ceil(e)*n},SDUri=SD.Uri={},SDUri_FILE_HOSTNAME=SDUri.FILE_HOSTNAME="localhost",SDUri_PAGE_HOSTNAME=location.hostname||SDUri_FILE_HOSTNAME,SDUri_getHostname=SDUri.getHostname=function(e){var t,n=/^http[s]?:\/\/([\w-.]+)/i.exec(e);return n?n[1].toLowerCase():(t=/^file:\/\//i.exec(e))?SDUri_FILE_HOSTNAME:SDUri_PAGE_HOSTNAME},SDXml=SD.Xml={},SDXml_fetch=SDXml.fetch=function(){function e(e,t){return function(){4===this.readyState&&(0===this.status||this.status>=200&&this.status<300?e.call(this):t.call(this))}}var t,n,i,r,o=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml3.XMLHTTP"],a="undefined"!=typeof XDomainRequest;if("undefined"!=typeof XMLHttpRequest)i=XMLHttpRequest;else if("undefined"!=typeof ActiveXObject){for(n=0;n<o.length;n++){t=o[n];try{new ActiveXObject(t),i=ActiveXObject,r=t;break}catch(s){SDDebug_warn("Seadragon2.Xml: {0} ActiveX failed.",t)}}n>=o.length&&SDDebug_error("Seadragon2.Xml: no ActiveX worked.")}else SDDebug_error("Seadragon2.Xml: no fetching ability.");return i?function(t,n,o,s,l){var c=new i(r),u=s?"POST":"GET",d=!1;c.onreadystatechange=e(n,o),t=t.replace(/#.*/,"");try{c.open(u,t,!0)}catch(h){if(!a)throw h;c=new XDomainRequest,c.onload=n,c.onerror=o,c.timeout=3e4,c.ontimeout=function(){},c.onprogress=function(){},c.open(u,t),d=!0}return s&&c.setRequestHeader&&c.setRequestHeader("Content-Type",l||"text/plain"),d?setTimeout(function(){c.send(s||null)},0):c.send(s||null),c}:SDFunction_EMPTY}(),SDXml_parse=SDXml.parse=function(){return"undefined"!=typeof DOMParser?function(e){var t=new DOMParser,n=t.parseFromString(e,"text/xml"),i=n&&n.documentElement;return i&&"parsererror"!==i.nodeName?n:null}:"undefined"!=typeof ActiveXObject?function(e){var t=new ActiveXObject("Microsoft.XMLDOM");return t.async=!1,t.loadXML(e)&&t}:(SDDebug_error("Seadragon2.Xml: no parsing ability."),SDFunction_EMPTY)}(),SDElement=SD.Element={},SDElement_$=SDElement.$=function(e){return"string"==typeof e?document.getElementById(e):e},SDElement_getWindowDimensions=SDElement.getWindowDimensions=function(){return(SDElement_getWindowDimensions="undefined"!=typeof innerWidth?SDElement.getWindowDimensions=function(){return new SDRect(0,0,innerWidth,innerHeight)}:document.documentElement&&document.documentElement.clientHeight?SDElement.getWindowDimensions=function(){var e=document.documentElement;return new SDRect(0,0,e.clientWidth,e.clientHeight)}:document.body.clientHeight?SDElement.getWindowDimensions=function(){var e=document.body;return new SDRect(0,0,e.clientWidth,e.clientHeight)}:SDElement.getWindowDimensions=function(){return new SDRect(0,0,1/0,1/0)})()},SDElement_getBoundingClientRect=SDElement.getBoundingClientRect=function(e){var t=e.getBoundingClientRect();return new SDRect(t.left,t.top,t.right-t.left,t.bottom-t.top)},SDElement_getStyle=SDElement.getStyle=function(e){return window.getComputedStyle?getComputedStyle(e,null):e.currentStyle?e.currentStyle:void SDDebug_error("Unknown element style, no known technique.")},SDElement_getOffsetParent=SDElement.getOffsetParent=function(e,t){return t&&e!==document.body?document.body:e.offsetParent},SDElement_getPosition=SDElement.getPosition=function(e){for(var t=new SDPoint,n="fixed"===SDElement_getStyle(e).position,i=SDElement_getOffsetParent(e,n);i;)t.x+=e.offsetLeft,t.y+=e.offsetTop,n&&(t=t.plus(SDPage_getScroll())),e=i,n="fixed"===SDElement_getStyle(e).position,i=SDElement_getOffsetParent(e,n);return t},SDElement_getClippingBounds=SDElement.getClippingBounds=function(e,t,n){t=t||SDElement_getBoundingClientRect(e),n=n||SDElement_getWindowDimensions();var i,r,o,a,s=t.y,l=t.width+t.x,c=t.height+t.y,u=t.x,d=n.x,h=n.y,m=d+n.width,p=h+n.height;return i=SDMath_max(0,h-s),r=SDMath_max(0,d-u),o=SDMath_min(l,m)-u-r,a=SDMath_min(c,p)-s-i,new SDRect(r,i,o,a)},SDElement_setOpacity=SDElement.setOpacity=function(){var e=document.createElement("div");return"undefined"!=typeof e.style.opacity?function(e,t){e.style.opacity=t}:"undefined"!=typeof e.style.filter?function(e,t){var n,i,r,o="progid:DXImageTransform.Microsoft.Alpha(Opacity="+100*t+")";for(e.style.filter=o,n=e.children,r=n.length,i=0;i<r;i++)try{SDElement_setOpacity(n[i],t)}catch(a){}}:function(){}}(),SDElement_customElements={},SDElement_dce=document.createElement,SDElement_registerCustomElement=function(e,t){SDElement_customElements["sd_"+e]=t,SDElement_dce.call(document,e)},SDElement_transform=SDElement.transform=function(){var e,t,n,i,r=["MozTransform","msTransform","OTransform","WebkitTransform","transform"],o=document.documentElement.style,a="";for(e=r.length-1;e>=0;e--)if("undefined"!=typeof o[r[e]]){t=r[e],n=t+"Origin";break}return"MozTransform"===t&&(a="px"),i=t?function(e,i,r,o){var s=e.sdStyle;s||(s=e.sdStyle=e.style,s[n]="0 0"),i+=a,r+=a,o+=",",s[t]="matrix("+o+"0,0,"+o+i+","+r+")"}:function(e,t,n,i){var r=e.style;r.left=t+"px",r.top=n+"px",r.fontSize=i+"em",r.width=100*i+"%",r.height=100*i+"%"}}();document.createElement=function(e){var t=SDElement_customElements["sd_"+e];return t?new t:SDElement_dce.apply(this,arguments)};var SDEvent=SD.Event={},SDEvent_$=SDEvent.$=function(e){return e?e:"undefined"!=typeof event?event:null},SDEvent_raise=SDEvent.raise=function(){return document.createEvent?function(e,t,n){n=n||!1;var i=document.createEvent("HTMLEvents");return i.initEvent(t,n,!0),e.dispatchEvent(i)}:document.createEventObject?function(e,t){var n=document.createEventObject();try{return e.fireEvent("on"+t,n)}catch(i){SDDebug_warn("Event not fired: "+t+". "+i.message)}}:(SDDebug_error("Seadragon2.Event: no raise ability."),SDFunction_EMPTY)}(),SDEvent_cancel=function(e){
e=SDEvent_$(e),e.preventDefault&&e.preventDefault(),e.cancel=!0,e.returnValue=!1},SDEvent_stop=function(e){e=SDEvent_$(e),e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0},SDEvent_add=SDEvent.add=function(){return"function"==typeof addEventListener?function(e,t,n,i){i=i||!1,e.addEventListener(t,n,i),"mousewheel"===t?e.addEventListener("DOMMouseScroll",n,i):"DOMMouseScroll"===t&&e.addEventListener("mousewheel",n,i)}:"undefined"!=typeof attachEvent?function(e,t,n,i){e.attachEvent("on"+t,n),"DOMMouseScroll"===t&&e.attachEvent("onmousewheel",n),i&&e.setCapture&&e.setCapture()}:(SDDebug_error("Seadragon2.Event: no add ability."),SDFunction_EMPTY)}(),SDEvent_remove=SDEvent.remove=function(){return"function"==typeof removeEventListener?function(e,t,n,i){i=i||!1,e.removeEventListener(t,n,i),"mousewheel"===t?e.removeEventListener("DOMMouseScroll",n,i):"DOMMouseScroll"===t&&e.removeEventListener("mousewheel",n,i)}:"undefined"!=typeof detachEvent?function(e,t,n,i){e.detachEvent("on"+t,n),"DOMMouseScroll"===t&&e.detachEvent("onmousewheel",n),i&&e.releaseCapture&&e.releaseCapture()}:(SDDebug_error("Seadragon2.Event: no remove ability."),SDFunction_EMPTY)}(),SDTimer=SD.Timer=new function(){function e(){var e,t,n=(new Date).getTime();for(e=s;e;e=e.next)t=e.callback(e.arg,n),t||a.unregister(e)}var t,n,i,r,o,a=this,s=null,l=16,c=null;this.register=function(e,t){var i={callback:e,arg:t};return i.next=s,s&&(s.prev=i),i.prev=null,s=i,n(),i},this.unregister=function(e){e.dead||(e.next&&(e.next.prev=e.prev),e.prev?e.prev.next=e.next:s=e.next,s||i(),e.dead=!0)},"function"==typeof requestAnimationFrame?r=requestAnimationFrame:"function"==typeof mozRequestAnimationFrame?r=mozRequestAnimationFrame:"function"==typeof webkitRequestAnimationFrame?r=webkitRequestAnimationFrame:"function"==typeof msRequestAnimationFrame&&(r=msRequestAnimationFrame),r?(t=function(){return o?(o=!1,void(c=null)):(e(),void r(t))},n=function(){o=!1,c||(c=!0,r(t))},i=function(){c&&(o=!0)}):(n=function(){null===c&&(c=setInterval(e,l))},i=function(){null!==c&&(clearInterval(c),c=null)})},SDEventManager=SD.EventManager=function(){var e={};this.addListener=function(t,n){"function"==typeof n&&(e.hasOwnProperty(t)||(e[t]=[]),e[t].push(n))},this.removeListener=function(t,n){var i=e[t];if("function"==typeof n&&i){var r,o=i.length;for(r=0;r<o;r++)if(n===i[r])return void i.splice(r,1)}},this.clearListeners=function(t){e.hasOwnProperty(t)&&delete e[t]},this.listListeners=function(t){if(e.hasOwnProperty(t)){var n=e[t];if(n&&n.length)return n.slice(0)}},this.trigger=function(t){var n=e[t],i=[].slice.call(arguments,1);if(n){n=n.slice(0);var r,o=n.length;for(r=0;r<o;r++)try{n[r].apply(window,i)}catch(a){SDDebug_warn(a.name+" while executing "+t+" handler: "+a.message,a)}}}},SDMouse=SD.Mouse={},SDMouse_getPosition=SDMouse.getPosition=function(e){var t=new SDPoint;return"DOMMouseScroll"===e.type&&SDBrowser_isFF<3?(t.x=e.screenX,t.y=e.screenY):"number"==typeof e.pageX?(t.x=e.pageX,t.y=e.pageY):"number"==typeof e.clientX?(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop):SDDebug_error("Unknown event mouse position, no known technique."),t},SDMouse_getScroll=SDMouse.getScroll=function(e){var t=0;return"number"==typeof e.wheelDelta?t=e.wheelDelta:"number"==typeof e.detail?t=-e.detail:Seadragon2.Debug.fail("Unknown event mouse scroll, no known technique."),t?t/Math.abs(t):0};SDTileCache.prototype.insert=function(e){var t=null;return this.capacity<=0&&(t=this.oldest,this.remove(t)),this.capacity--,e.cacheOlder=this.newest,this.newest?this.newest.cacheNewer=e:this.oldest=e,this.newest=e,e.cacheNewer=null,t},SDTileCache.prototype.remove=function(e){this.capacity++,e.cacheOlder?e.cacheOlder.cacheNewer=e.cacheNewer:this.oldest=e.cacheNewer,e.cacheNewer?e.cacheNewer.cacheOlder=e.cacheOlder:this.newest=e.cacheOlder},SDTileCache.prototype.refresh=function(e){this.remove(e),this.insert(e)};var SDTileInfo=SD.TileInfo=function(e,t){this.url=e,this.crop=t?SDRect_$(t):null},SDTileInfo_$=SDTileInfo.$=function(e){return e instanceof SDTileInfo?e:"string"==typeof e?new SDTileInfo(e,null):new SDTileInfo(e.url,e.crop)},SDTileSource=SD.TileSource=function(e,t,n,i,r,o,a){3===arguments.length&&"object"==typeof n&&(i=n.height,n=n.width);var s=SDMath_log2(Math.max(e,t)),l=SDMath_ceil(s),c=SDMath_log2(n);this.width=e,this.height=t,this.tileWidth=n||i,this.tileHeight=i||n,this.tileOverlap=r||0,this.minLevel=SDMath_clamp(o||0,0,l),this.overviewLevel=SDMath_clamp("number"==typeof a?a:c,this.minLevel,l),this.dimensions=new SDSize(e,t),this.aspectRatio=e/t,this.normHeight=t/e,this.tileSize=new SDSize(this.tileWidth,this.tileHeight),this.maxLevel=l,this.sharpen=l-s},SDTileSource_$=SDTileSource.$=function(e){var t,n,i,r;if(e instanceof SDTileSource)return e;"object"==typeof e.tileSize?(i=e.tileSize.width,r=e.tileSize.height):"number"==typeof e.tileSize&&(i=r=e.tileSize),t=new SDTileSource(e.width,e.height,e.tileWidth||i,e.tileHeight||r,e.tileOverlap,e.minLevel,e.maxLevel);for(n in e)e.hasOwnProperty(n)&&"tileSize"!==n&&(t[n]=e[n]);return t},SDTileSourcePrototype=SDTileSource.prototype;SDTileSourcePrototype.getLevelScale=function(e){var t=this.maxLevel-e;return t<31?1/(1<<t):Math.pow(.5,t)},SDTileSourcePrototype.getNumTiles=function(e){var t=this.getLevelScale(e);return new SDSize(Math.ceil(t*this.width/this.tileWidth),Math.ceil(t*this.height/this.tileHeight))},SDTileSourcePrototype.getPixelRatio=function(e){var t=this.getLevelDimensions(e);return new SDSize(1/t.width,1/t.height)},SDTileSourcePrototype.getTileAtPoint=function(e,t,n){var i=SDPoint_$(t).times(this.getLevelDimensions(e).width);return n&&(i.x%1===0&&i.x--,i.y%1===0&&i.y--),new SDPoint(Math.floor(i.x/this.tileWidth),Math.floor(i.y/this.tileHeight))},SDTileSourcePrototype.getTilesInRect=function(e,t){var n,i,r,o,a=this.getTileAtPoint(e,t.getTopLeft()),s=this.getTileAtPoint(e,t.getBottomRight(),!0),l=this.getNumTiles(e);return n=SDMath_max(a.x,0),r=SDMath_max(a.y,0),i=SDMath_min(s.x,l.width-1),o=SDMath_min(s.y,l.height-1),new SDRect(n,r,i-n,o-r)},SDTileSourcePrototype.getTileBounds=function(e,t,n){var i,r,o=this.getLevelDimensions(e),a=1/o.width,s=this.normHeight/o.height;return i=0===t?0:this.tileWidth*t-this.tileOverlap,r=0===n?0:this.tileHeight*n-this.tileOverlap,new SDRect(a*i,s*r,a*Math.min(this.tileWidth+(0===t?1:2)*this.tileOverlap,o.width-i),s*Math.min(this.tileHeight+(0===n?1:2)*this.tileOverlap,o.height-r))},SDTileSourcePrototype.getTileInfo=function(e,t,n){return null},SDTileSourcePrototype.levelExists=function(e){return!0},SDTileSourcePrototype.tileExists=function(e,t,n){return!0},SDTileSourcePrototype.getLevelDimensions=function(e){return this.dimensions.times(this.getLevelScale(e)).apply(SDMath_ceil)},SDTileSourcePrototype.getTileBelow=function(e,t,n,i){var r,o,a;return"undefined"==typeof i&&(i=e-1),i<this.minLevel||!this.levelExists(i)?null:(r=this.getLevelScale(e),o=this.getLevelScale(i),a=o/r,new SDPoint(SDMath_floor(t*a),SDMath_floor(n*a)))},SDTileSourcePrototype.getTilesAbove=function(e,t,n,i){var r,o,a,s,l;return"undefined"==typeof i&&(i=e+1),i>this.maxLevel||!this.levelExists(i)?null:(l=this.getNumTiles(i),r=this.getLevelScale(e),o=this.getLevelScale(i),a=o/r,s=new SDRect(t*a,n*a,a-1,a-1),s.x+s.width>=l.width&&(s.width=l.width-s.x-1),s.y+s.height>=l.height&&(s.height=l.height-s.y-1),s)},SDTileSourcePrototype.getNumTilesAbove=function(e,t,n,i){var r=this.getTilesAbove(e,t,n,i);return r?(r.width+1)*(r.height+1):1/0};var SDDisplayRect=SD.DisplayRect=function(e,t,n,i,r,o){this.base(e,t,n,i),this.base=this.base.prototype,this.minLevel=r||0,this.maxLevel=o||Number.POSITIVE_INFINITY},SDDisplayRect$=SDDisplayRect.$=function(e){return e instanceof SDDisplayRect?e:new SDDisplayRect(e.x,e.y,e.width,e.height,e.minLevel,e.maxLevel)},SDDisplayRectPrototype=SDDisplayRect.prototype=new SDRect;SDDisplayRectPrototype.base=SDRect,SDDisplayRectPrototype.equals=function(e){return this.base.equals.call(this,e)&&(this.minLevel===e.minLevel||0)&&(this.maxLevel===e.maxLevel||0)},SDDisplayRectPrototype.toString=function(){return this.base.toString.call(this).replace("]",["|",this.minLevel,"-",this.maxLevel,"]"].join(""))};var SDDziTileSource=SD.DziTileSource=function(e,t,n,i,r,o,a){this.base(e,t,n,n,i),this.base=this.base.prototype,this.tilesUrl=r,this.imageFormat=o,this.displayRects=a,this.isSparse=!!(a&&a.length>1),this.displayRectsByLevel=function(){var e,t,n,i,r,o=this.displayRects,a={};if(!this.isSparse)return null;for(e=0;e<o.length;e++)for(t=o[e],i=Math.max(t.minLevel,this.minLevel),r=Math.min(t.maxLevel,this.maxLevel),n=i;n<=r;n++)a[n]?a[n].push(t):a[n]=[t];return a}.call(this)},SDDziTileSource$=SDDziTileSource.$=function(e){var t;return e instanceof SDDziTileSource?e:(t=e.tileSize,"object"==typeof t&&(t=t.width||t.height),new SDDziTileSource(e.width,e.height,t||e.tileWidth||e.tileHeight,e.tileOverlap,e.tilesUrl,e.imageFormat,e.displayRects))},SDDziTileSourcePrototype=SDDziTileSource.prototype=new SDTileSource;SDDziTileSourcePrototype.base=SDTileSource,SDDziTileSourcePrototype.getTileInfo=function(e,t,n){return[this.tilesUrl,e,"/",t,"_",n,".",this.imageFormat].join("")},SDDziTileSourcePrototype.tileExists=function(e,t,n){var i,r,o,a,s,l,c,u,d,h,m,p;if(!this.isSparse)return!0;if(o=this.displayRectsByLevel[e],!o||!o.length)return!1;for(i=0;i<o.length;i++)if(r=o[i],a=this.getLevelScale(e),s=r.x*a,c=r.y*a,l=s+r.width*a,u=c+r.height*a,d=Math.floor(s/this.tileWidth),m=Math.floor(c/this.tileHeight),h=Math.ceil(l/this.tileWidth),p=Math.ceil(u/this.tileHeight),d<=t&&t<h&&m<=n&&n<p)return!0;return!1},SDDziTileSourcePrototype.getTileBelow=function(e,t,n,i){return void 0===i&&(i=e-1),i<=this.dzcMaxLevel?i<this.minLevel||!this.levelExists(i)?null:SDPoint_origin:SDTileSourcePrototype.getTileBelow.call(this,e,t,n,i)};var SDDzcTileSource=SD.DzcTileSource=function(e,t,n,i,r,o,a,s,l){this.base(e,t,n),this.base=this.base.prototype,this.dzcTileSize=n,this.dzcMaxLevel=i,this.dzcItemId=r,this.dzcTilesUrl=o,this.dzcImageFormat=a,this.dzcExpansionUrl=l,this.dziSource=null,this.dziSourceRequested=!1,this.dzcItemCoords=SDMath_reverseMorton(s)},SDDzcTileSource$=SDDzcTileSource.$=function(e){return e instanceof SDDzcTileSource?e:new SDDzcTileSource(e.width,e.height,e.dzcTileSize,e.dzcMaxLevel,e.dzcItemId,e.dzcTilesUrl,e.dzcImageFormat,e.dzcItemN,e.dzcExpansionUrl)},SDDzcTileSourcePrototype=SDDzcTileSource.prototype=new SDTileSource;SDDzcTileSourcePrototype.base=SDTileSource,SDDzcTileSourcePrototype.isDzc=!0,SDDzcTileSourcePrototype.getTileInfo=function(e){var t=1<<e,n=this.dzcTileSize/(1<<e),i=this.getLevelScale(e),r=this.dzcItemCoords.y,o=this.dzcItemCoords.x,a=Math.floor(r/n),s=Math.floor(o/n);return new SDTileInfo([this.dzcTilesUrl,e,"/",a,"_",s,".",this.dzcImageFormat].join(""),new SDRect(r%n*t,o%n*t,Math.max(1,Math.floor(i*this.width)),Math.max(1,Math.floor(i*this.height))))},SDDzcTileSourcePrototype.levelExists=function(e){return e<=this.dzcMaxLevel},SDDzcTileSourcePrototype.getTilesAbove=function(e,t,n,i){if(void 0===i&&(i=e+1),i>this.dzcMaxLevel){var r,o=this.dziSource;return o&&(r=this.getNumTiles(i))?new SDRect(0,0,r.width-1,r.height-1):null}return new SDRect(0,0,0,0)},function(){var e;for(e in SDDzcTileSourcePrototype)!function(){var t=e,n=SDDzcTileSourcePrototype[t];"base"!==t&&"function"==typeof n&&(SDDzcTileSourcePrototype[t]=function(e,i,r,o){var a=this.dziSource;return e>this.dzcMaxLevel&&a?a[t](e,i,r,o):n.call(this,e,i,r,o)})}()}(),SDDzcTileSourcePrototype.expand=function(){var e;this.dziSource||this.dziSourceRequested||!this.dzcExpansionUrl||(this.dziSourceRequested=!0,e=this,SDDeepZoom_fetchTileSource(this.dzcExpansionUrl,function(t){e.dziSource=t,t.dzcMaxLevel=e.dzcMaxLevel}))},SDDzcTileSourcePrototype.contract=function(){this.dziSource=null,this.dziSourceRequested=!1};var SDDeepZoom=SD.DeepZoom={},SDDeepZoom_storedXml={},SDDeepZoom_parseDziXml=function(e){var t,n,i,r,o=e.getElementsByTagName("Size")[0],a=e.getElementsByTagName("DisplayRect"),s={width:parseInt(o.getAttribute("Width"),10),height:parseInt(o.getAttribute("Height"),10),tileSize:parseInt(e.getAttribute("TileSize"),10),tileOverlap:parseInt(e.getAttribute("Overlap"),10),imageFormat:e.getAttribute("Format"),dispRects:[]};for(t=0;t<a.length;t++)n=a[t],i=n.getElementsByTagName("Rect")[0],r=new SDDisplayRect(parseInt(i.getAttribute("X"),10),parseInt(i.getAttribute("Y"),10),parseInt(i.getAttribute("Width"),10),parseInt(i.getAttribute("Height"),10),0,parseInt(n.getAttribute("MaxLevel"),10)),s.dispRects.push(r);return s},SDDeepZoom_parseDzcXml=function(e){var t,n,i,r,o,a,s,l=e.getAttribute("Format"),c=parseInt(e.getAttribute("MaxLevel"),10),u=parseInt(e.getAttribute("TileSize"),10),d=e.getElementsByTagName("I"),h=d.length,m=new Array(h);for(t=0;t<d.length;t++)n=d[t],i=n.getElementsByTagName("Size")[0],r=n.getElementsByTagName("Viewport"),o={id:parseInt(n.getAttribute("Id"),10),n:parseInt(n.getAttribute("N"),10),width:parseInt(i.getAttribute("Width"),10),height:parseInt(i.getAttribute("Height"),10),source:n.getAttribute("Source"),viewport:null,dzcTileSize:u,dzcMaxLevel:c,dzcImageFormat:l},r.length>=1&&(a=r[0],s=parseFloat(a.getAttribute("Width")),o.viewport=new SDRect(parseFloat(a.getAttribute("X")),parseFloat(a.getAttribute("Y")),s,s*o.height/o.width)),m[t]=o;return m},SDDeepZoom_parseXml=function(e){var t,n;return"string"==typeof e&&(e=SDXml_parse(e)),e&&e.documentElement?(t=e.documentElement,n=t.tagName,"Image"===n?SDDeepZoom_parseDziXml(t):"Collection"===n?SDDeepZoom_parseDzcXml(t):null):null},SDDeepZoom_getTilesUrl=SDDeepZoom.getTilesUrl=function(e){var t=e.split("/"),n=t.length-1,i=t[n],r=i.lastIndexOf(".");return r>-1&&(t[n]=i.slice(0,r)),t.join("/")+"_files/"},SDDeepZoom_getExpansionUrl=function(e,t){return t?e.substr(0,e.lastIndexOf("/"))+"/"+t:null},SDDeepZoom_makeDzcSources=function(e,t,n){var i,r,o=e.length,a=new Array(o);for(i=0;i<o;i++)r=e[i],r.dzcItemId=r.id,r.dzcItemN=r.n,r.dzcTilesUrl=n,r.dzcExpansionUrl=SDDeepZoom_getExpansionUrl(t,r.source),a[i]=SDDzcTileSource$(r);return a},SDDeepZoom_infoToTileSource=function(e,t){var n,i=SDDeepZoom_getTilesUrl(t);return e instanceof Array?(n=parseInt(t.substring(t.lastIndexOf("#")+1),10),isNaN(n)?SDDeepZoom_makeDzcSources(e,t,i):(e=e[n],e.dzcItemId=e.id,e.dzcItemN=e.n,e.dzcTilesUrl=i,e.dzcExpansionUrl=SDDeepZoom_getExpansionUrl(t,e.source),SDDzcTileSource$(e))):(e.tilesUrl=i,SDDziTileSource$(e))},SDDeepZoom_getTileSource=function(e,t){var n=SDDeepZoom_parseXml(t);return SDDeepZoom_infoToTileSource(n,e)},SDDeepZoom_fetchTileSource=SDDeepZoom.fetchTileSource=function(e,t){var n,i=e.split("#",1)[0],r=SDDeepZoom_storedXml[i];r?setTimeout(function(){t(SDDeepZoom_infoToTileSource(r,e))},0):(n=SDNetwork_tryMakeXmlHttpRequest(i,function(n,i,r){var o,a;if(i){if(a=SDDeepZoom_storedXml[n],!a){if(o=r.responseXML||r.responseText,a=SDDeepZoom_parseXml(o),!a)return;SDDeepZoom_storedXml[n]=a}t(SDDeepZoom_infoToTileSource(a,e))}else SDDebug_warn("DeepZoom.fetchTileSource (callback): XML fetch failed.")},!0),n||SDDebug_warn("DeepZoom.fetchTileSource: Failed to make request."))},SDNetwork=SD.Network={},SDNetwork_MAX_CONNECTIONS_PER_HOSTNAME=SDNetwork.MAX_CONNECTIONS_PER_HOSTNAME=6,SDNetwork_MAX_CONNECTIONS_TOTAL=SDNetwork.MAX_CONNECTIONS_TOTAL=30,SDNetwork_numRequestsTo={},SDNetwork_numRequestsTotal=0,SDNetwork_imageRequests={},SDNetwork_xmlHttpRequests={},SDNetwork_numSpotsAvailable=SDNetwork.numSpotsAvailable=function(e){var t=Math.max(0,SDNetwork_MAX_CONNECTIONS_TOTAL-(SDNetwork_numRequestsTotal||0));return e?Math.min(t,Math.max(0,SDNetwork_MAX_CONNECTIONS_PER_HOSTNAME-(SDNetwork_numRequestsTo[e]||0))):t},SDNetwork_markSpotOpen=SDNetwork.markSpotOpen=function(e){SDNetwork_numRequestsTo[e]=Math.max(0,(SDNetwork_numRequestsTo[e]||0)-1),SDNetwork_numRequestsTotal=Math.max(0,(SDNetwork_numRequestsTotal||0)-1)},SDNetwork_markSpotTaken=SDNetwork.markSpotTaken=function(e){SDNetwork_numRequestsTo[e]=(SDNetwork_numRequestsTo[e]||0)+1,SDNetwork_numRequestsTotal=(SDNetwork_numRequestsTotal||0)+1},SDNetwork_tryMakeImageRequest=SDNetwork.tryMakeImageRequest=SDNetwork_generateTryMakeRequestMethod(SDNetwork_imageRequests,function(e){var t=document.createElement("img");return t.onload=SDNetwork_onImageLoad,t.onerror=t.onabort=SDNetwork_onImageError,t.src=e,t}),SDNetwork_tryMakeXmlHttpRequest=SDNetwork.tryMakeXmlHttpRequest=SDNetwork_generateTryMakeRequestMethod(SDNetwork_xmlHttpRequests,function(e){return SDXml_fetch(e,SDNetwork_onXmlHttpSuccess,SDNetwork_onXmlHttpFailure)}),SDNetwork_onImageLoad=SDNetwork_generateResponseHandler(SDNetwork_imageRequests,!0),SDNetwork_onImageError=SDNetwork_generateResponseHandler(SDNetwork_imageRequests,!1),SDNetwork_onXmlHttpSuccess=SDNetwork_generateResponseHandler(SDNetwork_xmlHttpRequests,!0),SDNetwork_onXmlHttpFailure=SDNetwork_generateResponseHandler(SDNetwork_xmlHttpRequests,!1);Tile.prototype.resetCoverage=function(){this.covered=0},Tile.prototype.covers=function(){return this.drawnOpaque||this.tilesAbove===this.covered},Tile.prototype.isCovered=function(){return this.covered===this.tilesAbove},Tile.prototype.cover=function(){return this.covered++,this.covered>this.tilesAbove&&SDDebug_error("tile coverage is broken!"),this.covered===this.tilesAbove},Tile.prototype.uncover=function(){return this.covered--,this.covered<0&&SDDebug_error("tile coverage is broken"),this.covered+1===this.tilesAbove},Tile.prototype.drawn=function(){return(this.drawnOpaque||this.isCovered())&&SDDebug_error("tile coverage is broken"),this.drawnOpaque=!0,!0};var SDTileLoader_imgInfos={},SDTileLoader_trigger=!1,SDTileLoader_triggerProcessing,SDTileLoader_cache=new SDTileCache(1e3),SDTileLoader_nominations={},SDTileLoader_nullImgInfo={loading:!1,loaded:!1,failed:!1,img:null,owners:null,tileInfos:null};SDTileLoader_triggerProcessing=function(){SDTileLoader_trigger||(SDTileLoader_trigger=!0,setTimeout(SDTileLoader_processNominations,0))};var SDImageManager=SD.ImageManager={},SDImageManager_markupCheckToken=null,SDImageManager_isEnabled=!0;SDImageManager.register=function(e,t){if(SDImageManager_isEnabled)return SDTimer.register(e,t)},SDImageManager.unregister=function(e){return SDTimer.unregister(e)},SDImageManager.enableMarkupChecking=function(){SDImageManager_markupCheckToken||(SDImageManager_markupCheckToken=SDTimer.register(SDImageManager_checkForInit))},SDImageManager.disableMarkupChecking=function(){SDImageManager_markupCheckToken&&(SDTimer.unregister(SDImageManager_markupCheckToken),SDImageManager_markupCheckToken=null)},SDImageManager.enable=function(){SDImageManager_isEnabled=!0},SDImageManager.disable=function(){SDImageManager_isEnabled=!1};var SDDrawer_CANVAS_API_AVAILABLE="function"==typeof document.createElement("canvas").getContext,SDDrawer=function(e,t){this.container=e,this.normHeight=t},SDDrawerPrototype=SDDrawer.prototype,SDDrawer_$=function(e,t){return SDDrawer_CANVAS_API_AVAILABLE?new SDCanvasDrawer(e,t):new SDImgDrawer(e,t)},SDDrawer_nullDrawer=new SDDrawer;SDDrawerPrototype.drawTile=function(e,t,n){return e},SDDrawerPrototype.addLevelOnTop=function(){return!0},SDDrawerPrototype.addLevelBehind=function(e){return!0},SDDrawerPrototype.removeLevel=function(e){},SDDrawerPrototype.updateBlend=function(e,t,n){},SDDrawerPrototype.updateFade=function(e,t){},SDDrawerPrototype.discardTile=function(e,t){},SDDrawerPrototype.setLevelDimensions=function(e){};var SDCanvasDrawer=function(){SDDrawer.apply(this,arguments)},SDCanvasDrawerPrototype=SDCanvasDrawer.prototype=new SDDrawer;SDCanvasDrawerPrototype.drawTile=function(e,t,n,i){var r,o,a,s,l,c,u,d=t.crop,h=t.bounds,m=0;return e.complete?("number"!=typeof i?i=t.opacity:m=t.opacity,n.canvas?(r=n.canvas,o=r.getContext("2d"),a=n.fullSize,s=n.normalizedBounds,1!==i&&(o.save(),m=m||0,o.globalAlpha=(i-m)/(1-m)),c=a.width/s.width,u=a.height/s.height,l=new SDRect((h.x-s.x)*c,(h.y-s.y)*u,h.width*c,h.height*u),d?o.drawImage(e,d.x,d.y,d.width,d.height,l.x,l.y,l.width,l.height):o.drawImage(e,l.x,l.y,l.width,l.height),1!==i&&o.restore(),e):void SDDebug_warn("SDCanvasDrawer: nonexistent level")):void SDDebug_warn("Seadragon2.Canvas.drawImage: ignoring incomplete image: "+e.src)},SDCanvasDrawerPrototype.updateBlend=function(e,t,n){t.canvas||SDDebug_error("CanvasDrawer: Attempting to blend tile on nonexistent level!"),this.drawTile(e.view,e,t,n)},SDCanvasDrawerPrototype.updateFade=function(e,t){SDElement_setOpacity(e.canvas,t)},SDCanvasDrawerPrototype.positionLevel=function(e){var t=e.canvas,n=e.normalizedBounds,i=t.style;i.left=(100*n.x).toFixed(8)+"%",i.top=(n.y/this.normHeight*100).toFixed(8)+"%",i.width=(100*n.width).toFixed(8)+"%",i.height=(n.height/this.normHeight*100).toFixed(8)+"%"},SDCanvasDrawerPrototype.setLevelDimensions=function(e){var t,n,i,r,o,a=e.view.canvas,s=e.bounds,l=e.tiles,c=s.x,u=s.y,d=s.width+c,h=s.height+u,m=e.dimensions;if(o=l[c][u].bounds.union(l[d][h].bounds),m=o.scale(m.width,new SDPoint(0,0)),m.width=SDMath_round(m.width)||1,m.height=SDMath_round(m.height)||1,a.width=m.width,a.height=m.height,e.view.fullSize=m,e.view.normalizedBounds=o,this.positionLevel(e.view),l)for(i=c;i<=d;i++)for(t=l[i],r=u;r<=h;r++)n=t[r],n.view&&this.drawTile(n.view,n,e.view)},SDCanvasDrawerPrototype.makeCanvas=function(e){var t=document.createElement("canvas"),n=t.style;return n.display="block",n.position="absolute",n.overflow="hidden",n.width="100%",n.height="100%",e.canvas=t,e.normalizedBounds=new SDRect(0,0,1,this.normHeight),t},SDCanvasDrawerPrototype.addLevelOnTop=function(){var e={};return this.container.appendChild(this.makeCanvas(e)),e},SDCanvasDrawerPrototype.addLevelBehind=function(e){var t={};return this.container.insertBefore(this.makeCanvas(t),e.canvas),t},SDCanvasDrawerPrototype.removeLevel=function(e){this.container.removeChild(e.canvas),delete e.canvas};var SDImgDrawer_MS_INTERPOLATION_MODE=document.documentMode?"bicubic":"nearest-neighbor",SDImgDrawer=function(){SDDrawer.apply(this,arguments)},SDImgDrawerPrototype=SDImgDrawer.prototype=new SDDrawer;SDImgDrawerPrototype.drawTile=function(e,t,n){var i,r,o,a,s=t.crop,l=t.bounds,c=t.opacity;return n||SDDebug_error("SDImgDrawer: nonexistent level"),i=document.createElement("img"),r=i.style,i.src=e.src,r.position="absolute",r.msInterpolationMode=SDImgDrawer_MS_INTERPOLATION_MODE,s?(o=document.createElement("div"),a=o.style,a.position="absolute",a.overflow="hidden",r.left=(-100*s.x/s.width).toFixed(8)+"%",r.top=(-100*s.y/s.height).toFixed(8)+"%",r.width=(100*e.width/s.width).toFixed(8)+"%",r.height=(100*e.height/s.height).toFixed(8)+"%",o.appendChild(i)):(o=i,a=r),a.left=(100*l.x).toFixed(8)+"%",a.top=(100*l.y/this.normHeight).toFixed(8)+"%",a.width=(100*l.width).toFixed(8)+"%",a.height=(100*l.height/this.normHeight).toFixed(8)+"%",n.appendChild(o),"number"==typeof c&&SDElement_setOpacity(o,c),o},SDImgDrawerPrototype.updateBlend=function(e,t,n){SDElement_setOpacity(e.view,n)},SDImgDrawerPrototype.updateFade=function(e,t){SDElement_setOpacity(e,t)},SDImgDrawerPrototype.makeDiv=function(){var e=document.createElement("div"),t=e.style;return t.display="block",t.position="absolute",t.overflow="visible",t.width="100%",t.height="100%",e},SDImgDrawerPrototype.addLevelOnTop=function(){var e=this.makeDiv();return this.container.appendChild(e),e},SDImgDrawerPrototype.addLevelBehind=function(e){var t=this.makeDiv();return this.container.insertBefore(t,e),t},SDImgDrawerPrototype.removeLevel=function(e){this.container.removeChild(e)},SDImgDrawerPrototype.discardTile=function(e,t){t.removeChild(e.view)};var SDImageState=function(e,t,n,i){this.blendInTime=n||0,this.fadeOutTime=i||0,this.source=e,this.drawer=t,this.maxLevel=e.minLevel-1,this.clip=new SDRect(0,0,1,e.normHeight),this.levels={},this.position=SDRect_nullRect},SDImageStatePrototype=SDImageState.prototype,SDImageState_animator=SDTimer;SDImageStatePrototype.update=function(e,t,n){var i,r=this.source,o=this.position,a=r.normHeight;if(n=n||0,e&&!o.equals(e)&&(this.position=e),t&&(t=new SDRect(t.x/e.width,t.y*a/e.height,t.width/e.width,t.height*a/e.height)),e)for(i=SDMath_clamp(SDMath_ceil(SDMath_log2(SDMath_max(e.width,e.height))-n+r.sharpen),r.minLevel,r.maxLevel),r.isDzc&&(i>r.dzcMaxLevel?r.expand():r.contract());!r.levelExists(i);)i--;else i=this.maxLevel;i!==this.maxLevel&&this.setLevel(i),t&&!t.equals(this.clip)&&this.setClipBounds(t)},SDImageStatePrototype.setLevel=function(e){var t,n,i,r=this.maxLevel,o=this.clip;if(this.maxLevel=e,r<e)for(t=r+1;t<=e;t++)n=this.initLevelData(t),this.setLevelClipBounds(n,o),this.drawLevel(n,null,!0);else if(r>e){for(t=r;t>e;t--)n=this.levels[t],n&&n.visible&&(i=this.levels[t]),this.fadeLevel(t),this.setLevelClipBounds(n,SDRect_nullRect);this.redrawAllLevels(i)}},SDImageStatePrototype.redrawAllLevels=function(e){var t,n=this.maxLevel,i=this.source.minLevel,r=this.levels;for(t=n;t>=i;t--)this.drawLevel(r[t],e),r[t].visible&&(e=r[t])},SDImageStatePrototype.setClipBounds=function(e){var t,n=this.source.minLevel,i=this.maxLevel,r=this.levels;for(this.clip=e,t=n;t<=i;t++)this.setLevelClipBounds(r[t],e);this.redrawAllLevels()},SDImageStatePrototype.destroy=function(){var e,t=this.levels;for(e=this.minLevel;e<=this.maxLevel;e++)t[e].view&&this.drawer.removeLevel(t[e].view);this.levels=null,this.blendTile=SDFunction_EMPTY,this.onTileDrawn=SDFunction_EMPTY,this.getTilePriority=function(){return 0},this.drawer=null},SDImageStatePrototype.blendTile=function(e,t){var n=(new Date).getTime(),i=this.levels[t.level];t.opacity=0,t.view=this.drawer.drawTile(e,t,i.view),SDImageState_animator.register(SDImageState_blendCallback,{levelData:i,tile:t,startTime:n,state:this})},SDImageStatePrototype.fadeLevel=function(e){var t=this.levels[e],n=(new Date).getTime();t.fading=!0,SDImageState_animator.register(SDImageState_fadeCallback,{state:this,level:e,startTime:n,levelData:t})},SDImageStatePrototype.initLevelData=function(e){var t=this.levels,n=t[e];return n&&n.visible&&(this.drawer.removeLevel(n.view),n.visible=!1),t[e]=n=new Level(e,this.source),n},SDImageStatePrototype.checkRemoveLevel=function(e){e.tilesVisible<0&&SDDebug_error("coverage is broken"),0!==e.tilesVisible||e.fading||(e.visible=!1,e.view&&(this.drawer.removeLevel(e.view),e.view=null))},SDImageStatePrototype.onUncover=function(e){e.uncover()&&(e.inBounds&&this.levels[e.level].tilesVisible++,e.tileBelow&&this.onUncover(e.tileBelow))},SDImageStatePrototype.onCover=function(e){var t;e.cover()&&(t=this.levels[e.level],e.view&&(this.drawer.discardTile(e,t.view),e.view=null),e.drawnOpaque?e.drawnOpaque=!1:e.tileBelow&&this.onCover(e.tileBelow),t.tilesVisible--,this.checkRemoveLevel(t))},SDImageStatePrototype.onDrawn=function(e){e.drawn(),e.tileBelow&&this.onCover(e.tileBelow)},SDImageStatePrototype.setLevelClipBounds=function(e,t){var n,i,r,o,a,s,l=e.num,c=this.source,u=e.bounds,d=c.getTilesInRect(l,t),h=e.tiles,m=d.x,p=d.y,g=d.height+p,f=d.width+m,v=u.x,S=u.y,D=v+u.width,w=S+u.height,y=e.fading&&this.drawer===SDDrawer_nullDrawer;if(!h||!u)return void SDDebug_error("uninitialized level "+l);if(!d.equals(u)){for(r=m;r<=f;r++)for(n=h[r],n||(h[r]={},n=h[r]),o=p;o<=g;o++)i=n[o],i||(a=c.getTileBelow(l,r,o),a?(s=this.levels[l-1].tiles[a.x][a.y],s||SDDebug_error("coverage is broken")):s=null,n[o]=new Tile(e.num,r,o,c,s),e.tilesVisible++);for(r=v;r<=D;r++){for(n=h[r],o=S;o<=w;o++)r>=m&&r<=f&&o>=p&&o<=g?o=g:(i=n[o],i.view&&!e.fading&&this.drawer.discardTile(i,e.view),i.isCovered()||e.tilesVisible--,i.inBounds=!1,i.drawnOpaque&&this.onUncover(i.tileBelow),y||delete n[o]);!y&&(r<m||r>f)&&delete h[r]}y||(e.bounds=d),this.checkRemoveLevel(e),e.visible&&!e.fading&&this.drawer.setLevelDimensions(e)}},SDImageStatePrototype.drawLevel=function(e,t,n){var i,r,o,a,s,l,c,u=e.bounds,d=e.num,h=u.x,m=h+u.width,p=u.y,g=p+u.height,f=this.source,v=this.drawer;if(0!==e.tilesVisible)for(e.tilesVisible<0&&SDDebug_error("coverage is broken"),e.visible||(e.visible=!0,t?e.view=v.addLevelBehind(t.view):e.view=v.addLevelOnTop(),v.setLevelDimensions(e)),i=h;i<=m;i++)for(r=p;r<=g;r++)f.tileExists(d,i,r)&&(o=new SDPoint(i,r),a=e.tiles[i][r],a.covers()||a.view||a.loading||(s=SDTileLoader_getImgInfo(a.url),s.failed||(l=a.bounds,s.loaded?n?this.blendTile(s.img,a):(a.opacity=1,a.view=v.drawTile(s.img,a,e.view),this.onDrawn(a)):(c=this.position,l=l.intersect(this.clip),l=new SDRect(l.x*c.width+c.x,l.y*c.height/f.normHeight+c.y,l.width*c.width,l.height*c.height/f.normHeight),a.area=l.getArea(),a.distance=l.getCenter().distanceTo(SDPoint_origin),a.loading=!0,SDTileLoader_nominate(a,SDImageState_onTileLoad,{levelData:e,state:this})))))};var SDImage_init,SDImage=SD.Image=function(e,t){return SDObject_extend(this,e),this.state=null,this.lastSrc="",this.container=document.createElement("div"),t&&t.attributes.src?this.src=t.attributes.src.value:this.src=this.lastSrc,this.complete=!0,t||(t=SDElement_dce.call(document,"sdimg")),SDImage_init(SDObject_extend(t,this,!0))},SDImagePrototype=SDImage.prototype,SDImage_pixelRatio=0;"undefined"!=typeof devicePixelRatio&&(SDImage_pixelRatio=SDMath_log2(devicePixelRatio)),SDElement_registerCustomElement("sdimg",SDImage),SDImagePrototype.blendTime=500,SDImagePrototype.fadeTime=500,SDImagePrototype.manualUpdates=!1,SDImagePrototype.clipParent=null,SDImagePrototype.immediateMode=!0,SDImagePrototype.blur=0,function(){var e,t,n,i="sdimg",r="display:inline-block",o=i+" {"+r+"}";if(document.createStyleSheet)try{t=document.styleSheets.length>0?document.styleSheets[0]:document.createStyleSheet(),t.addRule(i,r,0)}catch(a){SDDebug_warn("Error while creating default styles: "+a.message)}else e=document.documentElement.firstChild,t=document.createElement("style"),n=document.createTextNode(o),t.appendChild(n),e.insertBefore(t,e.firstChild)}(),SDImage_init=function(e){var t=e.container,n=t.style;return t.className="sdimgcontainerdiv",n.textAlign="left",n.overflow="hidden",e.style&&(e.appendChild(t),n.position="relative",n.width=n.height="100%"),e.manualUpdates||(e.timerID=SDImageManager.register(SDImage_onTick,e)),e},SDImagePrototype.update=function(e,t){SDImage_onTick(this,null,e,t)},SDImagePrototype.destroy=function(){this.drawer.destroy(),this.timerID&&SDImageManager.unregister(this.timerID)},SDImage.drawImage=function(e,t,n,i,r,o,a,s,l,c){var u,d,h,m,p,g,f,v,S,D,w,y,b,T,I,_,L,E,x,k,M,P,C,R,A=!0;if(t=t.state,!t)return SDDebug_warn("Image.drawImage: Image isn't ready yet!"),!1;for(R=t.maxLevel,void 0===r?(a=n,s=i,l=t.position.width,c=t.position.height):void 0===a?(a=n,s=i,l=r,c=o):(e.save(),e.beginPath(),e.rect(a,s,l,c),e.clip(),C=!0,a-=n*l/r,s-=i*c/o,l*=t.position.width/r,c*=t.position.height/o),u=t.source.normHeight,d=t.levels,h=t.source.minLevel;g=d[h];h++)if(g.visible){for(v=g.bounds,f=g.opacity,1!==f&&(e.save(),e.globalAlpha*=f,A=!1),D=v.x,y=v.y,w=D+v.width,b=y+v.height,S=g.tiles,m=D;m<=w;m++)for(T=S[m],p=y;p<=b;p++)I=T[p],I.view?(_=I.opacity,1!==_&&(e.save(),e.globalAlpha*=_,A=!1),L=I.crop,E=I.bounds,x=a+E.x*l,k=s+E.y*c/u,M=E.width*l,P=E.height*c/u,L?e.drawImage(I.view,L.x,L.y,L.width,L.height,x,k,M,P):e.drawImage(I.view,x,k,M,P),1!==_&&e.restore()):A=!1;1!==f&&e.restore()}return(R!==h-1||d[R]&&!d[R].visible)&&(A=!1),C&&e.restore(),A},function(){function e(e){return SDMouse_getPosition(e)}function t(e,t){var n=SDMouse_getPosition(e),i=SDElement_getPosition(t);return n.minus(i)}function n(e,t){for(var n=document.body;t&&e!==t&&n!==t;)try{t=t.parentNode}catch(i){return!1}return e===t}function i(){d=!0}function r(){d=!1}if(!SD.MouseTracker){var o,a,s,l,c,u="function"!=typeof addEventListener,d=!1,h=!1,m={},p=[];navigator.msPointerEnabled?(o="MSPointerDown",a="MSPointerUp",s="MSPointerOver",l="MSPointerOut",c="MSPointerMove"):(o="mousedown",a="mouseup",s="mouseover",l="mouseout",c="mousemove"),u?(SDEvent_add(document,o,i,!1),SDEvent_add(document,a,r,!1)):(SDEvent_add(window,o,i,!0),SDEvent_add(window,a,r,!0)),SD.MouseTracker=function(i,r){function g(e,t){var n,i=m;for(n in i)i.hasOwnProperty(n)&&R!==n&&i[n][e](t)}function f(){var e;for(e in B)if(B.hasOwnProperty(e)&&B[e])return!0;return!1}function v(e){e=e||window.event,u&&O&&!n(e.srcElement,i)&&g("onMouseOver",e);
var r=e.target||e.srcElement,o=e.relatedTarget||e.fromElement,a=e.pointerId||0;n(i,r)&&!n(i,o)&&(B[a]=!0,C.trigger("enter",C,a,t(e,i),!!N[a],d))}function S(e){e=e||window.event,u&&O&&!n(e.srcElement,i)&&g("onMouseOut",e);var r=e.target||e.srcElement,o=e.relatedTarget||e.toElement,a=e.pointerId||0;n(i,r)&&!n(i,o)&&(B[a]=!1,C.trigger("exit",C,a,t(e,i),!!N[a],d))}function D(n){if(n=n||window.event,2!==n.button){var r=n.pointerId||0;N[r]=!0,B[r]=!0,F[r]=z[r]=e(n),V[r]=(new Date).getTime(),C.trigger("press",C,r,t(n,i)),(C.listListeners("press")||C.listListeners("drag"))&&SDEvent_cancel(n),u&&h?u&&p.push(P):(k(),h=!0,p=[P])}}function w(n){if(n=n||window.event,2!==n.button){var r=n.pointerId||0,o=(new Date).getTime()-V[r],a=e(n),s=F[r].distanceTo(a),l=o<=U&&s<=G,c=n.target,u=document.body,d=!1;for(c=n.target;c&&c!==i&&c!==u;c=c.parentNode)H.hasOwnProperty(c.tagName)&&(d=!0);C.trigger("click",C,r,t(n,i),l,n.shiftKey,d)}}function y(e){e=e||window.event;var n=e.pointerId||0,r=!!N[n],o=!!B[n];2!==e.button&&(N[n]=!1,C.trigger("release",C,n,t(e,i),r,o),r&&o&&w(e))}function b(e){e=e||window.event;var t,n;if(2!==e.button){for(t=0;t<p.length;t++)n=p[t],n.hasMouse()||n.onMouseUp(e);M(),h=!1,e.srcElement.fireEvent("on"+e.type,document.createEventObject(e)),SDEvent_stop(e)}}function T(e){B[e.pointerId||0]||y(e),M()}function I(n){n=n||window.event;var r=n.pointerId||0,o=e(n),a=o.minus(z[r]||o);z[r]=o,(a.x||a.y)&&C.trigger("drag",C,r,t(n,i),a,n.shiftKey),C.listListeners("drag")&&SDEvent_cancel(n)}function _(e){var t;for(t=0;t<p.length;t++)p[t].onMouseMove(e);SDEvent_stop(e)}function L(e){e=e||window.event;var n=SDMouse_getScroll(e);n&&C.trigger("scroll",C,t(e,i),n,e.shiftKey),C.listListeners("scroll")&&SDEvent_cancel(e)}function E(){A||(SDEvent_add(i,s,v,!1),SDEvent_add(i,l,S,!1),SDEvent_add(i,o,D,!1),SDEvent_add(i,a,y,!1),SDEvent_add(i,"mousewheel",L,!1),A=!0,m[R]=P)}function x(){if(A){for(SDEvent_remove(i,s,v,!1),SDEvent_remove(i,l,S,!1),SDEvent_remove(i,o,D,!1),SDEvent_remove(i,a,y,!1),SDEvent_remove(i,"mousewheel",L,!1);O;)M();A=!1,delete m[R]}}function k(){O||(u?(SDEvent_remove(i,a,y,!1),SDEvent_add(i,a,b,!0),SDEvent_add(i,c,_,!0)):(SDEvent_add(window,a,T,!0),SDEvent_add(window,c,I,!0))),++O}function M(){1===O&&(u?(SDEvent_remove(i,c,_,!0),SDEvent_remove(i,a,b,!0),SDEvent_add(i,a,y,!1)):(SDEvent_remove(window,c,I,!0),SDEvent_remove(window,a,T,!0))),--O}r=r||{};var P,C=this,R=Math.random(),A=!1,O=0,N={},B={},z={},V={},F={},H={A:1,INPUT:1,TEXTAREA:1,SELECT:1,OPTION:1,OPTGROUP:1,BUTTON:1,LABEL:1},U=r.clickTimeThreshold||500,G=r.clickDistThreshold||5;this.target=i,P={hasMouse:f,onMouseOver:v,onMouseOut:S,onMouseUp:y,onMouseMove:I},SDEventManager.call(this),this.isTracking=function(){return A},this.setTracking=function(e){e?E():x()}}}}();var SDMouseTracker=SD.MouseTracker,SDSpring=SD.Spring=function(e){function t(e){return(1-SDMath_exp(-e*r))/o}e=e||{};var n,i=e.initialValue||0,r=e.stiffness||5,o=1-SDMath_exp(-r),a=e.animationTime||1.5,s=e.decayTime||1,l=i,c=i,u=(new Date).getTime(),d=u,h=u,m=0,p=!1;this.getCurrent=function(){return i},this.getTarget=function(){return c},this.resetTo=function(e){p=!1,c=e,h=u,l=c,d=h},this.springTo=function(e){p=!1,l=i,d=u,c=e,h=d+1e3*a},this.shiftBy=function(e){l+=e,c+=e},this.toss=function(){n=Math.abs(m/(1e3*s)),p=!0},this.grab=function(){p=!1},this.update=function(e){var r,o,a=u,s=i;return u=e||(new Date).getTime(),r=u-a,p?(m>0?(m-=n*r,m<0&&(m=0)):m<0&&(m+=n*r,m>0&&(m=0)),i+=m*r,c=i):(i=u>=h?c:l+(c-l)*t((u-d)/(h-d)),r&&(o=SDMath_exp(-r/40),m=o*m+(1-o)*(i-s)/r)),p}},SDSVGZoomContainer=SD.SVGZoomContainer=function(e){this.update=function(t){e.setAttribute("viewBox",[t.x,t.y,t.width,t.height].join(" "))}},SDHTMLZoomContainer=SD.HTMLZoomContainer=function(e){var t,n,i=document.createElement("div"),r=i.style,o=1;!function(){var t;for(r.width="100%",r.height="100%",r.position="relative",e.appendChild(i);(t=e.firstChild)!==i;)i.appendChild(t)}(),this.setSizeRatio=function(e,i){o=e,e=100*e+"%",r.width=e,r.height=e,i&&void 0!==t&&this.update(t,n)},this.setLocation=function(e,t){var n=e.style;n.left=t.x*o+"px",n.top=t.y*o+"px",n.width=t.width*o+"px",n.height=t.height*o+"px"},this.update=function(e,r){t=e,n=r,SDElement_transform(i,-e.x*r,-e.y*r,r/o)},this.dispose=function(){var t;for(e.removeChild(i);t=i.firstChild;)e.appendChild(t)}},SDCanvasZoomContainer=SD.CanvasZoomContainer=function(e){var t=e.getContext("2d");this.update=function(n){var i=e.width,r=e.height,o=i/n.width;t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,i,r),t.setTransform(o,0,0,o,-n.x*o,-n.y*o)}},SDViewport=SD.Viewport=function(e,t,n){function i(){SDEventManager.call(M),M.resizeContent(t),M.goHome(!0),M.update(),V&&SDTimer.register(M.update,F)}function r(e){return Math.pow(2,e)}function o(e,t){var n=e.x,i=e.y,r=SDMath_clamp(n,t.x,t.x+t.width),o=SDMath_clamp(i,t.y,t.y+t.height);return n===r&&i===o?e:new SDPoint(r,o)}function a(e){var t=M.getWidthZoom(e),n=g/t,i=n/N,r=(M.visibilityRatio-.5)*n,o=(M.visibilityRatio-.5)*i,a=g-2*r,s=p-2*o;return a<0&&(r+=.5*a,a=0),s<0&&(o+=.5*s,s=0),new SDRect(r,o,a,s)}function s(){var e=A.getCurrent(),t=A.getTarget();w=e,y=t,S=r(e),D=r(t),b=S*v,T=D*v;var n=SDMath_log2(M.minZoom),i=SDMath_log2(M.maxZoom);I=(w-n)/(i-n)*100,_=(y-n)/(i-n)*100}function l(t){var n=new SDPoint(C.getCurrent(),R.getCurrent()),i=new SDPoint(C.getTarget(),R.getTarget());if(t)return n;if(!O)return i;var r=M.getWidthZoom(),o=g/r,a=o/N,s=new SDRect(n.x-o/2,n.y-a/2,o,a),l=M.pixelFromPoint(O,!0),c=O.minus(s.getTopLeft()).times(e.x/s.width),u=c.minus(l),d=u.divide(e.x/g*r);return i.plus(d)}function c(e){var t=M.getCenter(e),n=g/M.getWidthZoom(e),i=n/N;return new SDRect(t.x-n/2,t.y-i/2,n,i)}function u(){H=!1,s(),L=l(!0),x=c(!0),E=l(),k=c()}function d(e){return new SDRect(e.x,e.y,e.width,e.height)}function h(e){return new SDPoint(e.x,e.y)}e=new SDPoint(e.x,e.y),n=n||{};var m,p,g,f,v,S,D,w,y,b,T,I,_,L,E,x,k,M=this,P=n.panSpringOptions||{animationTime:.35},C=new SDSpring(P),R=new SDSpring(P),A=new SDSpring(n.zoomSpringOptions),O=null,N=e.x/e.y,B=n.wrapHorizontal||!1,z=n.wrapVertical||!1,V=n.selfUpdating!==!1,F={},H=!0;this.maxZoom="number"==typeof n.maxZoom?n.maxZoom:2,this.minZoom="number"==typeof n.minZoom?n.minZoom:.8,this.visibilityRatio="number"==typeof n.visibilityRatio?n.visibilityRatio:.8,this.getContainerSize=function(){return h(e)},this.getBounds=function(e){return H&&u(),d(e?x:k)},this.getCenter=function(e){return H&&u(),h(e?L:E)},this.getZoom=function(e){return H&&u(),e?S:D},this.getExpZoom=function(e){return H&&u(),e?w:y},this.getWidthZoom=function(e){return H&&u(),e?b:T},this.getZoomPercent=function(e){return H&&u(),e?I:_},this.applyConstraints=function(e){var t=M.getZoom(),n=SDMath_clamp(t,M.minZoom,M.maxZoom);t!==n&&M.zoomTo(n,O,e),n*=v;var i=M.getCenter(),r=o(i,a());if(B&&(r.x=i.x),z&&(r.y=i.y),!i.equals(r)){var s=g/n,l=s/N;M.fitBounds(new SDRect(r.x-.5*s,r.y-.5*l,s,l),e)}},this.fitBounds=function(t,n){var i=N,r=t.getCenter(),o=new SDRect(t.x,t.y,t.width,t.height);o.getAspectRatio()>=i?(o.height=t.width/i,o.y=r.y-o.height/2):(o.width=t.height*i,o.x=r.x-o.width/2),M.panTo(M.getCenter(!0),!0),M.zoomTo(M.getZoom(!0),null,!0);var a=M.getBounds(),s=M.getWidthZoom(),l=g/o.width;if(1.000001*l>s&&.999999*l<s)return void M.panTo(r,n);var c=a.getTopLeft().times(e.x/a.width).minus(o.getTopLeft().times(e.x/o.width)).divide(e.x/a.width-e.x/o.width);M.zoomTo(l/v,c,n)},this.goHome=function(e){var t=M.getCenter();B&&(t.x=(g+t.x%g)%g,C.resetTo(t.x),C.update()),z&&(t.y=(p+t.y%p)%p,R.resetTo(t.y),R.update()),M.fitBounds(f,e)},this.panBy=function(e,t){M.panTo(M.getCenter().plus(e),t)},this.panTo=function(t,n){if(n)return C.resetTo(t.x),R.resetTo(t.y),void(H=!0);if(!O)return C.springTo(t.x),R.springTo(t.y),void(H=!0);var i=M.getWidthZoom(),r=g/i,o=r/N,a=new SDRect(C.getCurrent()-r/2,R.getCurrent()-o/2,r,o),s=M.pixelFromPoint(O,!0),l=O.minus(a.getTopLeft()).times(e.x/a.width),c=l.minus(s),u=c.divide(e.x/g*i),d=t.minus(u);C.springTo(d.x),R.springTo(d.y),H=!0},this.zoomBy=function(e,t,n){M.zoomTo(M.getZoom()*e,t,n)},this.zoomTo=function(e,t,n){n?A.resetTo(SDMath_log2(e)):A.springTo(SDMath_log2(e)),O=t instanceof SDPoint?t:null,H=!0},this.toss=function(){C.toss(),R.toss()},this.resize=function(t,n){var i=M.getBounds(),r=i,o=t.x/e.x;e=new SDPoint(t.x,t.y),N=e.x/e.y,v=N>m?m/N:1,n&&(r.width=i.width*o,r.height=r.width/N),M.fitBounds(r,!0)},this.resizeContent=function(e){var n;n=M.getBounds(),t=e,m=t.x/t.y,p=t.y,g=t.x,f=new SDRect(0,0,g,p),v=N>m?m/N:1,H=!0,M.fitBounds(n,!0)},this.zoomToPercent=function(e,t){var n=SDMath_log2(M.minZoom);M.zoomTo(r(e*(SDMath_log2(M.maxZoom)-n)/100+n),null,t)},this.update=function(e,t){var n,i,r=C.getCurrent(),o=R.getCurrent(),a=A.getCurrent();if(t=t||(new Date).getTime(),O&&(n=M.pixelFromPoint(O,!0)),A.update(t),H=!0,O&&A.getCurrent()!==a){var s=M.pixelFromPoint(O,!0),l=s.minus(n),c=M.deltaPointsFromPixels(l,!0);C.shiftBy(c.x),R.shiftBy(c.y)}else O=null;i=C.update(t),i=R.update(t)||i,H=!0,i&&M.applyConstraints();var u=C.getCurrent()!==r||R.getCurrent()!==o||A.getCurrent()!==a;return u&&M.trigger("change",M),u||e===F},this.deltaPixelsFromPoints=function(t,n){return t.times(e.x/g*M.getWidthZoom(n))},this.deltaPointsFromPixels=function(t,n){return t.divide(e.x/g*M.getWidthZoom(n))},this.pixelFromPoint=function(t,n){var i=M.getBounds(n);return t.minus(i.getTopLeft()).times(e.x/i.width)},this.pointFromPixel=function(t,n){var i=M.getBounds(n);return t.divide(e.x/i.width).plus(i.getTopLeft())},this.rectPixelsFromPoints=function(t,n,i){var r=M.getBounds(n),o=e.x/r.width;return new SDRect((t.x-r.x)*o-(i?e.x/2:0),(t.y-r.y)*o-(i?e.y/2:0),t.width*o,t.height*o)},i()},SDViewer=SD.Viewer=function(e,t){function n(e,t){var n=e>1;d.zoomBy(e,n&&T.zoomInToPoint||!n&&T.zoomOutToPoint?d.pointFromPixel(t.minus(new SDPoint(T.padding.left,T.padding.top)),!0):null),d.applyConstraints()}function i(e){var t,n,i,r=0,o=0,a=0,s=0;for(t in e)if(e.hasOwnProperty(t)){++r,i=e[t],a+=i.x,s+=i.y;for(n in e)e.hasOwnProperty(n)&&n!==t&&(o+=i.distanceTo(e[n]))}return{center:new SDPoint(a/r,s/r),size:o/r/(r-1)}}function r(e,t,i,r,o,a){if(r&&T.isZoomable&&!a){var s=T.zoomPerClick,l=o?1/s:s;n(l,i)}}function o(e,t,n){if(I[t]=_[t]=n,++k,m=d.getCenter(),k>1){var r=i(I);n=r.center,v=n,S=r.size,D=d.getZoom(),w=d.pointFromPixel(n.minus(new SDPoint(T.padding.left,T.padding.top)),!0)}}function a(e,t,n,r){_[t]=n;var o,a=-1;if(k>1){var s=i(_);n=s.center,a=s.size,o=v}else o=I[t];if(T.isZoomable&&a>=0){var l=a/S,c=l*D;d.zoomTo(c,void 0,!0);var u=d.deltaPointsFromPixels(n.minus(o)).times(l),h=m.minus(u).minus(w).divide(l).plus(w);d.panTo(h,!0),d.applyConstraints()}else if(T.isPannable){var p=n.minus(o),g=d.deltaPointsFromPixels(p.negate(),!0);d.panTo(m.plus(g)),T.constrainDuringPan&&d.applyConstraints();var y=T.dragCursor;E&&!f&&y&&(f=!0,L.cursor=y)}}function s(e,t,n,i){if(i)if(--k,delete _[t],delete I[t],k){if(1===k){for(t in _)if(_.hasOwnProperty(t))break;I[t]=_[t],m=d.getCenter(),y=!0}}else T.useMomentum&&!y&&d.toss(),y=!1,d.applyConstraints();f&&(f=!1,L.cursor="")}function l(e,t,i){if(T.isZoomable){var r=Math.pow(T.zoomPerScroll,i);n(r,t)}}function c(){T.ignoreChange||T.redraw()}function u(e,t){return new SDPoint(SDMath_max(e-T.padding.right-T.padding.left,1),SDMath_max(t-T.padding.top-T.padding.bottom,1))}t=t||{};var d,h,m,p,g,f,v,S,D,w,y,b,T=this,I={},_={},L=document.documentElement.style,E=!window.opera,x=0,k=0;T.zoomPerClick=2,T.zoomPerScroll=Math.pow(2,1/3),T.zoomInToPoint=!0,T.zoomOutToPoint=!0,T.isPannable=!0,T.isZoomable=!0,T.constrainDuringPan=!1,T.ignoreChange=!1,T.useMomentum=!0,T.dragCursor="move",T.padding={top:0,right:0,bottom:0,left:0},SDObject_extend(T,t),function(){p=SDMath_max(e.clientWidth,1),g=SDMath_max(e.clientHeight,1);var n,i,r=new SDPoint(p,g),o=T.contentSize||r.times(1);if(!T.zoomContainers){if(window.SVGSVGElement&&e instanceof SVGSVGElement){var a=SDElement_getStyle(e);r=new SDPoint(parseFloat(a.width),parseFloat(a.height)),T.contentSize||(o=new SDPoint(e.viewBox.baseVal.width,e.viewBox.baseVal.height),0===o.x&&0===o.y&&(o=new SDPoint(e.width.baseVal.value,e.height.baseVal.value))),n=new SDSVGZoomContainer(e)}else window.HTMLCanvasElement&&e instanceof HTMLCanvasElement?(T.contentSize||(o=new SDPoint(e.width,e.height)),n=new SDCanvasZoomContainer(e)):n=new SDHTMLZoomContainer(e);T.zoomContainers=[n]}i=u(r.x,r.y),o.x*=i.x/r.x,o.y*=i.y/r.y,d=new SDViewport(i,o,t.viewportOptions),SDEventManager.call(T),e.style.msTouchAction="none"}(),h=new SDMouseTracker(e),h.addListener("click",r),h.addListener("press",o),h.addListener("drag",a),h.addListener("release",s),h.addListener("scroll",l),h.setTracking(!0),d.addListener("change",c),b=SDTimer.register(function(){if(x=(x+1)%30,0===x){var t=SDMath_max(e.clientWidth,1),n=SDMath_max(e.clientHeight,1);t===p&&n===g||(p=t,g=n,d.resize(u(t,n),!0),T.trigger("resize",t,n))}return!0}),T.getBounds=function(e){var t=d.getBounds(e),n=d.getContainerSize();return t.x-=t.width*T.padding.left/n.x,t.y-=t.height*T.padding.top/n.y,t.width*=1+(T.padding.left+T.padding.right)/n.x,t.height*=1+(T.padding.top+T.padding.bottom)/n.y,t},T.redraw=function(){var e,t=T.getBounds(!0),n=d.getZoom(!0),i=T.zoomContainers;for(e=i.length-1;e>=0;e--)i[e].update(t,n)},T.dispose=function(e){if(SDTimer.unregister(b),!e){var t,n,i=T.zoomContainers,r=i.length;for(t=0;t<r;++t)n=i[t],n.dispose&&n.dispose()}},T.redraw(),T.viewport=d,T.tracker=h},I18n=function(e){this.lang=e};I18n.prototype.constructor=I18n,I18n.prototype.t=function(e){return TRANSLATION[this.lang][e]};var TRANSLATION={},i18n=new I18n("ru");TRANSLATION.en={sort:"Sort:",sort1:"Sort: ",sortQuantity:"Sort: Quantity",sortAZ:"Sort: A-Z",unrecognizedFacet:"Unrecognized facet type in details pane: ",unrecognizedFacet1:"Unrecognized facet type ",search:"Search...",noInfo:"(no info)",parsingJsonError:"Error in parsing JSON from content endpoint",receivedFailureCode:"Received failure code from server-side renderer",parsingJsonFailed:"Failed to parse JSON response from server.",postCollectionDataFailed:"Failed to post collection data. Status text: ",unrecognizedTemplateType:"updateTemplate: unrecognized template type",january:"January",february:"February",march:"March",april:"April",may:"May",june:"June",july:"July",august:"August",september:"September",october:"October",november:"November",december:"December",notApplicable:"Not Currently Applicable",under:"Under ",over:"Over ",exactly:"Exactly ",clearAll:"Clear All",zoomIn:"Zoom In",zoomOut:"Zoom Out",exportCSV:"Export to CSV",clearFilters:"Clear Filters",graphView:"Graph View",gridView:"Grid View",mapView:"Map View",tableView:"Table View",yndx:"Yandex",ysat:"Yandex satellite",ytraffic:"Yandex traffic",googleMap:"Google",googleMapSat:"Google satellite",openStreetsMap:"Open Streets"},TRANSLATION.ru={sort:":",sort1:": ",sortQuantity:": ",sortAZ:": -",unrecognizedFacet:"     : ",unrecognizedFacet1:"   ",search:"...",noInfo:"( )",parsingJsonError:"   JSON",receivedFailureCode:"     ",parsingJsonFailed:"   JSON-  .",postCollectionDataFailed:"    .  : ",unrecognizedTemplateType:"updateTemplate:    ",january:"",february:"February",march:"",april:"",may:"",june:"",july:"",august:"",september:"",october:"",november:"",december:"",notApplicable:"    ",under:" ",over:" ",exactly:" ",clearAll:" ",zoomIn:"",zoomOut:"",exportCSV:"  CSV",clearFilters:" ",graphView:" ",gridView:"",mapView:"",tableView:"",yndx:"",ysat:" ",ytraffic:" ",googleMap:"Google",googleMapSat:"Google ",openStreetsMap:"Open Streets"},String.prototype.replaceAll=function(e,t){return this.split(e).join(t)};var throttle=function(e,t,n){n=n||window;var i=!1,r=function(){i||(i=!0,requestAnimationFrame(function(){var e;"function"==typeof Event?e=new Event(t):(e=document.createEvent("Event"),e.initEvent(t,!0,!0)),n.dispatchEvent(e),i=!1}))};n.addEventListener(e,r)};throttle("resize","optimizedResize");var PIVOT_PARAMETERS={map:{enableClustering:!0,highlightMarkersOnFilter:!0,multipleClusterColors:!1,clusterRadius:50,startClusterLimit:10,sourceURL:"",markerUrl:"Content/images/azs-small-grey.png",highlightedMarkerUrl:"Content/images/azs-small-red.png",filteredMarkerUrl:"Content/images/azs-small-blue.png",toggleDownImage:"Content/images/toggle-down.png",toggleUpImage:"Content/images/toggle-up.png",routeMarkerUrl:"Content/images/marker-icon.png",routeMarkerShadowUrl:"Content/images/marker-shadow.png"},detailsEnabled:!0,filterElement:"ID",nameElement:"ORG_NAME"},Pivot=window.Pivot={},hasOwnProperty={}.hasOwnProperty,makeElement=function(e,t,n){var i=document.createElement(e);return t&&(i.className=t),n&&n.appendChild(i),i},addText=function(e,t){e.appendChild(document.createTextNode(t))},PivotNumber_epsilon=1e-5,PivotDate_getHalfMonth=function(e){return 1===e?15:16},PivotDate_months=[i18n.t("january"),i18n.t("february"),i18n.t("march"),i18n.t("april"),i18n.t("may"),i18n.t("june"),i18n.t("july"),i18n.t("august"),i18n.t("september"),i18n.t("october"),i18n.t("november"),i18n.t("december")],PivotDate_minScale=-9,PivotDate_chooseDateScale=function(e,t){var n,i,r,o,a;return(n=t.getFullYear()-e.getFullYear())?Math.floor(Math.log(n)/Math.LN10):(o=t.getMonth(),o>e.getMonth()?-1:(i=t.getDate(),r=e.getDate(),a=PivotDate_getHalfMonth(o),r<a&&i>=a?-2:i>r?-3:(n=t.getHours()-e.getHours(),n>=12?-4:n?-5:(n=t.getMinutes()-e.getMinutes(),n>=15?-6:n?-7:(n=t.getSeconds()-e.getSeconds(),n>=5?-8:-9)))))},PivotDate_generateBuckets=function(e,t,n){function i(e,t,n){t&&(e=t+" to "+n,u.leftLabel=t,u.rightLabel=n),u.label=e}if(!(e<=t)||n<PivotDate_minScale)return[];void 0===n&&(n=PivotDate_chooseDateScale(e,t)),n>=0&&(n=Math.pow(10,n));var r,o,a,s,l,c,u,d,h,m=e.getFullYear(),p=0,g=1,f=0,v=0,S=0,D=0;switch(n){case-9:case-8:S=e.getSeconds();case-7:case-6:v=e.getMinutes();case-5:case-4:f=e.getHours();case-3:case-2:g=e.getDate();case-1:p=e.getMonth();break;default:m=Math.floor(m/n)*n}switch(n){case-8:S=5*Math.floor(S/5);break;case-6:v=15*Math.floor(v/15);break;case-4:f=12*Math.floor(f/12);break;case-2:r=PivotDate_getHalfMonth(p),g=g>=r?r:1}switch(e=new Date(m,p,g,f,v,S,D),n){case-9:o=function(e){return new Date(m,p,g,f,v,S+e,0)};break;case-8:o=function(e){return new Date(m,p,g,f,v,S+5*e,0)};break;case-7:o=function(e){return new Date(m,p,g,f,v+e,0,0)};break;case-6:o=function(e){return new Date(m,p,g,f,v+15*e,0,0)};break;case-5:o=function(e){return new Date(m,p,g,f+e,0,0,0)};break;case-4:o=function(e){return new Date(m,p,g,f+12*e,0,0,0)};break;case-3:o=function(e){return new Date(m,p,g+e,0,0,0,0)};break;case-2:o=function(e){g>1&&e++;var t=new Date(m,p+Math.floor(e/2),1,0,0,0,0);return e%2&&t.setDate(PivotDate_getHalfMonth(t.getMonth())),t};break;case-1:o=function(e){return new Date(m,p+e,1,0,0,0,0)};break;default:o=function(e){return new Date(m+e*n,0,1,0,0,0,0)}}switch(n){case-9:case-8:case-7:case-6:case-5:case-4:d=function(){var e,t,n=l.getDate();h===n?e="":(e=l.toLocaleDateString()+" ",h=n),e+=l.toLocaleTimeString(),t=h===c.getDate()?"":c.toLocaleDateString()+" ",t+=c.toLocaleTimeString(),i(void 0,e,t)};break;case-3:d=function(){i(l.toLocaleDateString())};break;case-2:d=function(){i(void 0,l.toLocaleDateString(),c.toLocaleDateString())};break;case-1:d=function(){var e=l.getFullYear(),t=PivotDate_months[l.getMonth()];h!==e&&(h=e,t+=" "+e),i(t)};break;case 1:d=function(){i(l.getFullYear())};break;default:d=function(){i(Math.floor(l.getFullYear()/n)*n+"s")}}a=[],s=0,c=e;do s++,l=c,c=o(s),u={lowerBound:l,upperBound:c,items:[]},d(),a.push(u);while(c<=t);return a},PivotDatePicker=function(e,t,n,i){function r(e){var t=e.target;t.checked?(i.push(t.filterInfo),g.trigger("filter",n,i)):(i.splice(i.indexOf(t.filterInfo),1),g.trigger("filter",n,i.length?i:void 0))}function o(e){var t=e.target.filterInfo;i.forEach(function(e){e.checkBox.checked=!1}),t.checkBox.checked=!0,i=[t],g.trigger("filter",n,i)}function a(e){var t,n,a,s,l;t=makeElement("li",null,h),n=makeElement("input","pivot pivot_facetcheckbox",t),n.setAttribute("type","checkbox"),i&&i.some(function(t,n){return t.lowerBound.getTime()===e.lowerBound.getTime()&&t.upperBound.getTime()===e.upperBound.getTime()&&(i[n]=e,!0)})&&(n.checked=!0),e.checkBox=n,n.onclick=r,a=makeElement("div","pivot_outerlabel",t),a.onclick=o,s=makeElement("div","pivot_facetcount",a),addText(s,e.count),l=makeElement("div","pivot_facetlabel",a),addText(l,e.label),t.title=e.label,l.filterInfo=s.filterInfo=n.filterInfo=a.filterInfo=e}var s,l,c,u,d,h,m=1/0,p=-(1/0),g=this;return i=i||[],Seadragon2.EventManager.call(g),t.forEach(function(e){var t=e.facets[n];t&&t.forEach(function(e){e>p&&(p=e),e<m&&(m=e)})}),m===1/0?(l=makeElement("div","pivot_numberlabel",e),addText(l,i18n.t("notApplicable")),this):(s=PivotDate_chooseDateScale(m,p),c=PivotDate_generateBuckets(m,p,s),u=PivotDate_generateBuckets(m,p,s-1),d=c.concat(u),d.forEach(function(e){e.count=0}),t.forEach(function(e){var t=e.facets[n];t&&t.forEach(function(e){d.forEach(function(t){e>=t.lowerBound&&e<t.upperBound&&t.count++})})}),h=makeElement("ul","pivot",e),c.forEach(a),makeElement("li","pivot_horizbar",h),void u.forEach(a))},templateRegex=/<\?(?:\??[^>]+)*\?>/g,makeTemplate=function(template,item,parent){var result,inputString=template.template,outputChunks=[],outputString,lastIndex=0,curIndex,matchString,matchLength,evalResult,type=template.type,img,doPaint;if("html"!==type&&"fakehtml"!==type||(parent?(parent.innerHTML="",result=parent):result=makeElement("div","pivot_item"),result.style.width=template.width+"px",result.style.height=(template.height||template.width)+"px"),"canvas"===type)result="function"==typeof inputString?inputString:new Function("ctx","x","y","w","h","item",inputString);else{for(;matchString=templateRegex.exec(inputString);){matchString=matchString[0],curIndex=templateRegex.lastIndex,matchLength=matchString.length,outputChunks.push(inputString.substring(lastIndex,curIndex-matchLength)),matchString=matchString.substring(2,matchLength-2);try{!function(){with(item)evalResult=eval(matchString)}(),"number"==typeof evalResult?evalResult=PivotNumber_format(evalResult):evalResult instanceof Date&&(evalResult=evalResult.toLocaleString()),outputChunks.push(evalResult)}catch(e){Seadragon2.Debug.warn("Error caught in filling template: "+e.message||e)}lastIndex=curIndex}outputChunks.push(inputString.substring(lastIndex,inputString.length)),outputString=outputChunks.join(""),"html"===type||"fakehtml"===type?result.unsetHTML=outputChunks.join(""):"color"===type?result=function(e,t,n,i,r){return e.fillStyle=outputString,e.fillRect(t,n,i,r),!0}:"img"===type&&(img=makeElement("img"),img.onload=function(){doPaint=!0},img.unsetSrc=outputString,result=function(e,t,n,i,r){var o=img.unsetSrc;return o&&(img.src=img.unsetSrc,delete img.unsetSrc),doPaint&&e.drawImage(img,t,n,i,r),doPaint})}return result},Button=function(e,t,n,i){this.htmlElement=makeElement(e,t,n),this.htmlElement.title=i};Button.prototype.select=function(){this.htmlElement.className=this.htmlElement.className.replace("pivot_hoverable","pivot_activesort")},Button.prototype.deselect=function(){this.htmlElement.className=this.htmlElement.className.replace("pivot_activesort","pivot_hoverable")};var BaseView=function(e,t){this.isSelected=t,this.container=e,this.button={}};BaseView.prototype.createView=function(e){},BaseView.prototype.select=function(){this.isSelected=!0,this.button.select(),this.onSelected()},BaseView.prototype.deselect=function(){this.isSelected=!1,this.button.deselect()},BaseView.prototype.onSelected=function(){},BaseView.prototype.onClick=function(e){},BaseView.prototype.update=function(e){},BaseView.prototype.filter=function(e){},BaseView.prototype.clearFilter=function(){},BaseView.prototype.rearrange=function(e){},BaseView.prototype.showSelectedItems=function(){},BaseView.prototype.button=function(){return this.button};var GridView=function(e,t){BaseView.call(this,e,t);var n=this;n.button=new Button("div","pivot_sorttools gridButton pivot_hoverable",$(".pivot_topbar")[0],i18n.t("gridView")),n.button.htmlElement.onclick=function(){n.select(),$(".frontLayer")[0].style.visibility="visible",$(".behindLayer")[0].style.visibility="visible",$(".mapLayer")[0].style.visibility="hidden",$(".tableLayer")[0].style.visibility="hidden"}};GridView.prototype=Object.create(BaseView.prototype),GridView.prototype.constructor=GridView,GridView.prototype.createView=function(e){var t=this;t.container.allSortedItems=t.container.activeItemsArr;var t=t;t.container.allSortedItems.sort(function(e,n){if(e=e.facets[t.container.sortFacet],n=n.facets[t.container.sortFacet],!e)return n?1:0;if(!n)return-1;e=e[0],n=n[0];var i=t.container.facet.comparator||t.container.comparators[t.container.facet.type];return i(e,n)}),t.container.totalItemCount=t.container.allSortedItems.length,t.container.numPerRow=t.container.computeLayoutWidth(t.container.totalItemCount,t.container.containerRect.width,t.container.containerRect.height,t.container.avgHeight),t.container.widthPerItem=t.container.containerRect.width/t.container.numPerRow,t.container.numPerRow>t.container.totalItemCount&&(t.container.widthPerItem=Math.min(t.container.containerRect.width/t.container.totalItemCount,t.container.containerRect.height/t.container.avgHeight));var n=t.container.placeGrid(0,0,t.container.allSortedItems,t.container.numPerRow,t.container.widthPerItem,t.container.widthPerItem*t.container.avgHeight);t.container.finalItemWidth=n.itemWidth,t.container.topLeftItemInfo=n.topLeft,t.container.rightmostItemInfo=n.rightmost},GridView.prototype.rearrange=function(){var e=this;e.container.tracker.setTracking(!1),e.container.viewport.goHome(),e.container.clearHighlights(),e.container.animating=!0,e.container.container.title="",e.container.clearListeners("animationfinish")},GridView.prototype.rearrangePart1=function(){var e=this;e.container.removeListener("animationfinish",e.container.rearrangePart1),e.container.rearranging=!0,e.container.anythingChanged=!0,e.container.resetRearrangingItems(),e.container.prevActiveItems=Seadragon2.Object.clone(e.container.currentItems)},GridView.prototype.rearrangePart1_2=function(){var e=this;e.container.backLayer.innerHTML="",e.container.avgHeight=e.container.getAverageItemHeight(),e.container.facet=e.container.facets[e.container.sortFacet]||{};var t=e.container.viewport.getContainerSize();e.container.containerRect=new Seadragon2.Rect(0,0,t.x,t.y);for(var n=e.container.activeItemsArr.length-1;n>=0;n--)e.container.activeItemsArr[n].destination=[]},GridView.prototype.rearrangePart1_3=function(){var e=this;e.container.currentTemplateLevel===-1&&e.container.finalItemWidth&&e.container.templates.length&&e.container.setupFrontLayer(1);var t=e.container.viewport.getContainerSize();e.container.viewport.maxZoom=t.x/e.widthPerItem*2},GridView.prototype.rearrangePart2=function(){var e,t,n=this,i=!1;for(e in n.container.prevActiveItems)hasOwnProperty.call(n.container.prevActiveItems,e)&&!hasOwnProperty.call(n.container.activeItems,e)&&(i=!0,t=prevActiveItems[e],t.destination=n.container.getLocationOutside(t.source),n.container.beginAnimate(t),delete n.container.currentItems[e]);i?n.container.addListener("animationfinish",n.container.rearrangePart3):n.container.rearrangePart3()},GridView.prototype.rearrangePart3=function(){var e=this;e.container.removeListener("animationfinish",e.container.rearrangePart3);var t,n,i,r,o,a,s,l,c=!1;if("html"===e.container.templates[e.container.currentTemplateLevel].type)for(s=e.container.rearrangingItemsArr.length-1;s>=0;s--)l=e.container.rearrangingItemsArr[s].html[e.container.currentTemplateLevel],l.forEach(function(t){e.container.frontLayer.removeChild(t),t.pvInDom=!1}),l.splice(1,l.length-1);e.container.resetRearrangingItems(),e.container.finalItemWidth&&e.container.templates.length&&e.container.setupFrontLayer(1);for(t in e.container.prevActiveItems)if(hasOwnProperty.call(e.container.prevActiveItems,t)&&hasOwnProperty.call(e.container.activeItems,t)){for(n=e.container.prevActiveItems[t],i=n.source,r=n.destination,o=i.length,a=r.length,l=n.html,s=o;s<a;s++)void 0!==i[0]&&i.push(i[0]),l.forEach(function(t,n){if("html"===e.container.templates[n].type){var r=t[0],o=e.clone(r);t.push(o),n===e.container.currentTemplateLevel&&(e.container.setTransform(o,i[0]),e.container.addElementToFrontLayer(o),o.pvInDom=!0)}});for(s=a;s<o;s++)void 0!==r[0]&&r.push(r[0]);e.container.beginAnimate(n)&&(c=!0)}c?e.container.addListener("animationfinish",e.container.rearrangePart4):e.container.rearrangePart4()},GridView.prototype.rearrangePart4=function(){var e=this;e.container.removeListener("animationfinish",e.container.rearrangePart4),e.container.resetRearrangingItems();var t,n,i,r=!1;for(i=e.container.activeItemsArr.length-1;i>=0;i--)n=e.container.activeItemsArr[i],t=n.id,hasOwnProperty.call(e.container.prevActiveItems,t)||(n.source=e.container.getLocationOutside(n.destination),e.container.beginAnimate(n),e.container.currentItems[t]=n,r=!0,n.html.forEach(function(t,i){if("html"===e.container.templates[i].type){var r;for(r=n.source.length-1;r>0;r--)t.push(e.clone(t[0]))}}),"html"===e.container.templates[e.container.currentTemplateLevel].type&&n.html[e.container.currentTemplateLevel].forEach(function(t,i){e.container.setTransform(t,n.source[i]),e.container.addElementToFrontLayer(t),t.pvInDom=!0}));r?e.container.addListener("animationfinish",e.container.finishRearrange):e.container.finishRearrange()},GridView.prototype.finishRearrange=function(){var e=this;e.container.removeListener("animationfinish",e.container.finishRearrange),e.container.tracker.setTracking(!0),e.container.rearranging=!1,e.container.resetRearrangingItems(),e.container.trigger("finishedRearrange"),e.container.items.length||e.container.activeItemsArr.length||e.container.trigger("itemsCleared")},GridView.prototype.updateOnce=function(e,t){var n=this,i=n.container.viewport.getContainerSize();now=t||(new Date).getTime();var r,o,a,s,l;if(n.container.delayedFunction){var c=n.container.delayedFunction;n.container.delayedFunction=void 0,c()}var u,d,h,m;if(n.rearranging){n.container.redraw(),u=n.container.templates[n.container.currentTemplateLevel].type,d="sdimg"===u||"fakehtml"===u,h="html"===u,m="canvas"===u||"color"===u||"img"===u;var p,g,f,v,S,D,w,y,b,T,I,_,L=!0;if(d||m)for(l=n.container.activeItemsArr.length-1;l>=0;l--)if(o=n.container.activeItemsArr[l],r=o.id,!hasOwnProperty.call(n.container.rearrangingItems,r)&&(f=o.source))for(s=o.sdimg[n.container.currentTemplateLevel],a=f.length-1;a>=0;a--)b=f[a],d&&s?n.container.drawImage(n.container.ctx,s,b.x,b.y,b.width,b.height):n.container.drawCanvasItem(n.container.ctx,b.x,b.y,b.width,b.height,o);for(l=n.container.rearrangingItemsArr.length-1;l>=0;l--)for(o=n.container.rearrangingItemsArr[l],f=o.source,v=o.destination,_=o.startTime,s=o.sdimg[n.container.currentTemplateLevel],a=f.length-1;a>=0;a--)b=f[a],T=v[a],I=_[a],p=void 0===I?1:Math.max((now-I)/700,0),p>=1?(p=1,g=0):(L=!1,p=p<.5?(Math.exp(p*n.container.stiffness)-1)*n.container.springConstant:1-(Math.exp((1-p)*n.container.stiffness)-1)*n.container.springConstant,g=1-p),S=b.x*g+T.x*p,D=b.y*g+T.y*p,w=b.width*g+T.width*p,y=b.height*g+T.height*p,d&&s?n.container.drawImage(n.container.ctx,s,S,D,w,y):h?n.container.setTransform(o.html[n.container.currentTemplateLevel][a],new Seadragon2.Rect(S,D,w,y)):n.container.drawCanvasItem(n.container.ctx,S,D,w,y,o);L&&n.container.trigger("animationfinish",n.container)}else{var E=n.container.viewport.update();if(!n.container.animating&&E&&n.container.trigger("animationstart",n.container),n.container.anythingChanged=n.container.anythingChanged||E,n.container.anythingChanged){n.container.anythingChanged=!1,n.container.hoveredItem=void 0,
n.container.lastHoveredBar=n.container.hoveredBar,n.container.hoveredBar=void 0;var x,k,M,P,C,R,A,O=1/0;x=n.container.getBounds(!0),n.container.setupFrontLayer(n.container.viewport.getZoom(!0),x),n.container.currentTemplateType=n.container.templates[n.container.currentTemplateLevel].type,d="sdimg"===u||"fakehtml"===u,h="html"===u,m="canvas"===u||"color"===u||"img"===u,n.container.redraw(),k=n.container.getBounds(),C=n.container.viewport.getZoomPercent(),n.container.trigger("zoom",C),n.container.lastMousePosition&&(n.container.contentMousePosition=n.container.viewport.pointFromPixel(n.container.lastMousePosition.minus(new Seadragon2.Point(n.container.padding.left,n.container.padding.top)),!0)),n.container.views.filter(function(e){return e.isSelected})[0].update({canvas:n.container.canvas,container:n.container.container,frontLayer:n.container.frontLayer,backLayer:n.container.backLayer,mapLayer:n.container.mapLayer,tableLayer:n.container.tableLayer,leftRailWidth:n.container.leftRailWidth,rightRailWidth:n.container.rightRailWidth,inputElmt:n.container.inputElmt});var N,B,z=.5*(i.x-n.container.rightRailWidth),V=.5*i.y,F=new Seadragon2.Point(-n.container.rightRailWidth/2,0);for(n.container.centerItem=void 0,n.container.zoomedIn=!1,l=n.container.activeItemsArr.length-1;l>=0;l--)for(o=n.container.activeItemsArr[l],N=o.source,s=o.sdimg[n.container.currentTemplateLevel],a=N.length-1;a>=0;a--)M=N[a],M&&(n.container.rectsOverlap(x,M)?(n.container.rectsOverlap(k,M)&&(P=n.container.viewport.rectPixelsFromPoints(M,!1,!0),d&&s&&s.update(P),(P.width>z||P.height>V)&&(n.container.zoomedIn=!0),A=P.getCenter().distanceTo(F),A<O&&(O=A,n.container.centerItem=o,centerItemIndex=a,R=M)),d&&s?n.container.anythingChanged=!n.container.drawImage(n.container.ctx,s,M.x,M.y,M.width,M.height)||n.container.anythingChanged:h?(B=o.html[n.container.currentTemplateLevel][a],B.pvInDom||(n.container.addElementToFrontLayer(B),B.pvInDom=!0)):n.container.anythingChanged=!n.container.drawCanvasItem(n.container.ctx,M.x,M.y,M.width,M.height,o)||n.container.anythingChanged,n.container.lastMousePosition&&M.contains(n.container.contentMousePosition)&&(n.container.hoveredItem=o,n.container.hoveredItemIndex=a)):h&&(B=o.html[n.container.currentTemplateLevel][a],B.pvInDom&&(n.container.frontLayer.removeChild(B),B.pvInDom=!1)));var H=n.container.viewport.deltaPointsFromPixels(new Seadragon2.Point(3,0)).x;n.container.outlineItem(n.container.hoveredItem,n.container.hoveredItemIndex,n.container.hoverBorderColor,n.container.ctx,n.container.domHoverBorder,H),n.container.centerItem&&n.container.zoomedIn?(n.container.detailsEnabled&&(n.container.trigger("showDetails",n.containercenterItem,n.container.facets),n.container.trigger("showInfoButton")),n.container.trigger("filterItem",n.container.centerItem,n.container.facets),n.container.viewport.visibilityRatio=(i.x-n.container.rightRailWidth)/i.x):n.container.viewport.visibilityRatio=1,n.container.outlineItem(n.container.selectedItem,n.container.selectedItemIndex,n.container.selectedBorderColor,n.container.ctx,n.container.domSelectedBorder,H)}n.container.animating&&!E&&n.container.trigger("animationfinish",n.container),n.container.animating=E}};var GraphView=function(e,t){GridView.call(this,e,t);var n=this;n.button=new Button("div","pivot_sorttools graphButton pivot_hoverable",$(".pivot_topbar")[0],i18n.t("graphView")),n.button.htmlElement.onclick=function(){n.select(),$(".frontLayer")[0].style.visibility="visible",$(".behindLayer")[0].style.visibility="visible",$(".mapLayer")[0].style.visibility="hidden",$(".tableLayer")[0].style.visibility="hidden"}};GraphView.prototype=Object.create(GridView.prototype),GraphView.prototype.constructor=GraphView,GraphView.prototype.createView=function(e){this.container.allSortedItems=this.container.bucketize[this.container.facet.type||"String"](this.container.sortFacet);var t=this.container.containerRect.width/this.container.allSortedItems.length,n=.86*t;this.container.bars=[],this.container.topLeftItemInfo=this.container.rightmostItemInfo=void 0;var r,o=0;for(i=0;i<this.container.allSortedItems.length;i++)r=this.container.allSortedItems[i],r.items.length>o&&(o=r.items.length);var a=100/t;if(this.container.backZoomContainer.setSizeRatio(a),this.container.barTemplate.style.height=a*this.container.containerRect.height+"px",35/a>70){var s=Math.max(5,Math.round(70*a));this.container.barTemplate.firstChild.style.bottom=s+7+"px",this.container.barTemplate.lastChild.style.height=s+"px",this.container.barTemplate.style.fontSize=s/2+"px",this.container.containerRect.height-=(s+13)/100*t}else this.container.barTemplate.firstChild.style.bottom="",this.container.barTemplate.lastChild.style.height="",this.container.barTemplate.style.fontSize="",this.container.containerRect.height-=.48*t;var l=this.container.containerRect.height-.06*t;this.container.numPerRow=this.container.computeLayoutWidth(o,n,l,this.container.avgHeight),this.container.widthPerItem=n/this.container.numPerRow;var c,u,d,h,m;for(i=0;i<this.container.allSortedItems.length;i++){var p=t*(i+.07);r=this.container.allSortedItems[i],this.container.totalItemCount=r.items.length;var g=this.container.clone(this.container.barTemplate);g.style.left=100*i+1+"px";var f=g.firstChild,v=f.firstChild,S=f.nextSibling;if(e.backLayer.appendChild(g),r.leftLabel){var D=makeElement("div","pivot_leftlabel",S);addText(D,r.leftLabel),c?(c.parentNode.removeChild(c),D.style.left=-D.offsetWidth/2+"px",D.style.textAlign="center"):D.style.width="50%";var w=makeElement("div","pivot_rightlabel",S);addText(w,r.rightLabel),c=w}else addText(S,r.label),c=void 0;if(this.container.totalItemCount<this.container.numPerRow&&this.container.totalItemCount>0){var y=86*this.container.totalItemCount/this.container.numPerRow;p=t*i+(100-y)/2*t/100,y+=4,y=2*Math.round(y/2),v.style.width=y+"px",v.style.left=(98-y)/2+"px"}u=this.container.placeGrid(this.container.containerRect.height,p,r.items,this.container.numPerRow,this.container.widthPerItem,this.container.widthPerItem*this.container.avgHeight,!0),this.container.finalItemWidth=u.itemWidth,this.container.topLeftItemInfo||(this.container.topLeftItemInfo=u.topLeft),u.rightmost&&(this.container.rightmostItemInfo=u.rightmost),d&&(h=d.lowest,m=u.topLeft,h&&m&&(h.item.destination[h.index].down=m,m.item.destination[m.index].up=h),h&&!u.lowest&&(u.lowest=h),h=d.rightmost,h&&m&&(h.item.destination[h.index].right=m,m.item.destination[m.index].left=h),h&&!u.rightmost&&(u.rightmost=h)),d=u,v.style.height=Math.round(100*Math.ceil(r.items.length/this.container.numPerRow)*this.container.widthPerItem*this.container.avgHeight/t+4)+"px";var b;switch(this.container.facets[this.container.sortFacet].type){case"String":case"Link":b=r.values;break;case"Number":case"DateTime":b=[{lowerBound:r.lowerBound,upperBound:r.upperBound,inclusive:r.inclusive}];break;default:Seadragon2.Debug.warn("Unrecognized category type: "+this.container.facets[optins.sortFacet].type)}this.container.bars.push({bar:g,values:b,min:t*i,name:r.label,count:this.container.totalItemCount})}},GraphView.prototype.update=function(e){var t;if(this.container.lastMousePosition)for(t=this.container.bars.length,i=0;i<t&&this.container.bars[i].min<=this.container.contentMousePosition.x;i++)this.container.hoveredBar=this.container.bars[i];this.container.hoveredBar&&!this.container.hoveredBar.count&&(this.container.hoveredBar=void 0),this.container.hoveredBar!==this.container.lastHoveredBar&&(this.container.hoveredBar?(this.container.hoveredBar.bar.className="pivot_bar pivot_highlight",e.container.title=this.container.hoveredBar.name):e.container.title="",this.container.lastHoveredBar&&(this.container.lastHoveredBar.bar.className="pivot_bar"))},GraphView.prototype.onClick=function(e){var t;for(t=this.container.bars.length,i=0;i<t&&this.container.bars[i].min<=this.container.position.x;i++)this.container.hoveredBar=this.container.bars[i];this.container.hoveredBar&&!this.container.hoveredBar.count&&(this.container.hoveredBar=void 0)};var MapView=function(e,t){BaseView.call(this,e,t);var n=this;n.markers=[],n.isCreated=!1,n.highlightedMarkers=[],n.button=new Button("div","pivot_sorttools mapButton pivot_activesort",$(".pivot_topbar")[0],i18n.t("mapView")),n.button.htmlElement.onclick=function(){n.select(),$(".frontLayer")[0].style.visibility="hidden",$(".behindLayer")[0].style.visibility="hidden",$(".mapLayer")[0].style.visibility="visible",$(".tableLayer")[0].style.visibility="hidden"},this.enableClustering=PIVOT_PARAMETERS.map.enableClustering,this.highlightMarkersOnFilter=PIVOT_PARAMETERS.map.highlightMarkersOnFilter,this.multipleClusterColors=PIVOT_PARAMETERS.map.multipleClusterColors,this.clusterRadius=PIVOT_PARAMETERS.map.clusterRadius,this.startClusterLimit=PIVOT_PARAMETERS.map.startClusterLimit,this.sourceURL=PIVOT_PARAMETERS.map.sourceURL,this.markerUrl=PIVOT_PARAMETERS.map.markerUrl,this.highlightedMarkerUrl=PIVOT_PARAMETERS.map.highlightedMarkerUrl,this.filteredMarkerUrl=PIVOT_PARAMETERS.map.filteredMarkerUrl,this.routeMarkerUrl=PIVOT_PARAMETERS.map.routeMarkerUrl,this.routeMarkerShadowUrl=PIVOT_PARAMETERS.map.routeMarkerShadowUrl,this.detailsEnabled=PIVOT_PARAMETERS.detailsEnabled,this.filterElement=PIVOT_PARAMETERS.filterElement,this.activeItems={},this.defaultIcon=new L.Icon({iconUrl:this.markerUrl,iconAnchor:[12,41],popupAnchor:[0,-41],iconSize:[32,32]}),this.highlightedIcon=new L.Icon({iconUrl:this.highlightedMarkerUrl,iconAnchor:[12,41],popupAnchor:[0,-41],iconSize:[32,32]}),this.filteredIcon=new L.Icon({iconUrl:this.filteredMarkerUrl,iconAnchor:[12,41],popupAnchor:[0,-41],iconSize:[32,32]}),this.routeIcon=new L.Icon({iconUrl:this.routeMarkerUrl,shadowUrl:this.routeMarkerShadowUrl,iconAnchor:[12,41]}),img=document.createElement("img"),img.src=this.highlightedMarkerUrl,img1=document.createElement("img"),img1.src=this.filteredMarkerUrl,img2=document.createElement("img"),img2.src=this.routeMarkerUrl,img3=document.createElement("img"),img3.src=this.routeMarkerShadowUrl,n.isRouteHeaderClicked=!1};MapView.prototype=Object.create(BaseView.prototype),MapView.prototype.constructor=MapView,MapView.prototype.createView=function(e){function t(e){void 0!=w&&y(),w=L.Routing.control({waypoints:[L.latLng(e[0].latLng.lat,e[0].latLng.lng),L.latLng(e[1].latLng.lat,e[1].latLng.lng)],createMarker:function(e,t,n){var i=L.marker(t.latLng);return i.setForceZIndex(2e3),i.options.draggable=!0,i.options.icon=c.routeIcon,i},routeWhileDragging:!0,geocoder:L.Control.Geocoder.nominatim(),language:"ru",fitSelectedRoutes:!1}).addTo(S),w.on("routesfound",function(e){var t=e.routes;t[0].summary;i(),r()})}function n(e,t){return void 0!=e[t]?e[t][0]:void 0}function i(){$(".leaflet-routing-geocoder").find("input").off(),$(".leaflet-routing-geocoder").find("input").on("click",function(e){setTimeout(function(){e.originalEvent.target.focus()},10)})}function r(){$(".leaflet-routing-add-waypoint").off(),$(".leaflet-routing-add-waypoint").click(function(e){i()})}function o(e){var t=n(e.options.dataRow,"LATITUDE")||n(e.options.dataRow,"LAT")||n(e.options.dataRow,"")||n(e.options.dataRow,"");return s(t)}function a(e){return val=n(e.options.dataRow,"LONGITUDE")||n(e.options.dataRow,"LONG")||n(e.options.dataRow,"")||n(e.options.dataRow,""),s(val)}function s(e){return"string"==typeof e?parseFloat(e):e}function l(){var t={};t=e.activeItems!=={}?e.activeItems:e.items,Object.entries(c.activeItems).length!==Object.entries(t).length?(c.rearrange(t),c.activeItems=t):c.showSelectedItems()}var c=this;if(c.isCreated)l(),c.mapDiv.style.height=e.canvas.clientHeight-12+"px";else{c.isCreated=!0;var u=function(e){var t=c.map.getCenter();"undefined"!=typeof e.layer.options.crs?c.map.setCrs(e.layer.options.crs):c.map.setCrs(L.CRS.EPSG3857),c.map.setView(t,c.map.getZoom())},d=function(e,t){if("js"==t){var n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",c.sourceURL+e)}else if("css"==t){var n=document.createElement("link");n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.setAttribute("href",c.sourceURL+e)}"undefined"!=typeof n&&document.getElementsByTagName("head")[0].appendChild(n)},h=L.tileLayer("http://mt{s}.google.com/vt/lyrs=m&z={z}&x={x}&y={y}&lang=ru_RU",{subdomains:["0","1","2","3"],attribution:'<a http="google.ru" target="_blank">Google</a>',reuseTiles:!0,updateWhenIdle:!1}),m=L.tileLayer("http://mt{s}.google.com/vt/lyrs=y&z={z}&x={x}&y={y}&lang=ru_RU",{subdomains:["0","1","2","3"],attribution:'<a http="google.ru" target="_blank">Google</a>',reuseTiles:!0,updateWhenIdle:!1}),p=L.tileLayer("http://a.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'<a http="google.ru" target="_blank">Open Streets</a>',reuseTiles:!0,updateWhenIdle:!1}),g=new L.Yandex,f=new L.Yandex("hybrid");new L.Yandex("publicMap");c.mapDiv=makeElement("div","mapDiv",e.mapLayer);var v=e.canvas.clientWidth-e.leftRailWidth-11;e.canvas.clientHeight-12;c.mapDiv.style.marginLeft="215px",c.mapDiv.style.marginTop="6px",c.mapDiv.style.marginRight="6px",c.mapDiv.style.position="relative",c.mapDiv.style.width=v+"px",c.mapDiv.style.height="1000px";var S=L.map(c.mapDiv,{layers:[g],preferCanvas:!0}).setView([0,0],2);c.map=S,L.Map.prototype.setCrs=function(e){this.options.crs=e};var D={"":g," ":f,Google:h,"Google ":m,"Open Streets":p};S.on("baselayerchange",u),S.on("click",function(e){c.isRouteHeaderClicked||(c.resetHighlightedMarkers(),c.container.trigger("filterSet",c.container.activeItemsArr)),c.isRouteHeaderClicked=!1}),L.control.layers(D,null,{position:"bottomleft"}).addTo(S),this.multipleClusterColors?d("Content/MarkerCluster.Default.css","css"):d("Content/MarkerCluster.Redefined.css","css"),L.Control.RouteInput=L.Control.extend({onAdd:function(e){var t=L.DomUtil.create("div");return t.classList.add("route-control"),t.innerHTML="<div id='routeHeader'><h7></h7><img id='toggleImage' src='"+PIVOT_PARAMETERS.map.toggleDownImage+"' class='toggleImage' /></div></div>",t},onRemove:function(e){}}),L.control.routeInput=function(e){return new L.Control.RouteInput(e)};var w,y=(L.control.routeInput({position:"topright"}).addTo(S),function(){w.spliceWaypoints(0,2),$(".leaflet-routing-container").remove()});$("#routeHeader").click(function(e){if(c.isRouteHeaderClicked=!0,$("#toggleImage")[0].src.includes("toggle-down.png")){$("#toggleImage")[0].src=PIVOT_PARAMETERS.map.toggleUpImage;var n,i,r,s;if(void 0!=c.selectedMarker)n=o(c.selectedMarker),i=a(c.selectedMarker);else{var l=c.map.getCenter();n=l.lat,i=l.lng}r=n+.1,s=i+.1;var u=[{latLng:{lat:n,lng:i}},{latLng:{lat:r,lng:s}}];t(u)}else $("#toggleImage")[0].src=PIVOT_PARAMETERS.map.toggleDownImage,y()}),l()}},MapView.prototype.filter=function(e){this.container.selectedItems=[],this.rearrange(e)},MapView.prototype.rearrange=function(e){this.setMarkers(e)},MapView.prototype.showSelectedItems=function(){var e=this;e.resetHighlightedMarkers(),e.container.selectedItems.forEach(function(t,n){if(void 0!=t){var i=e.markers.filter(function(e){return t.facets===e.options.dataRow})[0];e.setMarkerIcon(i,e.highlightedIcon),e.highlightedMarkers.push(i)}})},MapView.prototype.resetHighlightedMarkers=function(){for(var e=this,t=0;t<e.highlightedMarkers.length;t++)if(e.highlightMarkersOnFilter){var n=e.filteredMarkers.filter(function(n){return n.options.dataRow==e.highlightedMarkers[t].options.dataRow})[0];void 0!=n?e.setMarkerIcon(e.highlightedMarkers[t],e.filteredIcon):e.setMarkerIcon(e.highlightedMarkers[t],e.defaultIcon)}else e.setMarkerIcon(e.highlightedMarkers[t],e.defaultIcon);e.selectedMarker=void 0,e.highlightedMarkers=[]},MapView.prototype.substituteValues=function(e,t){var n=e;return null!=t[0]&&void 0!=t[0]&&(n=n.replace("{LABEL}",t[0])),null!=t[1]&&void 0!=t[1]&&(n=n.replace("{HINT}",t[1])),null!=t[2]&&void 0!=t[2]&&(n=n.replace("{URL}",t[2])),null!=t[3]&&void 0!=t[3]&&Array.isArray(t[3])&&t[3].forEach(function(e,t){n=n.replace("{DIM"+t+"}",e)}),n},MapView.prototype.setMarkerIcon=function(e,t){e.setIcon(t)},MapView.prototype.setMarkers=function(e){function t(e,t,n,r,o){var a=new L.marker([e,t]);if(void 0!=i.popupHTML&&""!=i.popupHTML)a.bindPopup(i.substituteValues(i.popupHTML,[r,o]));else if(void 0!=i.popupURL&&""!=i.popupURL){var s='<iframe style="width:300px;height:300px;" src="'+i.popupURL+'" />"';a.bindPopup(i.substituteValues(s,[r,o]))}else a.bindPopup(o);return i.highlightMarkersOnFilter?i.setMarkerIcon(a,i.filteredIcon):i.setMarkerIcon(a,i.defaultIcon),a.options.dataRow=n.facets,i.markers.push(a),a}function n(e,t){return void 0!=e.facets[t]?e.facets[t][0]:void 0}var i=this;if(null!=i.map&&void 0!=i.map){var r=[];if("object"==typeof e?r=Object.values(e):Array.isArray(values)&&(r=e),i.highlightMarkersOnFilter?i.markers.forEach(function(e){i.setMarkerIcon(e,i.defaultIcon)}):i.markers=[],i.filteredMarkers=[],r.forEach(function(e){var r=n(e,"LATITUDE")||n(e,"LAT")||n(e,"")||n(e,""),o=n(e,"LONGITUDE")||n(e,"LONG")||n(e,"")||n(e,""),a=n(e,"NAME")||n(e,"FULLNAME")||n(e,"SHORTNAME")||n(e,"FULL_NAME")||n(e,"SHORT_NAME")||n(e,"")||n(e," ")||n(e,PIVOT_PARAMETERS.nameElement),s=a;if("undefined"!=typeof r&&null!=r&&0!=r&&"undefined"!=typeof o&&null!=o&&0!=o)if(i.highlightMarkersOnFilter){var l=i.markers.filter(function(t){return t.options.dataRow[i.filterElement]===e.facets[i.filterElement]})[0];void 0!=l?i.setMarkerIcon(l,i.filteredIcon):l=t(r,o,e,a,s),i.filteredMarkers.push(l)}else t(r,o,e,a,s)}),null!=i.markerLayer&&void 0!=i.markerLayer&&(i.markerLayer.removeEventListener("click",a,!1),i.markerLayer.removeEventListener("mouseover",s,!1),i.markerLayer.removeEventListener("mouseout",l,!1),i.map.removeLayer(i.markerLayer)),null!=i.commonClusterLayer&&void 0!=i.commonClusterLayer&&(i.commonClusterLayer.removeEventListener("click",a,!1),i.commonClusterLayer.removeEventListener("mouseover",s,!1),i.commonClusterLayer.removeEventListener("mouseout",l,!1),i.map.removeLayer(i.commonClusterLayer)),null!=i.filteredClusterLayer&&void 0!=i.filteredClusterLayer&&(i.filteredClusterLayer.removeEventListener("click",a,!1),i.filteredClusterLayer.removeEventListener("mouseover",s,!1),i.filteredClusterLayer.removeEventListener("mouseout",l,!1),i.map.removeLayer(i.filteredClusterLayer)),i.enableClustering&&i.markers.length>=i.startClusterLimit){if(i.commonClusterLayer=L.markerClusterGroup({iconCreateFunction:function(e){var t=i.commonClusterLayer._defaultIconCreateFunction(e);return t.options.className+=" common-group",t},maxClusterRadius:i.clusterRadius}),i.filteredClusterLayer=L.markerClusterGroup({iconCreateFunction:function(e){var t=i.commonClusterLayer._defaultIconCreateFunction(e);return t.options.className+=" filtered-group",t},maxClusterRadius:i.clusterRadius}),i.filteredMarkers.length==i.markers.length)for(var o=0;o<i.markers.length;++o)i.filteredClusterLayer.addLayer(i.markers[o]);else{for(var o=0;o<i.filteredMarkers.length;++o)i.filteredClusterLayer.addLayer(i.filteredMarkers[o]);for(var o=0;o<i.markers.length;++o)i.filteredMarkers.includes(i.markers[o])||i.commonClusterLayer.addLayer(i.markers[o])}i.map.addLayer(i.filteredClusterLayer),i.map.addLayer(i.commonClusterLayer)}else i.markerLayer=new L.featureGroup(i.markers),i.map.addLayer(i.markerLayer);i.highlightMarkersOnFilter&&(i.filteredMarkersLayer=new L.featureGroup(i.filteredMarkers)),i.highlightMarkersOnFilter&&i.filteredMarkers.length>0?setTimeout(function(){i.map.fitBounds(i.filteredMarkersLayer.getBounds()),setTimeout(function(){i.showSelectedItems()}.bind(i),100)}.bind(i),100):i.markers.length>0&&setTimeout(function(){i.map.fitBounds(i.markerLayer.getBounds()),setTimeout(function(){i.showSelectedItems()}.bind(i),100)}.bind(i),100),0==i.markers.length&&i.map.setView([0,0],2),i.isExecuteSelectItem=!0;var a=function(t){var n=t.layer;if(i.filteredMarkers.includes(n)){i.resetHighlightedMarkers(),i.setMarkerIcon(n,i.highlightedIcon),i.highlightedMarkers.push(n),i.selectedMarker=n;var r;r="object"==typeof e?Object.values(e):e;var o=r.filter(function(e){return e.facets===n.options.dataRow})[0];i.detailsEnabled&&(i.container.trigger("showDetails",o,i.container.facets),i.container.trigger("showInfoButton")),i.container.trigger("filterItem",o,i.container.facets),i.container.selectedItems=[],i.container.selectedItems.push(o)}},s=function(e){e.layer.openPopup()},l=function(e){e.layer.closePopup()};null!=i.markerLayer&&void 0!=i.markerLayer&&(i.markerLayer.addEventListener("click",a,!1),i.markerLayer.addEventListener("mouseover",s,!1),i.markerLayer.addEventListener("mouseout",l,!1)),null!=i.filteredClusterLayer&&void 0!=i.filteredClusterLayer&&(i.filteredClusterLayer.addEventListener("click",a,!1),i.filteredClusterLayer.addEventListener("mouseover",s,!1),i.filteredClusterLayer.addEventListener("mouseout",l,!1)),null!=i.commonClusterLayer&&void 0!=i.commonClusterLayer&&(i.commonClusterLayer.addEventListener("click",a,!1),i.commonClusterLayer.addEventListener("mouseover",s,!1),i.commonClusterLayer.addEventListener("mouseout",l,!1))}},MapView.prototype.clearFilter=function(){var e=this;e.rearrange(e.activeItems)};var TableView=function(e,t){BaseView.call(this,e,t);var n=this;n.detailsEnabled=PIVOT_PARAMETERS.detailsEnabled,n.filterElement=PIVOT_PARAMETERS.filterElement,n.isCreated=!1,n.activeItems={},n.button=new Button("div","pivot_sorttools tableButton pivot_hoverable",$(".pivot_topbar")[0],i18n.t("tableView")),n.button.htmlElement.onclick=function(){n.select(),$(".frontLayer")[0].style.visibility="hidden",$(".behindLayer")[0].style.visibility="hidden",$(".mapLayer")[0].style.visibility="hidden",$(".tableLayer")[0].style.visibility="visible"}};TableView.prototype=Object.create(BaseView.prototype),TableView.prototype.constructor=TableView,TableView.prototype.createView=function(e){var t=this;if(!t.isCreated){t.isCreated=!0;var n=makeElement("div","tableView ag-theme-balham tableDiv",e.tableLayer);t.div=n,n.innerHtml="";var i=e.canvas.clientWidth-e.leftRailWidth-11,r=e.canvas.clientHeight-12,o=document.createElement("style");o.type="text/css",o.innerHTML=".tableDiv { width: "+i+"px; height:"+r+"px; position: relative; margin-left: "+(e.leftRailWidth+5)+"px; margin-top: 6px;margin-right: 6px;",document.getElementsByTagName("head")[0].appendChild(o);var a=Object.entries(e.activeItems).map(function(e){var t={};return Object.entries(deleteAdditionalProperties(e[1])).forEach(function(e){t[e[0]]=e[1][0]}),t});t.activeItems=e.activeItems;var s=[],l=Object.entries(e.activeItems)[0];void 0!=l&&Object.entries(deleteAdditionalProperties(l[1])).forEach(function(e){isHTML(e[1])?s.push({headerName:e[0],field:e[0],cellRenderer:function(t){return void 0!==t.data?t.data[e[0]]:""}}):s.push({headerName:e[0],field:e[0],sortable:!0,resizable:!0})}),t.isExecuteSelectItem=!0,t.setFilter=function(){var n=t.gridOptions.api.getSelectedNodes(),i=n.map(function(e){return e.data}),r=Object.entries(e.activeItems).map(function(e){return e[1]}).filter(function(e){var n=!1;return i.forEach(function(i){n=(Array.isArray(e.id)?e.id[0]:e.id)===i[t.filterElement]||n}),n});t.detailsEnabled&&1===r.length?(t.container.trigger("showDetails",r[0],t.container.facets),t.container.trigger("showInfoButton")):(t.container.trigger("hideDetails"),t.container.trigger("hideInfoButton")),t.container.trigger("filterSet",r,t.container.facets),t.container.selectedItems=[],r.length>0&&t.container.selectedItems.push(r[0])},t.gridOptions={columnDefs:s,rowSelection:"single",onRowSelected:function(e){t.setFilter()},rowModelType:"infinite",datasource:t.getDataSource(a)},new agGrid.Grid(document.querySelector(".tableView"),t.gridOptions);var c=t.gridOptions.columnApi.getAllColumns().map(function(e){return e.colId}),u=!1;t.gridOptions.columnApi.autoSizeColumns(c,u)}t.showSelectedItems()},TableView.prototype.getDataSource=function(e){return{rowCount:null,getRows:function(t){console.log("asking for "+t.startRow+" to "+t.endRow),setTimeout(function(){var n=e.slice(t.startRow,t.endRow),i=-1;e.length<=t.endRow&&(i=e.length),t.successCallback(n,i)},500)}}},TableView.prototype.filter=function(e){var t=this;t.container.selectedItems=[],t.rearrange(e)},TableView.prototype.rearrange=function(e){var t=this;if(t.isCreated){var n=Object.entries(e).map(function(e){var t={};return Object.entries(deleteAdditionalProperties(e[1])).forEach(function(e){t[e[0]]=e[1][0]}),t});t.gridOptions.api.setDatasource(t.getDataSource(n))}},TableView.prototype.showSelectedItems=function(){var e=this;void 0!==e.gridOptions&&e.gridOptions.api.deselectAll(),e.container.selectedItems.forEach(function(t,n){if(void 0!=t){var i=0;void 0!==e.gridOptions&&(e.gridOptions.api.forEachNode(function(n,r){n.data[e.filterElement]===(Array.isArray(t.id)?t.id[0]:t.id)&&(n.setSelected(!0,!0),i=r)}),e.gridOptions.api.ensureIndexVisible(i))}})},TableView.prototype.clearFilter=function(){var e=this;void 0!==e.gridOptions&&e.gridOptions.api.deselectAll()};var Exporter=function(){},CSVExporter=function(e,t,n,i,r,o){Exporter.call(this),this.decimalSeparator=e,this.fieldSeparator=t,this.rowSeparator=n,this.quote=i,this.culture=r,this.encoding=o};CSVExporter.prototype=Object.create(Exporter.prototype),CSVExporter.prototype.constructor=CSVExporter,CSVExporter.prototype["export"]=function(e){var t=this,n="\ufeff",i="data:text/csv;charset="+t.encoding+","+n+Object.keys(e[0]).map(function(e){return t.quote+e+t.quote}).join(t.fieldSeparator)+t.rowSeparator+e.map(function(e){return Object.values(e).map(function(e){var n=Array.isArray(e)?e[0]:e;if(void 0===n)n=t.quote+t.quote;else if(n instanceof Date)n=t.quote+n.toLocaleString(t.culture)+t.quote;else if("number"==typeof n)n=t.quote+n.toString().replaceAll(t.fieldSeparator,t.decimalSeparator)+t.quote;else if("string"==typeof n){var i=getHrefFromHTML(n),r=getTextFromHTML(n);n=void 0!=i?t.quote+i+t.quote:t.quote+r.replaceAll(t.fieldSeparator,"").replaceAll(t.quote,"").replaceAll(/(\r\n|\n|\r)/gm,"")+t.quote}return n}).join(t.fieldSeparator)}).join(t.rowSeparator);this.dataURLtoBlob(i,this.callback)},CSVExporter.prototype.dataURLtoBlob=function(e,t){for(var n=e.substring(28,e.length-1),i=e.substring(0,27).match(/:(.*?);/)[1],r=unescape(encodeURIComponent(n)),o=r.length,a=new Uint8Array(o);o--;)a[o]=r.charCodeAt(o);t(new Blob([a],{type:i}))},CSVExporter.prototype.callback=function(e){if(void 0!==window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,"data.csv");else{var t=document.createElement("a");t.download="data.csv",t.innerHTML="download",t.href=URL.createObjectURL(e),t.onclick=function(){requestAnimationFrame(function(){URL.revokeObjectURL(decodeURI(t.href)),document.body.removeChild(t)})},t.click()}};var PivotViewer=Pivot.PivotViewer=function(e,t,n,i,r,o,a,s,l){function c(){M.prevActiveItems=M.activeItems,M.activeItems={},M.activeItemsArr=[],M.items.forEach(function(e){O.every(function(t){return t(e)})&&(M.activeItems[e.id]=e,M.activeItemsArr.push(e))});var e=!arraysEqual(Object.entries(M.activeItems).map(function(e){return e[1].id}),Object.entries(M.prevActiveItems).map(function(e){return e[1].id}));(e||M.views[0].isSelected||M.views[1].isSelected)&&(M.views.forEach(function(e){e.filter(M.activeItems)}),M.detailsEnabled&&(M.trigger("hideDetails"),M.trigger("hideInfoButton")),M.trigger("filterSet",M.activeItems))}function u(e,t){if(!t||t<0)if(M.delayedFunction){var n=M.delayedFunction;M.delayedFunction=function(){n(),e()}}else M.delayedFunction=e;else u(function(){u(e,t-1)})}function d(){(M.GridView.isSelected||M.GraphView.isSelected)&&M.GridView.rearrangePart2()}function h(e){var t=Math.floor(Math.log(e)/Math.LN10),n=e*Math.pow(10,-t),i=n<2.5?1:n<5?2.5:5;return i*Math.pow(10,t)}function m(){M.selectedItem=void 0,(M.GridView.isSelected||M.GraphView.isSelected)&&M.GridView.rearrange(),M.rearrangePart1()}function p(e,t){return(M.GridView.isSelected||M.GraphView.isSelected)&&M.GridView.updateOnce(e,t),!0}function g(){M.lastMousePosition=void 0,M.anythingChanged=!0}function f(e){e=e||window.event,M.lastMousePosition=Seadragon2.Mouse.getPosition(e).minus(Seadragon2.Element.getPosition(t)),M.anythingChanged=!0}function v(c,u,d,h,m,p){var g,f=(new Date).getTime();if(d){M.position=C.pointFromPixel(d.minus(new Seadragon2.Point(M.padding.left,M.padding.top)),!0);var v,S,D,w;for(M.views.filter(function(e){return e.isSelected})[0].onClick({canvas:e,container:t,frontLayer:n,backLayer:i,mapLayer:r,tableLayer:o,leftRailWidth:a,rightRailWidth:s,inputElmt:l}),S=M.activeItemsArr.length-1;S>=0;S--)for(w=M.activeItemsArr[S],D=w.source,v=D.length-1;v>=0;v--)g=D[v],g&&g.contains(M.position)&&(M.hoveredItem=w,M.hoveredItemIndex=v)}if(!p&&h&&f-H>U){if(!M.hoveredItem||M.selectedItem===M.hoveredItem&&M.selectedItemIndex===M.hoveredItemIndex)!M.hoveredItem&&M.hoveredBar?M.trigger("filterrequest",{facet:M.sortFacet,values:M.hoveredBar.values,type:M.facets[M.sortFacet].type}):(M.selectedItem=void 0,C.goHome());else{M.selectedItem=M.hoveredItem,M.selectedItemIndex=M.hoveredItemIndex,g=M.hoveredItem.source[M.hoveredItemIndex];var y,b=C.getContainerSize(),T=b.x,I=b.y,_=M.detailsEnabled?T-s:T;y=Math.max((_/g.width*g.height/I*1.4-1)/2,.2),g=new Seadragon2.Rect(g.x-g.width*y,g.y,g.width*(1+2*y)*T/_,g.height),C.fitBounds(g)}H=f}}function S(){l.focus()}function D(){var e=document.documentElement;B=!1,e.className=e.className.replace(" pivot_move","")}function w(){B||(B=!0,document.documentElement.className+=" pivot_move"),M.selectedItem=void 0}function y(){M.selectedItem=void 0,l.focus()}function b(e){var t,n,i=e.keyCode;if(i>=37&&i<=40){if(C.getZoomPercent())switch(t=M.centerItem.source[M.centerItemIndex],i){case 37:n=t.left;break;case 38:n=t.up;break;case 39:n=t.right;break;case 40:n=t.down}else switch(i){case 37:case 38:n=M.rightmostItemInfo;break;case 39:case 40:n=M.topLeftItemInfo}n&&(M.selectedItem===n.item&&M.selectedItemIndex===n.index||(M.hoveredItem=n.item,M.hoveredItemIndex=n.index,v(void 0,0,void 0,!0))),e.preventDefault&&e.preventDefault()}}function T(t,n){u(function(){e.width=t,e.height=n}),C.resizeContent(C.getContainerSize()),C.update(),m()}function I(e){var t,n,i,r,o=makeElement("div"),a=["top","right","bottom","left"];for(i=0;i<4;i++)for(t=o["pv"+a[i]]=makeElement("div",e,o),n=t.style,r=0;r<4;r++)i!==r&&(n[a[r]]="-1px");return o}function _(){M.backZoomContainer=new Seadragon2.HTMLZoomContainer(i),N=new Seadragon2.HTMLZoomContainer(n),Seadragon2.Viewer.call(M,t,{constrainDuringPan:!0,ignoreChange:!0,viewportOptions:{minZoom:1,visibilityRatio:1,selfUpdating:!1},padding:{top:5,right:5,bottom:5,left:a+5},dragCursor:"",zoomContainers:[M.backZoomContainer,new Seadragon2.CanvasZoomContainer(e),N]}),i=i.firstChild,n=n.firstChild,P=M.tracker,C=M.viewport,P.clearListeners("click"),(M.GridView.isSelected||M.GraphView.isSelected)&&(P.addListener("exit",g),Seadragon2.Event.add(t,"mousemove",f,!1),P.addListener("click",v),P.addListener("press",S),P.addListener("release",D),P.addListener("drag",w),P.addListener("scroll",y),l.addEventListener("keydown",b,!1)),M.addListener("resize",T),M.addListener("clearFilter",function(){M.detailsEnabled&&(M.trigger("hideDetails"),M.trigger("hideInfoButton")),M.selectedItems=[]}),Seadragon2.Timer.register(p),M.barTemplate=makeElement("div","pivot_bar");var r;r=makeElement("div","pivot_outerbar",M.barTemplate),makeElement("div","pivot_innerbar",r),makeElement("div","pivot_barlabel",M.barTemplate),M.domHoverBorder=I("pivot_hoverborder"),M.domSelectedBorder=I("pivot_selectedborder"),n.appendChild(M.domHoverBorder),n.appendChild(M.domSelectedBorder),M.hoverBorderColor=Seadragon2.Element.getStyle(M.domHoverBorder.pvtop).backgroundColor,M.selectedBorderColor=Seadragon2.Element.getStyle(M.domSelectedBorder.pvtop).backgroundColor,n.removeChild(M.domHoverBorder),n.removeChild(M.domSelectedBorder)}function L(){var e;for(e in $)if(hasOwnProperty.call($,e)){var t=$[e];!function(){var n=parseInt(e,10),i=t.level,r=t.items;Seadragon2.Xml.fetch(t.url,function(){var e;try{e=JSON.parse(M.responseText)}catch(t){return void Seadragon2.Debug.warn(i18n.t("parsingJsonError"))}if(e.ready){delete $[n],
Y--,i===M.currentTemplateLevel.toString()&&(M.anythingChanged=!0);var o=e.dzi,a=o.url;a=a.substr(0,a.length-4)+"_files/";var s=o.width,l=o.height,c=o.tileSize,u=o.tileFormat,d=Math.min(Math.log(c)/Math.LN2,Math.ceil(Math.log(Math.max(s,l))/Math.LN2));r.forEach(function(e,t){var n=e.sdimg[i]=new Seadragon2.Image(q);n.src=new Seadragon2.DzcTileSource(s,l,c,d,t,a,u,t),n.update()})}e.failed&&(delete $[n],Y--)},function(){Seadragon2.Debug.warn(i18n.t("receivedFailureCode"))})}()}Y&&u(L,60)}function E(){var e,t,n,i,r,o,a=[].reduce;i={href:location.href,style:a.call(document.styleSheets,function(e,t){return e+a.call(t.cssRules,function(e,t){return e+t.cssText},"")},"")};for(t in X)hasOwnProperty.call(X,t)&&(n=X[t],o=M.templates[t],e=o.renderer+"pivot/",i.width=o.width,i.height=o.height||o.width,i.items=n.map(function(e){return e.html[t][0].innerHTML}),r=JSON.stringify(i),r=lzwEncode(r),function(){var i=t,a=o.renderer,s=n;Seadragon2.Xml.fetch(e,function(){var e;try{e=JSON.parse(M.responseText)}catch(t){return void Seadragon2.Debug.warn(i18n.t("parsingJsonFailed"))}$[J++]={level:i,url:a+"content/"+e.id,items:s},Y++,1===Y&&u(L,60)},function(){Seadragon2.Debug.warn(i18n.t("postCollectionDataFailed")+M.statusText+"; response: "+M.responseText)},r)}());X={},Z=void 0}function x(e){var t,n,i=e.html,r=e.html=[],o=e.canvas,a=e.canvas=[],s=e.sdimg,l=e.sdimg=[],c=!i;if(s&&(l[-1]=s[-1]),M.templates.forEach(function(d,h){switch(d.type){case"canvas":r.push([]),a.push(d.func),l.push(void 0);break;case"img":case"color":r.push([]),a.push(makeTemplate(d,e)),l.push(void 0);break;case"sdimg":r.push([]),a.push(void 0),l.push(l[-1]);break;case"fakehtml":c?(t=d.renderer,n=X[h]=X[h]||[],n.push(e),void 0===Z&&(Z=!0,u(E)),r.push([makeTemplate(d,e)]),a.push(makeTemplate(d.fallback||{type:"color",template:"gray"},e)),l.push(void 0)):(r.push(i[h]),a.push(o[h]),l.push(s[h]));break;case"html":i?(r.push(i[h]),i[h].forEach(function(t){makeTemplate(d,e,t)})):r.push([makeTemplate(d,e)]),a.push(void 0),l.push(void 0);break;default:Seadragon2.Debug.warn(i18n.t("unrecognizedTemplateType"))}}),M.templates.length){var d=M.templates[M.templates.length-1];e.normHeight=(d.height||d.width)/d.width}}function k(e,t){hasOwnProperty.call(e,t)?e[t]++:e[t]=1}var M=this;M.container=t,M.backLayer=i,M.frontLayer=n,M.allSortedItems=void 0,M.facets={},M.facet={},M.items=[],M.sortFacet="",M.numPerRow=void 0,M.widthPerItem=void 0,M.totalItemCount=void 0,M.containerRect=void 0,M.avgHeight=void 0,M.activeItemsArr=[],M.selectedItems=[],M.isAdditionalViewsCreated=!1;var P,C;M.animating=!1,M.rearranging=!1,M.activeItems={},M.prevActiveItems={},M.rearrangingItems={},M.currentItems={};var R={};M.rearrangingItemsArr=[];var A=(new Date).getTime();M.stiffness=8,M.springConstant=1/(2*(Math.exp(M.stiffness/2)-1)),M.ctx=e.getContext("2d");var O=[];M.lastMousePosition=void 0,M.contentMousePosition=void 0,M.lastHoveredBar=void 0,M.position=void 0,M.hoveredItem=void 0,M.hoveredItemIndex=void 0,M.selectedItem=void 0,M.selectedItemIndex=void 0,M.centerItem=void 0,M.centerItemIndex=void 0,M.topLeftItemInfo=void 0,M.rightmostItemInfo=void 0,M.zoomedIn=void 0,M.hoveredBar=void 0,M.barTemplate=void 0,M.bars=[],M.backZoomContainer=void 0;var N,B,z=.05;M.detailsEnabled=PIVOT_PARAMETERS.detailsEnabled;var V=new Seadragon2.Point(0,0);M.drawImage=Seadragon2.Image.drawImage;var F=Seadragon2.Element.transform;M.anythingChanged=!0;var H=0,U=300;M.templates=[],M.templates[-1]={type:"sdimg"},M.currentTemplateLevel=-1;var G,j;M.finalItemWidth=void 0,M.delayedFunction,M.domHoverBorder=void 0,M.domSelectedBorder=void 0,M.hoverBorderColor=void 0,M.selectedBorderColor=void 0;var Z,q={manualUpdates:!0},W=function(){var e=makeElement("div"),t=makeElement("div");return t.innerHTML="a",e.appendChild(t),e.innerHTML="",!t.firstChild}(),X={},$={},Y=0,J=0;M.TableView=new TableView(M,(!1)),M.MapView=new MapView(M,(!0)),M.GraphView=new GraphView(M,(!1)),M.GridView=new GridView(M,(!1)),M.views=[M.GridView,M.GraphView,M.MapView,M.TableView],M.getLocationOutside=function(e){var t,n,i,r=C.getContainerSize(),o=r.times(.5),a=r.x+r.y,s=[],l=e.length;for(n=0;n<l;n++)i=e[n],t=i.getCenter().minus(o),t=t.times(a/t.distanceTo(V)),s.push(new Seadragon2.Rect(t.x-100,t.y-100,1.2*i.width,1.2*i.height));return s},M.addElementToFrontLayer=function(e){var t=e.unsetHTML;t&&(e.innerHTML=t,delete e.unsetHTML),n.appendChild(e)},M.clone=function(e){var t=e.cloneNode(!0);return t.unsetHTML=e.unsetHTML,t},M.beginAnimate=function(e){var t,n,i=!1,r=e.source,o=e.destination,a=r.length,s=e.startTime=[],l=e.id,c=C.getContainerSize(),u=c.x/2,d=c.y/2,h=e.sdimg[M.currentTemplateLevel];for(t=0;t<a;t++)n=o[t],r[t].equals(n)||(i=!0,s[t]=300*Math.random()+A,hasOwnProperty.call(M.rearrangingItems,l)||M.rearrangingItemsArr.push(e),M.rearrangingItems[l]=e,h&&h.update(new Seadragon2.Rect(n.x-u,n.y-d,n.width,n.height)));return i},M.resetRearrangingItems=function(){var e,t,i,r,o,a,s,l,c;for(c=M.rearrangingItemsArr.length-1;c>=0;c--){for(r={},e=M.rearrangingItemsArr[c],a=e.source=[],s=e.destination,e.destination=void 0,l=s.length,o=0;o<l;o++)t=s[o],i=t.toString(),r.hasOwnProperty(i)||(r[i]=!0,void 0!==t&&a.push(t));l=a.length,e.html.forEach(function(e,t){if("html"===M.templates[t].type){var i=e.splice(l,e.length-l);t===M.currentTemplateLevel&&i.forEach(function(e){n.removeChild(e),e.pvInDom=!1})}})}M.rearrangingItems={},M.rearrangingItemsArr=[]},M.setTransform=function(e,t){void 0!=t&&F(e,j*t.x,j*t.y,t.width/G*j)},M.finishRearrange=function(){M.GridView.isSelected&&!M.GraphView.isSelected||M.GridView.finishRearrange()},M.rearrangePart4=function(){M.GridView.isSelected&&!M.GraphView.isSelected||M.GridView.rearrangePart4()},M.rearrangePart3=function(){(M.GridView.isSelected||M.GraphView.isSelected)&&M.GridView.rearrangePart3()},M.placeGrid=function(e,t,n,i,r,o,a){var s,l,c,u,d,h,m,p,g,f,v,S,D,w,y,b,T=n.length,I=0,_=[],L=[];for(a&&(e-=o),s=0;I<T;s++){for(m=Math.max(r,o)*z/(1+2*z),p=o-2*m,g=r-2*m,l=[],u=0;u<i&&I<T;u++)d=n[I],d.normHeight>p/g?(h=p/d.normHeight,c=new Seadragon2.Rect(t+(u+.5)*r-h/2,e+m,h,p)):(h=g*d.normHeight,c=new Seadragon2.Rect(t+u*r+m,e+.5*o-h/2,g,h)),d.destination.push(c),S={item:d,index:d.destination.length-1},l.push(S),I++,f=l[u-1]||!a&&L[L.length-1],f&&(c.left=f,f.item.destination[f.index].right=S),v=a?_:L,D=a?-1:0,f=v[u+D],f&&(c.up=f,f.item.destination[f.index].down=S),v=a?L:_,D=a?0:1,f=v[u+D],f&&(c.down=f,f.item.destination[f.index].up=S);a&&(f=L[0],f&&(c.right=f,f.item.destination[f.index].left=S)),c.down||(y=S),s||(_=l),L=l,e+=a?-o:o}return b=a?L[0]:_[0],a?(f=_[_.length-1],y=f,w=f):w=L[L.length-1],{topLeft:b,lowest:y,rightmost:w,itemWidth:g}},M.comparators={Number:function(e,t){return e-t},String:function(e,t){return e>t?1:e===t?0:-1},Link:function(e,t){return e=e.content,t=t.content,e>t?1:e===t?0:-1}},M.comparators.DateTime=M.comparators.Number,M.comparators.LongString=M.comparators.String,M.bucketize={String:function(e){function t(e){e=e.content||e,o=l[e],o||(o=l[e]={}),o[i]=n}var n,i,r,o,a,s,l={},c=[];for(s=M.activeItemsArr.length-1;s>=0;s--)n=M.activeItemsArr[s],i=n.id,r=n.facets[e],r?r.forEach(t):t(i18n.t("noInfo"));for(a in l)hasOwnProperty.call(l,a)&&c.push({label:a,items:l[a],values:[a]});var u=M.facets[e].comparator||function(e,t){return e>t?1:e===t?0:-1};c.sort(function(e,t){var n=u(e.label,t.label);return n?n>0&&t.label!==i18n.t("noInfo")||e.label===i18n.t("noInfo")?1:-1:0});var d=Math.ceil(c.length/12);if(d>1){var h,m,p,g=[];c.forEach(function(e,t){if(t%d===0||e.label===i18n.t("noInfo"))p={label:e.label},g.push(p),h=p.values=e.values,m=p.items=e.items;else{h.push(e.values[0]);var n,i=e.items;for(n in i)hasOwnProperty.call(i,n)&&(m[n]=i[n]);t%d!==d-1&&t!==c.length-1&&c[t+1].label!==i18n.t("noInfo")||(p.label+=" to "+e.label)}}),c=g}return c.forEach(function(e){var t,n=[],i=e.items;for(t in i)hasOwnProperty.call(i,t)&&n.push(i[t]);e.items=n}),c},Number:function(e,t){function n(e){e>g&&(g=e),e<f&&(f=e)}var i,r,o,a,s,l,c,u,d,m,p,g=-(1/0),f=1/0,v=[];for(a=M.activeItemsArr.length-1;a>=0;a--)i=M.activeItemsArr[a],r=i.facets[e],r?r.forEach(n):s=!0;if(t)v=PivotDate_generateBuckets(f,g);else for(o=h((g-f)/4),o&&(f=o*Math.floor(f/o)),a=f;a<g||0===o&&!v.length;a+=o)u=a+o,d=PivotNumber_format(a),m=PivotNumber_format(u),v.push({label:d+" to "+m,lowerBound:a,upperBound:u,leftLabel:d,rightLabel:m,items:[]});for(v.length&&(c=v.length-1,v[c].inclusive=!0),s&&(l=[],v.push({label:i18n.t("noInfo"),items:l})),p=t?function(e){var t,n;for(t=0;t<=c;t++)if(n=v[t],e<n.upperBound||t===c){n.items.push(i);break}}:function(e){var t=Math.floor((e-f)/o);(isNaN(t)||t<0)&&(t=0),t>c&&(t=c),v[t].items.push(i)},a=M.activeItemsArr.length-1;a>=0;a--)i=M.activeItemsArr[a],r=i.facets[e],r?r.forEach(p):l.push(i);return v}},M.bucketize.LongString=M.bucketize.String,M.bucketize.Link=M.bucketize.String,M.bucketize.DateTime=function(e){return M.bucketize.Number(e,!0)},M.getAverageItemHeight=function(){var e=M.items.reduce(function(e,t){var n=t.normHeight;return n||(n=t.normHeight=t.sdimg[-1].state.source.normHeight),e+Math.log(n)},1),t=Math.exp(e/M.items.length);return t=t<1?(t+2*z)/(1+2*z):(1+2*z)/(1/t+2*z)},M.computeLayoutWidth=function(e,t,n,i){for(var r=Math.ceil(Math.sqrt(i*t*e/n));Math.ceil(e/r)*t/r*i>n;)r++;return r},M.clearHighlights=function(){var e;e=M.domHoverBorder.parentNode,e&&e.removeChild(M.domHoverBorder),e=M.domSelectedBorder.parentNode,e&&e.removeChild(M.domSelectedBorder)},M.setupFrontLayer=function(e,t){if(M.templates.length){var i,r,o=M.currentTemplateLevel;for(M.currentTemplateLevel=0;M.templates[M.currentTemplateLevel]&&M.templates[M.currentTemplateLevel].width<M.finalItemWidth*e;)M.currentTemplateLevel++;if(M.currentTemplateLevel>M.templates.length-1&&(M.currentTemplateLevel=M.templates.length-1),M.currentTemplateLevel!==o){if(G=M.templates[M.currentTemplateLevel].width,M.clearHighlights(),"html"===M.templates[o].type)for(i in M.currentItems)if(hasOwnProperty.call(M.currentItems,i)){r=M.currentItems[i];var a=r.html[o];a.forEach(function(e,t){e.pvInDom&&(e.pvInDom=!1,W&&(a[t]=M.clone(e)))})}n.innerHTML=""}var s=j;if(j=G/M.finalItemWidth,s!==j&&(N.setSizeRatio(j,!t),"html"===M.templates[M.currentTemplateLevel].type))for(i in M.currentItems)hasOwnProperty.call(M.currentItems,i)&&(r=M.currentItems[i],r.html[M.currentTemplateLevel].forEach(function(e,n){var i=r.source[n];M.setTransform(e,i),M.currentTemplateLevel===o||t&&!M.rectsOverlap(t,i)||(M.addElementToFrontLayer(e),e.pvInDom=!0)}))}},M.rearrangePart1=function(){(M.GridView.isSelected||M.GraphView.isSelected)&&M.GridView.rearrangePart1(),c(),(M.GridView.isSelected||M.GraphView.isSelected)&&M.GridView.rearrangePart1_2(),M.views.filter(function(e){return e.isSelected})[0].createView({canvas:e,container:t,frontLayer:n,backLayer:i,mapLayer:r,tableLayer:o,leftRailWidth:a,rightRailWidth:s,inputElmt:l,items:M.items,activeItems:M.activeItems}),(M.GridView.isSelected||M.GraphView.isSelected)&&M.GridView.rearrangePart1_3(),d()},M.showView=function(){m()},M.rectsOverlap=function(e,t){return void 0!==t&&void 0!==e&&(t.x+t.width>e.x&&e.x+e.width>t.x&&t.y+t.height>e.y&&e.y+e.height>t.y)};var K=function(){var e=0;return function(){var t;do t=(e++).toString();while(hasOwnProperty.call(R,t));return t}}();M.outlineItem=function(e,t,n,i,r,o){var a,s;e?(a=e.source[t],"html"!==M.templates[M.currentTemplateLevel].type?(i.lineWidth=o,i.strokeStyle=n,i.strokeRect(a.x,a.y,a.width,a.height)):(s=e.html[M.currentTemplateLevel][t],s.appendChild(r),o=o*j+"px",r.pvtop.style.height=r.pvright.style.width=r.pvbottom.style.height=r.pvleft.style.width=o)):M.currentTemplateLevel!==-1&&(s=r.parentNode,s&&s.removeChild(r))},M.drawCanvasItem=function(e,t,n,i,r,o){e.save();var a;try{a=o.canvas[M.currentTemplateLevel](e,t,n,i,r,o)}catch(s){}return e.restore(),a},M.zoomToPercent=function(e){C.zoomToPercent(e),C.applyConstraints()},M.moveLeft=function(){b({keyCode:37})},M.moveRight=function(){b({keyCode:39})},M.setCenterItem=function(e){if(!hasOwnProperty.call(R,e))throw"setCenterItem: No matching ID found: "+e;if(!P.isTracking())throw"setCenterItem: Can't execute during rearrange.";if(!hasOwnProperty.call(M.activeItems,e))throw"setCenterItem: Item is currently not filtered in.";var t=R[e];t!==M.selectedItem&&(M.hoveredItem=t,M.hoveredItemIndex=0,v(void 0,0,void 0,!0))},M.collapseDetails=function(){M.detailsEnabled=!1,M.selectedItem&&(M.hoveredItem=M.selectedItem,M.hoveredItemIndex=M.selectedItemIndex,M.selectedItem=void 0,v(void 0,0,void 0,!0)),M.trigger("hideDetails"),M.trigger("showInfoButton")},M.expandDetails=function(){M.detailsEnabled=!0,M.selectedItem&&(M.hoveredItem=M.selectedItem,M.hoveredItemIndex=M.selectedItemIndex,M.selectedItem=void 0,v(void 0,0,void 0,!0)),M.trigger("hideInfoButton"),M.trigger("showDetails",M.centerItem,M.facets),M.trigger("filterItem",M.centerItem,M.facets)},M.sortBy=function(e){M.sortFacet=e,m()},M.filter=function(){m()},M.addFilter=function(e){"function"==typeof e&&O.push(e)},M.removeFilter=function(e){var t=O.indexOf(e);t!==-1&&O.splice(t,1)},M.clearFilters=function(){O=[]},M.setFacets=function(e){if(M.items.length)throw"You must set self.facet categories before adding items.";O=[],M.facets=e;var t,n,i;for(t in M.facets)hasOwnProperty.call(M.facets,t)&&(n=M.facets[t],i=n.orders,i&&i.length&&!function(){var e=i[0].order,t={};e.forEach(function(e,n){t[e]=n}),n.comparator=function(e,n){var i=hasOwnProperty.call(t,e),r=hasOwnProperty.call(t,n);return i?r?t[e]-t[n]:-1:r?1:e===n?0:e>n?1:-1}}());M.trigger("hideDetails"),M.trigger("hideInfoButton"),M.trigger("facetsSet",M.facets)},M.addItems=function(e){function t(){n--,n||(M.items=M.items.concat(i),e.forEach(x),M.filter())}if(!M.items.length&&(M.activeItemsArr.length||M.rearrangingItemsArr.length))return void u(function(){M.addItems(e)});var n=1,i=[];e.forEach(function(e){var r,o=e.sdimg=e.sdimg||[];e.img&&(r=o[-1]=o[-1]||new Seadragon2.Image(q),r.src=e.img,r.update(),r.state||(n++,r.addEventListener("load",t,!1)));var a=e.id;a||"number"==typeof a||(a=e.id=K()),e.name||(e.name=""),e.description||(e.description=""),e.href||(e.href=""),e.facets||(e.facets={}),hasOwnProperty.call(R,a)||(R[a]=e,i.push(e)),M.centerItem===e&&M.zoomedIn&&M.detailsEnabled&&(M.trigger("hideDetails"),M.trigger("showDetails",e,M.facets),M.trigger("filterItem",e,M.facets))}),t()},M.setTemplates=function(e){if(M.items.length||M.activeItemsArr.length||M.rearrangingItemsArr.length)throw"You must set templates before adding items!";M.templates=e.sort(function(e,t){return e.width-t.width}),M.templates[-1]={type:"sdimg"},M.templates.forEach(function(e){"canvas"===e.type&&(e.func=makeTemplate(e)),"html"===e.type&&e.renderer&&(e.type="fakehtml")}),M.currentTemplateLevel=-1},M.clearItems=function(){M.items=[],R={},M.filter()},M.getItemById=function(e){return R[e]},M.setTitle=function(e){M.trigger("titleChange",e)},M.setCopyright=function(e){M.trigger("copyright",e)},M.runFiltersWithout=function(e){M.removeFilter(e);var t=M.items.filter(function(e){return O.every(function(t){return t(e)})});return M.addFilter(e),t},M.runSearch=function(e,t){function n(t){t=t.content||t,"number"==typeof t?t=PivotNumber_format(t):t instanceof Date&&(t=t.toLocaleDateString()+" "+t.toLocaleTimeString());var n=t.toLowerCase().indexOf(e);0===n?k(i,t):n>0&&k(r,t)}var i,r,o;return t?(i={},r={},o={front:i,rest:r}):i=r={},e=e.toLowerCase(),e&&M.items.forEach(function(e){var t,i=e.facets;for(t in i)hasOwnProperty.call(i,t)&&i[t].forEach(n);n(e.name)}),o},_()},PivotCxmlLoader=Pivot.CxmlLoader={load:function(e,t){function n(){Seadragon2.Debug.error("Failed to fetch CXML: "+t)}function i(){function s(e,t,n){if(e.getAttributeNS)return e.getAttributeNS(t,n);var i,r,o=e.attributes,a=o.length;for(r=0;r<a;r++)if(i=o[r],i.namespaceURI===t&&i.baseName===n)return i.value;return null}var l=this.responseXML||Seadragon2.Xml.parse(this.responseText);if(!l)return void Seadragon2.Debug.error("Failed to parse CXML: "+t);var c,u,d,h,m,p,g,f,v,S,D,w,y,b,T,I,_,L,E,x,k,M,P,C,R,A=[];if(c=l.documentElement,R=c.ELEMENT_NODE||1,x=s(c,r,"Supplement"),x&&Seadragon2.Xml.fetch(t.split("/").slice(0,-1).join("/")+"/"+x,i,n),k=c.getAttribute("Name"),k&&e.setTitle(k),u=c.getElementsByTagName("FacetCategories")[0]){for(u=u.childNodes,m=u.length,h=0;h<m;h++)if(d=u[h],d.nodeType===R)for(a[d.getAttribute("Name")]=p={index:h},p.type=d.getAttribute("Type"),p.isFilterVisible="true"===s(d,r,"IsFilterVisible"),p.isMetaDataVisible="true"===s(d,r,"IsMetaDataVisible"),p.isWordWheelVisible="true"===s(d,r,"IsWordWheelVisible"),f=d.childNodes,S=f.length,v=0;v<S;v++)if(b=f[v].firstChild,b&&"SortOrder"===(b.localName||b.baseName)&&b.namespaceURI===r)for(p.orders=p.orders||[],P={name:b.getAttribute("Name")},M=P.order=[],p.orders.push(P),b=b.childNodes,y=b.length,w=0;w<y;w++)k=b[w],"SortValue"===(k.localName||k.baseName)&&k.namespaceURI===r&&M.push(k.getAttribute("Value"));e.setFacets(a)}for(u=c.childNodes,h=u.length-1;h>=0;h--)k=u[h],"Extension"===k.tagName&&(f=k.firstChild,f&&"Copyright"===(f.localName||f.baseName)&&f.namespaceURI===r&&e.setCopyright({href:t.split("/").slice(0,-1).join("/")+"/"+f.getAttribute("Href"),name:f.getAttribute("Name")}));if(u=c.getElementsByTagName("Items")[0]){for(k=u.getAttribute("ImgBase"),k&&(o=t.slice(0,t.lastIndexOf("/")+1)+k.replace("\\","/")),u=u.childNodes,m=u.length,h=0;h<m;h++)if(d=u[h],d.nodeType===R&&(E=d.getAttribute("Id"),g=e.getItemById(E),g?C=!0:(g={},g.id=E,g.facets={}),A.push(g),k=d.getAttribute("Href"),k&&(g.href=k),k=d.getAttribute("Name"),k&&(g.name=k),k=d.getAttribute("Img"),k&&(g.img=o+k),L=d.getElementsByTagName("Description"),L.length&&(g.description=L[0].textContent||L[0].text),f=d.getElementsByTagName("Facets")[0]))for(f=f.childNodes,S=f.length,v=0;v<S;v++)if(d=f[v],d.nodeType===R)for(D=d.getAttribute("Name"),p=a[D],g.facets[D]=_=[],b=d.childNodes,y=b.length,w=0;w<y;w++)if(d=b[w],d.nodeType===R){switch(p.type){case"String":case"LongString":T=I=d.getAttribute("Value").trim();break;case"Link":T=d.getAttribute("Name").trim(),I={content:T,href:d.getAttribute("Href")};break;case"Number":T=d.getAttribute("Value"),I=parseFloat(T);break;case"DateTime":T=d.getAttribute("Value"),I=new Date(T);break;default:Seadragon2.Debug.warn("Unknown facet type "+p.type),T=I=d.getAttribute("Value")}_.push(I)}A.length&&e.addItems(A)}}var r="http://schemas.microsoft.com/livelabs/pivot/collection/2009";e.setTitle(t);var o,a={};Seadragon2.Xml.fetch(t,i,n)}},Pivot_init=Pivot.init=function(e,t){function n(){j.style.height="80px",Z.innerHTML="more",Z.onclick=Y}function i(e,t,n){var i,r,o=Se[e];if(t&&t.length>0)if(o)o.values=t;else{switch(n){case"String":case"LongString":case"Link":r=function(t){return o.values.some(function(n){var i=t.facets[e];return i?i.some(function(e){return e=e.content||e,n===e}):"(no info)"===n})};break;case"DateTime":case"Number":r=function(t){return o.values.some(function(n){var i=t.facets[e];return i?i.some(function(e){return e>=n.lowerBound&&(n.inclusive?e<=n.upperBound:e<n.upperBound)}):void 0===n.lowerBound})};break;default:return void Seadragon2.Debug.warn(i8n.t("unrecognizedFacet1")+n)}o=Se[e]={filter:r,values:t},V.addFilter(o.filter),De++,i=ye[e],i&&(i.style.visibility="visible"),1===De&&(we.style.visibility="visible")}else o&&(delete Se[e],V.removeFilter(o.filter),De--),i=ye[e],i&&(i.style.visibility=""),De||se||(we.style.visibility="")}function r(e){var t,n=Se[fe],r=fe;e.target.checked?n?n.values.push(e.target.name):i(r,[e.target.name],ve):(t=n.values.indexOf(e.target.name),t!==-1&&n.values.splice(t,1),n.values.length||i(fe)),V.filter()}function o(e){var t=Se[fe],n=e.target.parentNode.previousSibling;n.checked=!0;var i,o,a,s=n.name;if(t){for(a=pe.lastChild.childNodes,o=a.length,i=0;i<o;i++)n=a[i].firstChild,n.name!==s&&(n.checked=!1);t.values=[s],V.filter()}else r({target:n})}function a(e,t,n,r){i(e,[{lowerBound:t,upperBound:n,inclusive:r}],"Number"),V.filter()}function s(e){i(e),V.filter()}function l(e,t){i(e,t,"DateTime"),V.filter()}function c(e,t){return t.count-e.count}function u(e,t){return e=e.value,t=t.value,e===t?0:"(no info)"===e?1:"(no info)"===t?-1:e>t?1:-1}function d(){ge.currentComparator=(ge.currentComparator+1)%ge.comparators.length,m()}function h(e){pe&&(pe.style.height="0px",pe.style.overflow="hidden");var t=e.target;t.name||(t=t.parentNode),ge=t,fe=t.name,ve=t.facetType;var n=t.nextSibling;n.innerHTML="";var i,c,u,h,m,p,g,f,v,S,D=Se[fe]||{},w=V.runFiltersWithout(D.filter);switch(ve){case"Link":case"String":case"LongString":i={},S=function(e){e=e.content||e,i[e]||(i[e]=0),i[e]++},w.forEach(function(e){e.facets[fe]?e.facets[fe].forEach(S):S("(no info)")}),u=[];for(c in i)hasOwnProperty.call(i,c)&&u.push({value:c,count:i[c]});u.sort(t.comparators[t.currentComparator]);var y=makeElement("div","pivot_sortlabel",n);addText(y,t.comparatorNames[t.currentComparator]),y.onclick=d;var b=makeElement("ul","pivot",n);f=D.values||[],u.forEach(function(e){h=makeElement("li",null,b),m=makeElement("input","pivot pivot_facetcheckbox",h),m.setAttribute("type","checkbox"),m.name=e.value,f.indexOf(e.value)!==-1&&(m.checked=!0),m.onclick=r,v=makeElement("div","pivot_outerlabel",h),v.onclick=o,g=makeElement("div","pivot_facetcount",v),addText(g,e.count),p=makeElement("div","pivot_facetlabel",v),addText(p,e.value),h.title=e.value});break;case"Number":var T=new PivotNumberPicker(n,w,fe,D.values);T.addListener("filter",a),T.addListener("unfilter",s);break;case"DateTime":var I=new PivotDatePicker(n,w,fe,D.values);I.addListener("filter",l);break;default:Seadragon2.Debug.warn(i18n.t("unrecognizedFacet1")+ve)}n.style.height=Math.max(150,parseFloat(Seadragon2.Element.getStyle(B).height)+me)+"px",n.style.overflowY="auto",pe=n}function m(){pe&&h({target:pe.previousSibling})}function p(e){i(e.target.parentNode.name),V.filter(),m(),e.stopPropagation()}function g(e){var t=e.facets,n=se.trim().toLowerCase().split(" ");return n.every(function(n){return e.name.toLowerCase().indexOf(n)!==-1||be.some(function(e){var i=t[e];return i&&i.some(function(e){return e=e.content||e,"number"==typeof e&&(e=PivotNumber_format(e)),e instanceof Date&&(e=e.toLocaleDateString()+" "+e.toLocaleTimeString()),e.toLowerCase().indexOf(n)!==-1})})})}function f(){se?(ae.value=se,ce.className="pivot_searchbtn pivot_clrsearch",ce.onmousedown=v):(oe.className="pivot_watermark",ae.value=i18n.t("search"),ce.onmousedown=null),le.innerHTML="",de=-1,ue=0}function v(e){ce.className="pivot_searchbtn",se=null,De||(we.style.visibility=""),f(),V.removeFilter(g),e!==!0&&(V.filter(),m())}function S(e){V.clearFilters();var t;for(t in ye)hasOwnProperty.call(ye,t)&&(ye[t].style.visibility="");se&&v(!0),we.style.visibility="",Se={},De=0,e!==!0&&(V.filter(),m()),V.views.filter(function(e){return e.isSelected})[0].clearFilter(),V.trigger("clearFilter")}function D(){var e=!!se;se=ae.value,e||V.addFilter(g),we.style.visibility="visible",f(),V.filter(),m()}function w(e){var t,n=[];for(t in e)hasOwnProperty.call(e,t)&&n.push({value:t,count:e[t]});n.sort(function(e,t){return t.count-e.count}),n.every(function(e){if(ue>=10)return!1;var t=makeElement("li",null,le);return addText(t,e.value),t.onmousedown=function(){ae.value=e.value,D()},ue++,!0})}function y(e){var t=le.childNodes[de];t&&(t.className=""),de=e,de>=ue?de=-1:de<-1&&(de=ue-1),de===-1?ae.value=he:(t=le.childNodes[de],t.className="pivot_highlight",ae.value=t.firstChild.textContent)}function b(e){switch(e.keyCode){case 38:y(de-1);break;case 40:y(de+1);break;case 13:L.focus();break;default:he=ae.value;var t=V.runSearch(he,!0);le.innerHTML="",de=-1,ue=0,w(t.front),w(t.rest)}}function T(){se?(ce.className="pivot_searchbtn",b({})):(oe.className="",ae.value=""),ce.onmousedown=D}function I(){var e,t={};for(e in Se)if(hasOwnProperty.call(Se,e)){var n,i,r=Se[e].values,o=[],a=r.length;for(i=0;i<a;++i){var s=r[i];if("string"==typeof s)o.push(s),n="String";else{var l=s.lowerBound,c=s.upperBound;"number"!=typeof l&&"number"!=typeof c?(l=l.getTime(),c=c.getTime(),n="DateTime"):n="Number",o.push({lowerBound:l,upperBound:c,inclusive:s.inclusive})}}t[e]={values:o,dataType:n}}return JSON.stringify({filters:t,search:se,sortBy:ie.value,view:gridButton.className.indexOf("pivot_activesort")!==-1?"grid":"graph"})}function _(e){e=JSON.parse(e);var t,n=e.filters,r=e.search,o=e.sortBy;for(t in n)if(hasOwnProperty.call(n,t)){var a=n[t],s=a.dataType,l=a.values;"DateTime"===s&&l.forEach(function(e){e.lowerBound=new Date(e.lowerBound),e.upperBound=new Date(e.upperBound)}),"Number"===s&&l.forEach(function(e){null===e.lowerBound&&(e.lowerBound=-(1/0)),null===e.upperBound&&(e.upperBound=1/0)}),i(t,l,s)}r&&(ae.value=r,D()),o&&(ie.value=o,V.sortBy(o)),"graph"===e.view&&graphButton.onclick(),m()}for(;e.firstChild;)e.removeChild(e.firstChild);if(!makeElement("canvas").getContext)return void addText(e,"Your browser doesn't support canvas! Get a better one.");var L=makeElement("input","pivot_input",e);L.setAttribute("type","checkbox");var E=makeElement("div","pivot pivot_viewbox",e),x=makeElement("div","pivot pivot_topbar",E),k=makeElement("div","pivot pivot_title",x),M=makeElement("div","pivot pivot_canvas",E),P=makeElement("div","pivot pivot_layer",M),C=makeElement("div","pivot pivot_layer behindLayer",P),R=makeElement("canvas","pivot",P),A=makeElement("div","pivot pivot_layer frontLayer ",P),O=makeElement("div","pivot pivot_layer mapLayer",P),N=makeElement("div","pivot pivot_layer tableLayer",P),B=makeElement("div","pivot pivot_pane pivot_filterpane",M),z=B.offsetLeft+B.offsetWidth,V=new PivotViewer(R,P,A,C,O,N,z,z,L),F=makeElement("div","pivot pivot_pane pivot_detailspane",M);F.style.opacity=0,F.style.display="none";var H=makeElement("div","pivot_hoverable pivot_left pivot_larr",F);H.onclick=function(){V.moveLeft()},H=makeElement("div","pivot_left pivot_subtle pivot_vertbar",F),addText(H,"|"),H=makeElement("div","pivot_hoverable pivot_left pivot_rarr",F),H.onclick=function(){V.moveRight()},H=makeElement("div","pivot_hoverable pivot_right pivot_collapse",F),H.onclick=function(){V.collapseDetails()};var U=makeElement("h2","pivot",F);U=makeElement("a","pivot",U),U.setAttribute("target","_blank");var G=makeElement("div","pivot pivot_scrollable",F),j=makeElement("div","pivot pivot_description",G),Z=makeElement("div","pivot_sortlabel",G),q=makeElement("dl","pivot",G);makeElement("div","pivot_horizbar",F);var W,X=makeElement("div","pivot_copyright",F),$=makeElement("div","pivot_info",M);$.style.display="none",$.onclick=function(){V.expandDetails()};var Y,J=!1;Y=function(){j.style.height="auto",Z.innerHTML="less",Z.onclick=n};var K,Q;V.addListener("showDetails",function(e,t){if(W||(F.style.display="",setTimeout(function(){F.style.opacity=1},0),B.className+=" pivot_faded",void 0!==Q&&(clearTimeout(Q),Q=void 0)),e!==W){U.innerHTML="",addText(U,e.name||"???");var r=e.href;r&&U.setAttribute("href",r),G.style.height=parseFloat(Seadragon2.Element.getStyle(F).height)-G.offsetTop-25+"px",j.innerHTML="",e.description&&addText(j,e.description),j.style.height="auto",j.offsetHeight>80?(n(),Z.style.display="block"):Z.style.display="none",q.innerHTML="";var o,a,s,l,c,u,d,h,p,g,f,v=e.facets,D=[];for(o in v)f=t[o],hasOwnProperty.call(v,o)&&f&&f.isMetaDataVisible&&D.push(o);D.sort(function(e,n){return(t[e].index||0)-(t[n].index||0)});var w,y=D.length;for(w=0;w<y;++w)for(o=D[w],f=t[o],s=makeElement("dt","pivot",q),addText(s,o),a=v[o],a=v[o],d=a.length,l=makeElement("dd","pivot",q),u=0;u<d;u++){switch(c=makeElement("div",void 0,l),h=void 0,p=a[u],f.type){case"String":case"LongString":addText(c,p),h=p;break;case"Link":g=makeElement("a",void 0,c),g.target="_blank",g.href=p.href,addText(g,p.content);break;case"Number":addText(c,PivotNumber_format(p)),h={upperBound:p,lowerBound:p,inclusive:!0};break;case"DateTime":addText(c,p.toLocaleDateString()+" "+p.toLocaleTimeString()),h={lowerBound:p,upperBound:new Date(p.getTime()+1e3)};break;default:Seadragon2.Debug.warn(i18n.t("unrecognizedFacet")+f.type)}void 0!==h&&f.isFilterVisible&&(c.className+=" pivot_filterable",function(){var e=o,t=[h],n=f.type;c.onclick=function(){S(!0),i(e,t,n),m(),V.filter()}}())}W=e}}),V.addListener("hideDetails",function(){W&&(F.style.opacity=0,Q=setTimeout(function(){F.style.display="none",Q=void 0},500),W=null,B.className=B.className.replace(" pivot_faded",""))}),V.addListener("showInfoButton",function(){J||($.style.display="",setTimeout(function(){$.style.opacity=1},0),B.className+=" pivot_faded",J=!0,void 0!==K&&(clearTimeout(K),K=void 0))}),V.addListener("hideInfoButton",function(){J&&($.style.opacity=0,K=setTimeout(function(){$.style.display="none",K=void 0},500),J=!1,B.className=B.className.replace(" pivot_faded",""))});var ee=makeElement("div","pivot pivot_sorttools pivot_zoomslider",x);ee=new PivotSlider(ee,0,100,0,i18n.t("zoomOut"),i18n.t("zoomIn"));var te=new Button("div","pivot_sorttools pivot_export_csv pivot_hoverable",x,i18n.t("exportCSV"));te.htmlElement.onclick=function(){new CSVExporter(".",",","\n",'"',"ru-RU","utf-8")["export"](V.activeItemsArr.map(function(e){return deleteAdditionalProperties(e)}))};var ne=new Button("div","pivot_sorttools pivot_clear_filter pivot_hoverable",x,i18n.t("clearFilters"));ne.htmlElement.onclick=S,V.views.forEach(function(e,t,n){e.onSelected=function(){n.forEach(function(t,n,i){t!=e&&(t.button.deselect(),t.deselect())}),V.showView()}}),V.views.filter(function(e){return e.isSelected}).forEach(function(e){e.select()});var ie=makeElement("select","pivot pivot_sorttools",x);ie.onchange=function(){V.sortBy(ie.value)};var re=makeElement("div","pivot_sorttools pivot_subtle",x);addText(re,i18n.t("sort")),V.addListener("zoom",function(e){ee.setValue(e)}),ee.addListener("change",function(e){V.zoomToPercent(e)}),V.addListener("titleChange",function(e){k.innerHTML="",addText(k,e)}),V.addListener("copyright",function(e){X.innerHTML="";var t=makeElement("a",void 0,X);t.href=e.href,t.target="_blank",addText(t,e.name)});var oe,ae,se,le,ce,ue,de,he,me,pe,ge,fe,ve,Se,De,we,ye,be;return V.addListener("resize",m),V.addListener("filterrequest",function(e){var t=e.type,n=e.values;i(e.facet,n,t),"String"!==t&&"Link"!==t&&"LongString"!==t||1!==n.length?V.filter():(V.views[0].select(),V.views.forEach(function(e,t,n){0!==t&&(e.deselect(),e.button.deselect())}),V.showView()),m()}),V.addListener("facetsSet",function(e){var n,i;be=[],ie.innerHTML="";for(n in e)hasOwnProperty.call(e,n)&&(e[n].isFilterVisible&&(i=makeElement("option",null,ie),i.value=n,addText(i,n)),e[n].isWordWheelVisible&&be.push(n));V.sortBy(ie.value),Se={},De=0,de=-1,ue=0,se=null,he=null,pe=null,fe="",ve=null,B.innerHTML="",me=-10;var r,o,a,s,l;we=makeElement("div","pivot_clrlabel pivot_clr",B),we.onclick=S,ye={},l=makeElement("div","pivot_clrbtn pivot_clr",we),l.innerHTML="&times;",addText(we,i18n.t("clearAll")),oe=makeElement("form",null,B),oe.onsubmit=function(e){D(),e.preventDefault()},ae=makeElement("input","pivot_searchbox",oe),ae.type="text",ae.onfocus=T,ae.onblur=f,ae.onkeyup=b,ce=makeElement("span","pivot_searchbtn",oe),ce.innerHTML="&times;",le=makeElement("ul","pivot pivot_results",oe),f(),me-=oe.offsetHeight+we.offsetHeight;var d=[];for(n in e)hasOwnProperty.call(e,n)&&e[n].isFilterVisible&&d.push(n);d.sort(function(t,n){return(e[t].index||0)-(e[n].index||0)});var m,g=d.length;for(m=0;m<g;++m){if(n=d[m],a=e[n],r=makeElement("div","pivot pivot_facetname",B),r.onclick=h,r.name=n,r.facetType=a.type,"String"===a.type||"LongString"===a.type||"Link"===a.type){var v=r.comparatorNames=[],w=r.comparators=[];r.currentComparator=0,a.orders&&a.orders.length&&a.comparator&&(!function(){var e=a.comparator;w.push(function(t,n){return e(t.value,n.value)})}(),v.push(i18n.t("sort1")+a.orders[0].name)),v.push(i18n.t("sortAZ")),w.push(u),v.push(i18n.t("sortQuantity")),w.push(c)}l=ye[n]=l.cloneNode(!0),l.onclick=p,r.appendChild(l),s=makeElement("div","pivot_facetlabel",r),addText(s,n),me-=r.offsetHeight,o=makeElement("div","pivot pivot_facetvalues",B),o.style.height=0,o.style.overflow="hidden"}if(t){var y=location.hash;if(y&&y.length>2)try{_(decodeURIComponent(y.substr(1)))}catch(I){Seadragon2.Debug.warn("bad URL hash")}}}),
e.addEventListener("click",function(e){var t=e.target;t!==ae&&t!==ie&&L.focus()}),t&&V.addListener("finishedRearrange",function(){location.hash="#"+encodeURIComponent(I())}),V};Seadragon2.ImageManager.disable(),addEventListener("load",function(){var e,t,n,i,r,o=document.getElementsByClassName("pivot_ajax_viewer");for(t=o.length,e=0;e<t;e++){n=o[e],i=n.getAttribute("data-collection");var a=n.getAttribute("data-use-hash");a=a&&"false"!==a.toLowerCase(),r=Pivot_init(n,a),n.pivotViewer=r,i&&PivotCxmlLoader.load(r,i)}},!1);